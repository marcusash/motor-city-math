<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor City Math — Unit Test</title>
    <link rel="stylesheet" href="shared/styles.css">
    <link rel="stylesheet" href="shared/print.css">
    <link rel="stylesheet" href="shared/katex/katex.min.css">
    <script src="shared/katex/katex.min.js"></script>
    <script src="shared/chart.min.js"></script>
    <script>if(typeof Chart==='undefined'){document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>')}</script>
    <script src="shared/chart-theme.js"></script>
    <style>
        .tag { display: inline-block; font-size: 0.75rem; padding: 2px 8px; border-radius: 12px;
               margin-right: 6px; font-weight: 600; }
        .tag-unit { background: var(--accent-blue); color: #fff; }
        .tag-standard { background: var(--accent-navy); color: #fff; }
        .tag-difficulty { background: var(--accent-red); color: #fff; }
        .tag-difficulty.easy { background: var(--color-correct); }
        .tag-difficulty.medium { background: var(--color-warning); color: #222; }
        .self-graded-note { font-size: 0.8rem; color: var(--text-secondary); font-style: italic;
                            margin-top: 4px; }
        .solution-steps { margin-top: 8px; padding: 10px 14px; background: var(--bg-card, #fafafa);
                          border-left: 3px solid var(--accent-blue); border-radius: 4px;
                          font-size: 0.9rem; display: none; }
        .solution-steps.show { display: block; }
        .solution-steps ol { margin: 4px 0 0 18px; padding: 0; }
        .nav-links { text-align: center; margin: 24px 0; }
        .nav-links a { margin: 0 12px; color: var(--accent-blue); font-weight: 600;
                        text-decoration: none; }
        .nav-links a:hover { text-decoration: underline; }
        .loading-msg { text-align: center; padding: 60px 20px; color: var(--text-secondary);
                       font-size: 1.1rem; }
        .error-msg { text-align: center; padding: 40px 20px; color: var(--color-incorrect);
                     font-weight: 600; }
    </style>
</head>
<body>
    <a href="#main" class="sr-only">Skip to content</a>
    <div class="container" role="main" id="main">
        <div class="print-header" id="printHeader">
            <strong id="printTitle">Motor City Math — Unit Test</strong><br>
            Name: _____________________ Date: ___________
        </div>
        <header id="testHeader">
            <h1 id="testTitle">Motor City Math — Unit Test</h1>
            <div class="subtitle" id="testSubtitle">Loading…</div>
        </header>

        <form id="testForm" style="display:none;">
            <div id="questionContainer"></div>

            <button type="button" class="submit-btn" id="submitBtn" onclick="gradeAllQuestions()">
                Submit Test
            </button>
            <button type="button" class="print-btn" onclick="printTest()">
                Print Version (Black &amp; White)
            </button>
            <button type="button" class="answer-key-btn" id="answerKeyBtn" onclick="revealAnswerKey()">
                View Answer Key
            </button>
        </form>

        <div class="result" id="finalResult"></div>

        <div class="nav-links">
            <a href="index.html">← Back to Dashboard</a>
            <a href="practice.html">← Back to Practice</a>
        </div>
    </div>

    <!-- Answer Key Modal -->
    <div id="answerKeyModal" class="answer-key-modal">
        <div class="answer-key-content">
            <button class="close-modal" onclick="closeAnswerKey()">×</button>
            <h2 class="answer-key-title">Answer Key</h2>
            <div id="answerKeyBody"></div>
        </div>
    </div>

    <script src="shared/scripts.js"></script>
    <script>
    /* ============================================================
       Motor City Math — Dynamic Test Renderer
       Reads URL params, fetches data/questions.json, renders a
       fully interactive auto-graded test.
       ============================================================ */
    (function() {
        'use strict';

        /* --- Standard name registry --- */
        var STANDARD_NAMES = {
            '1.a': 'Simplify', '1.b': 'Scientific Notation', '1.c': 'Radicals',
            '1.d': 'Complex Numbers', '2.a': 'Factoring', '2.b': 'Quadratics',
            '3.a': 'Functions', '3.b': 'Transformations',
            '4.a': 'Exponential Growth', '4.b': 'Exponential Decay',
            '5.a': 'Linear Models',
            'W2.b': 'Quadratic Equations', 'W2.c': 'Quadratic Graphs',
            'W2.e': 'Polynomial Operations',
            'W3.a': 'Exponential Equations', 'W3.b': 'Exponential Models',
            'W3.c': 'Logarithms', 'W3.d': 'Geometric Sequences'
        };

        /* --- Parse URL parameters --- */
        var params = new URLSearchParams(window.location.search);
        var UNIT      = params.get('unit') || '';
        var STANDARD  = params.get('standard') || '';
        var DIFFICULTY = params.get('difficulty') || '';
        var COUNT     = parseInt(params.get('count')) || 15;
        var SEED      = params.get('seed') ? parseInt(params.get('seed')) : null;
        var TITLE     = params.get('title') || 'Motor City Math — Unit Test';
        var TIME      = parseInt(params.get('time')) || 0;

        /* --- Active questions (populated after load) --- */
        var activeQuestions = [];

        /* --- Set header --- */
        document.getElementById('testTitle').textContent = TITLE;
        document.getElementById('printTitle').textContent = TITLE;
        document.title = TITLE;

        if (TIME > 0) {
            document.getElementById('testHeader').setAttribute('data-time-minutes', TIME);
        }

        /* --- Build subtitle from params --- */
        function buildSubtitle() {
            var parts = [];
            if (UNIT) parts.push('Unit: ' + UNIT);
            if (STANDARD) parts.push('Standard: ' + STANDARD);
            if (DIFFICULTY) parts.push('Difficulty: ' + DIFFICULTY);
            parts.push(COUNT + ' questions');
            if (SEED !== null) parts.push('Seed: ' + SEED);
            var date = new Date().toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric'
            });
            parts.push(date);
            return parts.join(' · ');
        }

        /* --- Seeded shuffle (deterministic) --- */
        function seededShuffle(arr, seed) {
            var m = arr.length, t, i;
            while (m) {
                seed = (seed * 9301 + 49297) % 233280;
                i = Math.floor((seed / 233280) * m--);
                t = arr[m]; arr[m] = arr[i]; arr[i] = t;
            }
            return arr;
        }

        /* --- Random shuffle (Fisher-Yates) --- */
        function randomShuffle(arr) {
            for (var i = arr.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var t = arr[i]; arr[i] = arr[j]; arr[j] = t;
            }
            return arr;
        }

        /* --- Filter questions --- */
        function filterQuestions(questions) {
            return questions.filter(function(q) {
                if (UNIT && q.unit !== UNIT) return false;
                if (STANDARD && q.standard !== STANDARD) return false;
                if (DIFFICULTY && q.difficulty !== DIFFICULTY) return false;
                return true;
            });
        }

        /* --- Determine if a sub_part is auto-gradable --- */
        function isAutoGraded(part) {
            var t = (part.answer_type || '').toLowerCase();
            return t === 'numeric' || t === 'exact';
        }

        /* --- Storage key --- */
        function getStorageKey() {
            var ts = Date.now();
            if (UNIT) return 'mcm-test-' + UNIT + '-' + ts;
            return 'mcm-test-custom-' + ts;
        }

        /* --- Render a single question card --- */
        function renderQuestion(q, idx) {
            var card = document.createElement('div');
            card.className = 'question-card';

            // Question number + tags
            var header = document.createElement('div');
            header.className = 'question-number';
            header.innerHTML = 'Question ' + (idx + 1) +
                ' <span class="tag tag-unit">' + esc(q.unit) + '</span>' +
                ' <span class="tag tag-standard">' + esc(q.standard) + '</span>' +
                ' <span class="tag tag-difficulty ' + esc(q.difficulty) + '">' +
                esc(q.difficulty) + '</span>';
            card.appendChild(header);

            // Question text
            if (q.question_text) {
                var text = document.createElement('div');
                text.className = 'question-text';
                text.textContent = q.question_text;
                card.appendChild(text);
            }

            // Sub-parts
            var box = document.createElement('div');
            box.className = 'final-answer-box';

            (q.sub_parts || []).forEach(function(part, pIdx) {
                var sub = document.createElement('div');
                sub.className = 'sub-question';
                sub.style.marginLeft = '20px';
                sub.style.marginBottom = '16px';

                var label = document.createElement('div');
                label.className = 'question-text';
                label.innerHTML = '<strong>' + esc(part.label) + ')</strong> ' + esc(part.text || '');
                sub.appendChild(label);

                var inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';

                var inputLabel = document.createElement('label');
                inputLabel.setAttribute('for', 'ans_' + idx + '_' + pIdx);

                var aType = (part.answer_type || 'text').toLowerCase();
                if (aType === 'explanation' || (aType === 'text' && !part.answer)) {
                    inputLabel.textContent = 'Your explanation:';
                    inputGroup.appendChild(inputLabel);
                    var ta = document.createElement('textarea');
                    ta.id = 'ans_' + idx + '_' + pIdx;
                    ta.placeholder = 'Explain your reasoning…';
                    ta.style.minHeight = '60px';
                    inputGroup.appendChild(ta);
                    var note = document.createElement('div');
                    note.className = 'self-graded-note';
                    note.textContent = '(Self-graded — review with answer key)';
                    inputGroup.appendChild(note);
                } else {
                    inputLabel.textContent = 'Answer:';
                    inputGroup.appendChild(inputLabel);
                    var inp = document.createElement('input');
                    inp.type = 'text';
                    inp.id = 'ans_' + idx + '_' + pIdx;
                    inp.autocomplete = 'off';
                    inputGroup.appendChild(inp);
                }

                sub.appendChild(inputGroup);
                box.appendChild(sub);
            });

            card.appendChild(box);

            // Feedback div
            var fb = document.createElement('div');
            fb.className = 'answer-feedback';
            fb.id = 'feedback_' + idx;
            card.appendChild(fb);

            // Solution steps (hidden until reveal)
            if (q.solution_steps && q.solution_steps.length) {
                var sol = document.createElement('div');
                sol.className = 'solution-steps';
                sol.id = 'solution_' + idx;
                sol.innerHTML = '<strong>Solution:</strong><ol>' +
                    q.solution_steps.map(function(s) { return '<li>' + esc(s) + '</li>'; }).join('') +
                    '</ol>';
                card.appendChild(sol);
            }

            return card;
        }

        /* --- HTML-escape helper --- */
        function esc(str) {
            if (!str) return '';
            var d = document.createElement('div');
            d.textContent = String(str);
            return d.innerHTML;
        }

        /* --- Build gradeTest config from active questions --- */
        function buildGradeConfig() {
            var questions = [];
            var feedbacks = [];
            var standards = [];

            activeQuestions.forEach(function(q, idx) {
                var parts = [];
                var fb = [];

                (q.sub_parts || []).forEach(function(part, pIdx) {
                    var aType = (part.answer_type || 'text').toLowerCase();
                    if (!isAutoGraded(part)) return;

                    var elId = 'ans_' + idx + '_' + pIdx;
                    var answer = part.answer;
                    var tolerance = 0.5;

                    if (aType === 'numeric') {
                        answer = parseFloat(answer);
                        if (isNaN(answer)) return;
                    }

                    parts.push([elId, answer, tolerance]);

                    var shortLabel = part.label ? '(' + part.label + ') ' : '';
                    fb.push('✓ ' + shortLabel + 'Correct — ' + esc(String(part.answer)));
                    fb.push('✗ ' + shortLabel + 'Expected: ' + esc(String(part.answer)));
                });

                if (parts.length > 0) {
                    questions.push([parts, 'feedback_' + idx]);
                    feedbacks.push(fb);
                    var stdName = STANDARD_NAMES[q.standard] || q.standard || 'General';
                    standards.push({ id: q.standard || 'gen', name: stdName });
                }
            });

            return {
                questions: questions,
                feedbacks: feedbacks,
                standards: standards,
                storageKey: getStorageKey()
            };
        }

        /* --- Expose gradeAllQuestions globally --- */
        window.gradeAllQuestions = function() {
            var config = buildGradeConfig();
            var result = gradeTest(config);

            // Show solution steps for incorrect questions
            activeQuestions.forEach(function(q, idx) {
                var fb = document.getElementById('feedback_' + idx);
                if (fb && fb.classList.contains('incorrect')) {
                    var sol = document.getElementById('solution_' + idx);
                    if (sol) sol.classList.add('show');
                }
            });

            // Green/red borders on individual inputs
            activeQuestions.forEach(function(q, idx) {
                (q.sub_parts || []).forEach(function(part, pIdx) {
                    if (!isAutoGraded(part)) return;
                    var el = document.getElementById('ans_' + idx + '_' + pIdx);
                    if (!el) return;

                    var answer = part.answer;
                    var aType = (part.answer_type || '').toLowerCase();
                    if (aType === 'numeric') answer = parseFloat(answer);

                    var correct = checkAnswer(el.value, answer, 0.5);
                    el.classList.remove('correct', 'incorrect');
                    el.classList.add(correct ? 'correct' : 'incorrect');
                });
            });

            // SRS integration
            if (typeof MCM_SRS !== 'undefined' && MCM_SRS.recordAnswer) {
                activeQuestions.forEach(function(q, idx) {
                    var anyWrong = false;
                    (q.sub_parts || []).forEach(function(part, pIdx) {
                        if (!isAutoGraded(part)) return;
                        var el = document.getElementById('ans_' + idx + '_' + pIdx);
                        if (!el) return;
                        var answer = part.answer;
                        if ((part.answer_type || '').toLowerCase() === 'numeric')
                            answer = parseFloat(answer);
                        if (!checkAnswer(el.value, answer, 0.5)) anyWrong = true;
                    });
                    if (q.id) MCM_SRS.recordAnswer(q.id, !anyWrong);
                });
            }

            // Store standard breakdown
            if (result.standardScores) {
                try {
                    var existing = JSON.parse(localStorage.getItem('standardScores') || '{}');
                    Object.keys(result.standardScores).forEach(function(id) {
                        existing[id] = result.standardScores[id];
                    });
                    localStorage.setItem('standardScores', JSON.stringify(existing));
                } catch (e) { /* ignore */ }
            }

            // Disable submit after grading
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = 'Submitted ✓';
        };

        /* --- Answer key modal --- */
        window.revealAnswerKey = function() {
            var html = '';
            activeQuestions.forEach(function(q, idx) {
                html += '<div class="answer-item">';
                html += '<strong>Question ' + (idx + 1) + '</strong>';
                if (q.unit) html += ' <em>(' + esc(q.unit) + ' · ' + esc(q.standard) + ')</em>';
                html += '<br>';
                (q.sub_parts || []).forEach(function(part) {
                    html += '<br><strong>' + esc(part.label) + ')</strong> ';
                    html += esc(String(part.answer || '(self-graded)'));
                });
                if (q.hint) {
                    html += '<br><br><em>Hint: ' + esc(q.hint) + '</em>';
                }
                if (q.solution_steps && q.solution_steps.length) {
                    html += '<br><strong>Steps:</strong><ol>';
                    q.solution_steps.forEach(function(s) {
                        html += '<li>' + esc(s) + '</li>';
                    });
                    html += '</ol>';
                }
                html += '</div>';
            });
            showAnswerKey(html);
        };

        /* --- Load questions --- */
        function loadQuestions(callback) {
            // Try fetch first, fall back to XHR for file:// protocol
            if (typeof fetch === 'function' && window.location.protocol !== 'file:') {
                fetch('data/questions.json')
                    .then(function(r) {
                        if (!r.ok) throw new Error('HTTP ' + r.status);
                        return r.json();
                    })
                    .then(callback)
                    .catch(function(err) { loadViaXHR(callback, err); });
            } else {
                loadViaXHR(callback, null);
            }
        }

        function loadViaXHR(callback, priorErr) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'data/questions.json', true);
            xhr.onload = function() {
                if (xhr.status === 200 || xhr.status === 0) {
                    try {
                        callback(JSON.parse(xhr.responseText));
                    } catch (e) {
                        showError('Failed to parse questions.json: ' + e.message);
                    }
                } else {
                    showError('Failed to load questions.json (HTTP ' + xhr.status + ')');
                }
            };
            xhr.onerror = function() {
                showError('Could not load questions.json.' +
                    (priorErr ? ' Fetch error: ' + priorErr.message : ''));
            };
            xhr.send();
        }

        function showError(msg) {
            var el = document.createElement('div');
            el.className = 'error-msg';
            el.textContent = msg;
            document.getElementById('questionContainer').appendChild(el);
        }

        /* --- Init --- */
        function init(data) {
            var questions = data.questions || data;
            var filtered = filterQuestions(questions);

            if (filtered.length === 0) {
                showError('No questions match the selected filters. Try different parameters.');
                document.getElementById('testSubtitle').textContent = buildSubtitle();
                return;
            }

            // Shuffle
            if (SEED !== null) {
                filtered = seededShuffle(filtered.slice(), SEED);
            } else {
                filtered = randomShuffle(filtered.slice());
            }

            // Take count
            activeQuestions = filtered.slice(0, COUNT);

            // Update subtitle
            document.getElementById('testSubtitle').textContent = buildSubtitle();

            // Render questions
            var container = document.getElementById('questionContainer');
            container.innerHTML = '';
            activeQuestions.forEach(function(q, idx) {
                container.appendChild(renderQuestion(q, idx));
            });

            // Show form
            document.getElementById('testForm').style.display = '';

            // Re-init timer if time param was set (scripts.js auto-init may
            // have already fired before we set data-time-minutes)
            if (TIME > 0 && typeof initTimer === 'function') {
                initTimer({ minutes: TIME, onTimeUp: gradeAllQuestions });
            }
        }

        /* --- Kick off --- */
        loadQuestions(init);
    })();
    </script>
</body>
</html>
