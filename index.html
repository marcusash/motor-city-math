<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor City Math ‚Äî Dashboard</title>
    <link rel="stylesheet" href="shared/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="shared/chart-theme.js"></script>
    <style>
        body { background: #f9fafb; }
        .dashboard { max-width: 900px; margin: 0 auto; padding: 20px; }
        .dash-header { text-align: center; margin-bottom: 24px; }
        .dash-header h1 { color: #002D62; font-size: 2.5em; font-weight: 700; margin: 0; }
        .dash-header .subtitle { color: #6C6E70; font-weight: 400; font-size: 1.1em; margin-top: 4px; }
        .pistons-stripe {
            height: 4px;
            background: linear-gradient(90deg, #C8102E 30%, #1D42BA 50%, #C8102E 70%);
            border-radius: 2px;
            margin: 16px 0 24px;
        }
        .section-title {
            color: #002D62;
            font-weight: 700;
            font-size: 1.15em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 28px 0 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chart-box {
            background: white;
            border: 1px solid #BEC0C2;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-box canvas { max-height: 250px; }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6C6E70;
            font-size: 1.1em;
        }
        .empty-state .icon { font-size: 2.5em; margin-bottom: 12px; }

        /* Standards grid */
        .standards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .std-card {
            background: white;
            border: 1px solid #BEC0C2;
            border-left: 4px solid #BEC0C2;
            border-radius: 4px;
            padding: 14px;
        }
        .std-card .std-id { font-weight: 700; color: #002D62; font-size: 0.85em; text-transform: uppercase; }
        .std-card .std-name { color: #6C6E70; font-size: 0.85em; margin-bottom: 8px; }
        .std-card .std-pct { font-size: 1.6em; font-weight: 800; margin: 4px 0; }
        .std-card .std-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 6px 0; }
        .std-card .std-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
        .std-card .std-copy { font-size: 0.85em; color: #6C6E70; }
        .std-card.tier-high { border-left-color: #1B7D3A; }
        .std-card.tier-high .std-pct { color: #1B7D3A; }
        .std-card.tier-high .std-fill { background: #1B7D3A; }
        .std-card.tier-mid { border-left-color: #1D42BA; }
        .std-card.tier-mid .std-pct { color: #1D42BA; }
        .std-card.tier-mid .std-fill { background: #1D42BA; }
        .std-card.tier-low { border-left-color: #C8102E; }
        .std-card.tier-low .std-pct { color: #C8102E; }
        .std-card.tier-low .std-fill { background: #C8102E; }
        .std-card.tier-warn { border-left-color: #E8A317; }
        .std-card.tier-warn .std-pct { color: #E8A317; }
        .std-card.tier-warn .std-fill { background: #E8A317; }
        .std-card.tier-none .std-pct { color: #BEC0C2; }

        /* Study next */
        .study-list { list-style: none; padding: 0; margin: 0; }
        .study-item {
            background: white;
            border: 1px solid #BEC0C2;
            border-radius: 6px;
            padding: 12px 16px;
            margin: 6px 0;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .study-item .emoji { font-size: 1.3em; }

        /* Stats bar */
        .stats-bar {
            text-align: center;
            color: #6C6E70;
            font-size: 0.85em;
            padding: 12px 0;
            border-top: 1px solid #eee;
            margin-top: 16px;
        }

        /* Test index */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .test-link {
            display: block;
            background: white;
            border: 1px solid #BEC0C2;
            border-left: 4px solid #1D42BA;
            border-radius: 4px;
            padding: 12px 16px;
            text-decoration: none;
            color: #002D62;
            font-weight: 600;
            font-size: 0.95em;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .test-link:hover {
            border-color: #1D42BA;
            box-shadow: 0 2px 8px rgba(29,66,186,0.12);
        }
        .test-link .test-meta { color: #6C6E70; font-weight: 400; font-size: 0.85em; margin-top: 4px; }
        .test-link .test-score { font-weight: 700; color: #1B7D3A; float: right; }
        .test-link .test-score.low { color: #C8102E; }

        .footer { text-align: center; color: #BEC0C2; font-size: 0.85em; padding: 20px 0 10px; }

        @media (max-width: 768px) {
            .standards-grid { grid-template-columns: 1fr; }
            .test-grid { grid-template-columns: 1fr; }
            .dash-header h1 { font-size: 1.8em; }
            .chart-box canvas { max-height: 200px; }
        }
        @media print { .dashboard { display: none; } }
    </style>
</head>
<body>
    <div class="dashboard">
        <header class="dash-header">
            <h1>Motor City Math</h1>
            <div class="subtitle">Algebra II ¬∑ Kai</div>
            <div class="pistons-stripe"></div>
        </header>

        <div class="section-title">
            <span id="unitTitle">Score History</span>
        </div>
        <div class="chart-box">
            <canvas id="scoreChart" aria-label="Score history chart" role="img"></canvas>
            <div class="empty-state" id="emptyChart" style="display:none;">
                <div class="icon">üèÄ</div>
                <p>No scores yet. Take your first test.</p>
                <p style="font-size:0.9em;">Ask Dad for your next test.</p>
            </div>
        </div>

        <div class="section-title">Standards Breakdown</div>
        <div class="standards-grid" id="standardsGrid" role="list"></div>

        <div class="section-title">What to Study Next</div>
        <ul class="study-list" id="studyList"></ul>

        <div class="section-title">All Tests</div>
        <div class="test-grid" id="testGrid"></div>

        <div class="stats-bar" id="statsBar"></div>
        <div class="footer">Built with üí™ by Dad ¬∑ Motor City Math</div>
    </div>

    <script>
    /* ========== TEST REGISTRY ========== */
    var tests = [
        { file: 'nonlinear_exam_mvp.html', name: 'Nonlinear Functions Exam (MVP)', unit: 'nonlinear', key: 'mcm-nonlinear-exam-mvp', questions: 15 },
        { file: 'linear_functions_test.html', name: 'Linear Functions Practice', unit: 'linear', key: 'mcm-index-results', questions: 14 },
        { file: 'index_calc.html', name: 'Linear Functions (Calculator)', unit: 'linear', key: 'mcm-index-calc-results', questions: 17 },
        { file: 'exponents_exam.html', name: 'Exponents Exam', unit: 'exponents', key: 'exponents_exam', questions: 20 },
        { file: '20260119_Exponents_Unit1.html', name: 'Exponents Unit 1', unit: 'exponents', key: 'exponents_unit1', questions: 17 },
        { file: '20260119_Exponents_Unit1_2nd.html', name: 'Exponents Unit 1 (2nd)', unit: 'exponents', key: 'exponents_unit1_2nd', questions: 17 },
        { file: '20260119_Exponents_Unit1_3rd.html', name: 'Exponents Unit 1 (3rd)', unit: 'exponents', key: 'exponents_unit1_3rd', questions: 17 },
        { file: 'nonlinear_functions_test.html', name: 'Nonlinear Functions Test', unit: 'nonlinear', key: 'nonlinear_test', questions: 23 },
        { file: 'unit2_nonlinear_review.html', name: 'Nonlinear Review (Unit 2)', unit: 'nonlinear', key: 'nonlinear_review', questions: 26 },
        { file: 'final_exam_251123.html', name: 'Final Exam (Nov 23)', unit: 'final', key: 'mcm-final-exam-results', questions: 20 },
        { file: 'final_exam_251123_mini.html', name: 'Final Exam Mini', unit: 'final', key: 'mcm-final-exam-mini-results', questions: 10 },
        { file: 'quiz_251117.html', name: 'Quiz (Nov 17)', unit: 'quizzes', key: 'quiz_251117', questions: 5 },
        { file: 'quiz_251120.html', name: 'Quiz (Nov 20)', unit: 'quizzes', key: 'quiz_251120', questions: 10 },
        { file: 'quiz_251121.html', name: 'Quiz (Nov 21)', unit: 'quizzes', key: 'quiz_251121', questions: 10 }
    ];

    /* ========== READ SCORES ========== */
    function getScores() {
        try { return JSON.parse(localStorage.getItem('mcm_scores') || '{}'); } catch(e) { return {}; }
    }

    /* ========== SCORE CHART ========== */
    function buildChart() {
        var scores = getScores();
        var labels = [], data = [], tooltips = [];
        var hasData = false;

        tests.forEach(function(t) {
            var s = scores[t.key];
            if (s) {
                hasData = true;
                var pct = s.pct || (s.score && s.total ? Math.round(s.score / s.total * 100) : 0);
                labels.push(t.name.length > 20 ? t.name.substring(0, 18) + '‚Ä¶' : t.name);
                data.push(pct);
                tooltips.push(t.name + ': ' + pct + '% ¬∑ ' + (s.score || '?') + '/' + (s.total || '?'));
            }
            // Check extended format (MVP-style with attempts)
            if (scores[t.key] && scores[t.key].attempts) {
                var att = scores[t.key].attempts;
                if (att.length > 0) {
                    var latest = att[att.length - 1];
                    // Already pushed from simple format ‚Äî update with latest attempt
                    var idx = labels.length - 1;
                    if (idx >= 0) {
                        data[idx] = latest.pct;
                        tooltips[idx] = t.name + ': ' + latest.pct + '% ¬∑ ' + latest.score + '/' + latest.total;
                    }
                }
            }
        });

        if (!hasData) {
            document.getElementById('scoreChart').style.display = 'none';
            document.getElementById('emptyChart').style.display = 'block';
            return;
        }

        var ctx = document.getElementById('scoreChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Score %',
                    data: data,
                    borderColor: '#1D42BA',
                    backgroundColor: 'rgba(29, 66, 186, 0.08)',
                    borderWidth: 3,
                    pointBackgroundColor: '#1D42BA',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0, max: 100,
                        ticks: { callback: function(v) { return v + '%'; } },
                        grid: { color: '#eee' }
                    },
                    x: { grid: { display: false } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) { return tooltips[ctx.dataIndex] || ''; }
                        }
                    },
                    annotation: {
                        annotations: {
                            passingLine: {
                                type: 'line', yMin: 80, yMax: 80,
                                borderColor: '#6C6E70', borderWidth: 1, borderDash: [6, 4],
                                label: { content: 'Passing (80%)', display: true, position: 'start', font: { size: 10 }, color: '#6C6E70' }
                            }
                        }
                    }
                },
                animation: { duration: 800, easing: 'easeOutQuart' }
            }
        });
    }

    /* ========== STANDARDS ========== */
    function buildStandards() {
        var scores = getScores();
        var stdData = {};

        // Aggregate per-question standard data from MVP-style storage
        tests.forEach(function(t) {
            var s = scores[t.key];
            if (!s) return;

            // MVP format with per-question tracking
            if (s.attempts && s.attempts.length > 0) {
                var latest = s.attempts[s.attempts.length - 1];
                if (latest.questions) {
                    Object.keys(latest.questions).forEach(function(qid) {
                        var q = latest.questions[qid];
                        var std = q.standard || 'unknown';
                        if (!stdData[std]) stdData[std] = { correct: 0, total: 0, types: {} };
                        stdData[std].total++;
                        if (q.correct) stdData[std].correct++;
                        var type = q.type || 'unknown';
                        if (!stdData[std].types[type]) stdData[std].types[type] = 0;
                        stdData[std].types[type]++;
                    });
                }
            }

            // Simple format with standardScores
            if (s.standardScores) {
                Object.keys(s.standardScores).forEach(function(id) {
                    var ss = s.standardScores[id];
                    if (!stdData[id]) stdData[id] = { correct: 0, total: 0, types: {}, name: ss.name };
                    stdData[id].correct += ss.correct || 0;
                    stdData[id].total += ss.total || 0;
                    if (ss.name) stdData[id].name = ss.name;
                });
            }
        });

        var grid = document.getElementById('standardsGrid');
        var keys = Object.keys(stdData);

        if (keys.length === 0) {
            grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;padding:20px;"><p>No standard data yet. Complete a test to see your breakdown.</p></div>';
            return;
        }

        // Sort lowest first
        keys.sort(function(a, b) {
            var pa = stdData[a].total ? (stdData[a].correct / stdData[a].total) : 0;
            var pb = stdData[b].total ? (stdData[b].correct / stdData[b].total) : 0;
            return pa - pb;
        });

        var html = '';
        keys.forEach(function(id) {
            var s = stdData[id];
            var pct = s.total ? Math.round((s.correct / s.total) * 100) : 0;
            var tier = pct >= 90 ? 'high' : pct >= 70 ? 'mid' : pct >= 50 ? 'warn' : s.total === 0 ? 'none' : 'low';
            var copy = pct >= 90 ? 'Locked in. ‚úÖ' : pct >= 70 ? 'Solid.' : pct >= 50 ? 'Getting there.' : s.total === 0 ? 'Not tested yet.' : '‚ö†Ô∏è Needs work.';
            var name = s.name || id;
            html += '<div class="std-card tier-' + tier + '" role="listitem">' +
                '<div class="std-id">' + id + '</div>' +
                '<div class="std-name">' + name + '</div>' +
                '<div class="std-pct">' + (s.total ? pct + '%' : '‚Äî') + '</div>' +
                '<div class="std-bar" role="progressbar" aria-valuenow="' + pct + '" aria-valuemin="0" aria-valuemax="100">' +
                '<div class="std-fill" style="width:' + pct + '%"></div></div>' +
                '<div class="std-copy">' + copy + '</div>' +
                '</div>';
        });
        grid.innerHTML = html;

        return { keys: keys, data: stdData };
    }

    /* ========== STUDY NEXT ========== */
    function buildStudyNext(stdResult) {
        var list = document.getElementById('studyList');
        if (!stdResult || !stdResult.keys || stdResult.keys.length === 0) {
            list.innerHTML = '<li class="study-item"><span class="emoji">üèÄ</span> Take a test to get personalized study recommendations.</li>';
            return;
        }

        var html = '';
        var count = 0;
        stdResult.keys.forEach(function(id) {
            if (count >= 3) return;
            var s = stdResult.data[id];
            if (s.total === 0) return;
            var pct = Math.round((s.correct / s.total) * 100);
            var emoji = pct < 70 ? 'üèÄ' : pct < 90 ? 'üìà' : '‚úÖ';
            var action = pct < 70 ? 'Start here.' : pct < 90 ? 'Almost there.' : 'Review only.';
            var name = s.name || id;
            html += '<li class="study-item"><span class="emoji">' + emoji + '</span> <strong>' + id + '</strong> (' + name + ') ‚Äî ' + pct + '%. ' + action + '</li>';
            count++;
        });
        list.innerHTML = html || '<li class="study-item"><span class="emoji">‚úÖ</span> All standards looking strong!</li>';
    }

    /* ========== TEST INDEX ========== */
    function buildTestGrid() {
        var scores = getScores();
        var grid = document.getElementById('testGrid');
        var html = '';

        tests.forEach(function(t) {
            var s = scores[t.key];
            var scoreHtml = '';
            if (s) {
                var pct;
                if (s.attempts && s.attempts.length > 0) {
                    pct = s.attempts[s.attempts.length - 1].pct;
                } else {
                    pct = s.pct || (s.score && s.total ? Math.round(s.score / s.total * 100) : null);
                }
                if (pct !== null) {
                    scoreHtml = '<span class="test-score' + (pct < 70 ? ' low' : '') + '">' + pct + '%</span>';
                }
            }
            html += '<a href="' + t.file + '" class="test-link">' +
                t.name + scoreHtml +
                '<div class="test-meta">' + t.questions + ' questions ¬∑ ' + t.unit + '</div>' +
                '</a>';
        });
        grid.innerHTML = html;
    }

    /* ========== STATS BAR ========== */
    function buildStats() {
        var scores = getScores();
        var testCount = 0, lastTest = null, lastPct = null;
        tests.forEach(function(t) {
            var s = scores[t.key];
            if (s) {
                testCount++;
                var ts = s.timestamp;
                if (s.attempts && s.attempts.length > 0) {
                    ts = s.attempts[s.attempts.length - 1].timestamp;
                    lastPct = s.attempts[s.attempts.length - 1].pct;
                } else {
                    lastPct = s.pct;
                }
                if (ts && (!lastTest || ts > lastTest)) lastTest = ts;
            }
        });

        var bar = document.getElementById('statsBar');
        if (testCount === 0) {
            bar.textContent = 'No tests completed yet.';
        } else {
            var dateStr = lastTest ? new Date(lastTest).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '‚Äî';
            bar.textContent = 'Last test: ' + dateStr + (lastPct !== null ? ' ¬∑ ' + lastPct + '%' : '') + ' ¬∑ ' + testCount + ' test' + (testCount !== 1 ? 's' : '') + ' completed';
        }
    }

    /* ========== INIT ========== */
    window.addEventListener('DOMContentLoaded', function() {
        buildChart();
        var stdResult = buildStandards();
        buildStudyNext(stdResult);
        buildTestGrid();
        buildStats();
    });
    </script>
</body>
</html>
