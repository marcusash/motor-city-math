<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="shared/favicon.svg">
    <title>Motor City Math ‚Äî Dashboard</title>
    <link rel="stylesheet" href="shared/styles.css">
    <link rel="stylesheet" href="shared/print.css">
    <script src="shared/chart.min.js"></script>
    <script>if(typeof Chart==="undefined"){var s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/chart.js";document.head.appendChild(s);}</script>
    <script src="shared/chart-theme.js"></script>
    <style>
        body { background: var(--bg-page); }
        .dashboard { max-width: 900px; margin: 0 auto; padding: 20px; }
        .dash-header { text-align: center; margin-bottom: 24px; }
        .dash-header h1 { color: var(--accent-navy); font-size: 2.5em; font-weight: 700; margin: 0; }
        .dash-header .subtitle { color: var(--text-secondary); font-weight: 400; font-size: 1.1em; margin-top: 4px; }
        .section-title {
            color: var(--accent-navy);
            font-weight: 700;
            font-size: 1.15em;
            margin: 28px 0 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            list-style: none;
        }
        .section-title::-webkit-details-marker { display: none; }
        .section-title::after { content: '‚ñ∏'; transition: transform 0.2s; margin-left: 8px; }
        details[open] > .section-title::after { transform: rotate(90deg); }
        .dash-section { margin-bottom: 8px; }
        .chart-box {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-box canvas { max-height: 250px; }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 1.1em;
        }
        .empty-state .icon { font-size: 2.5em; margin-bottom: 12px; }

        /* Standards grid */
        .standards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .std-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-left: 4px solid var(--border-default);
            border-radius: 4px;
            padding: 14px;
        }
        .std-card .std-id { font-weight: 700; color: var(--accent-navy); font-size: 0.85em; text-transform: uppercase; }
        .std-card .std-name { color: var(--text-secondary); font-size: 0.85em; margin-bottom: 8px; }
        .std-card .std-pct { font-size: 1.6em; font-weight: 800; margin: 4px 0; }
        .std-card .std-bar { height: 8px; background: var(--border-subtle); border-radius: 4px; overflow: hidden; margin: 6px 0; }
        .std-card .std-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
        .std-card .std-copy { font-size: 0.85em; color: var(--text-secondary); }
        .std-card.tier-high { border-left-color: var(--color-correct); }
        .std-card.tier-high .std-pct { color: var(--color-correct); }
        .std-card.tier-high .std-fill { background: var(--color-correct); }
        .std-card.tier-mid { border-left-color: var(--accent-blue); }
        .std-card.tier-mid .std-pct { color: var(--accent-blue); }
        .std-card.tier-mid .std-fill { background: var(--accent-blue); }
        .std-card.tier-low { border-left-color: var(--accent-red); }
        .std-card.tier-low .std-pct { color: var(--accent-red); }
        .std-card.tier-low .std-fill { background: var(--accent-red); }
        .std-card.tier-warn { border-left-color: var(--color-warning); }
        .std-card.tier-warn .std-pct { color: var(--color-warning); }
        .std-card.tier-warn .std-fill { background: var(--color-warning); }
        .std-card.tier-none .std-pct { color: var(--border-default); }

        /* Study next */
        .study-list { list-style: none; padding: 0; margin: 0; }
        .study-item {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            padding: 12px 16px;
            margin: 6px 0;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .study-item .emoji { font-size: 1.3em; }

        /* Stats bar */
        .stats-bar {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85em;
            padding: 12px 0;
            border-top: 1px solid var(--border-subtle);
            margin-top: 16px;
        }

        /* Test index */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .test-link {
            display: block;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-left: 4px solid var(--accent-blue);
            border-radius: 4px;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--accent-navy);
            font-weight: 600;
            font-size: 0.95em;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .test-link:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(29,66,186,0.12);
        }
        .test-link .test-meta { color: var(--text-secondary); font-weight: 400; font-size: 0.85em; margin-top: 4px; }
        .test-link .test-score { font-weight: 700; color: var(--color-correct); float: right; }
        .test-link .test-score.low { color: var(--accent-red); }
        .sparkline { display: block; margin-top: 6px; }

        .footer { text-align: center; color: var(--text-secondary); font-size: 0.85em; padding: 20px 0 10px; }
        .nav-btn {
            display: inline-block; padding: 12px 32px;
            font-weight: 700; font-size: 1.05rem; border-radius: 6px; text-decoration: none;
            border: 2px solid transparent; transition: background 0.15s, border-color 0.15s;
            cursor: pointer;
        }
        .nav-btn.primary { background: var(--accent-red); color: var(--text-inverse); border-color: var(--accent-red); }
        .nav-btn.primary:hover { background: var(--accent-red-hover); border-color: var(--accent-red-hover); }
        .nav-btn.secondary { background: transparent; color: var(--accent-navy); border-color: var(--accent-navy); }
        .nav-btn.secondary:hover { background: var(--bg-highlight); }
        .nav-btn.ghost { background: transparent; color: var(--text-secondary); border: none; text-decoration: underline; }

        @media (max-width: 768px) {
            .standards-grid { grid-template-columns: 1fr; }
            .test-grid { grid-template-columns: 1fr; }
            .dash-header h1 { font-size: 1.8em; }
            .chart-box canvas { max-height: 200px; }
        }
        @media print { .dashboard { display: none; } }
    </style>
</head>
<body>
    <a href="#main" class="sr-only">Skip to content</a>
    <div class="dashboard" role="main" id="main">
        <header class="dash-header">
            <h1>Motor City Math</h1>
            <div class="subtitle">Algebra II ¬∑ Kai</div>
        </header>

        <!-- UP NEXT: One primary action above the fold -->
        <div style="text-align:center; margin: 0 0 24px; padding: 24px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-default);">
            <div style="font-size:var(--text-lg); font-weight:700; color:var(--accent-navy); margin-bottom:4px;">Up Next üèÄ</div>
            <div id="upNextInfo" style="color:var(--text-secondary); margin-bottom:16px;">Retake Practice ‚Äî Nonlinear Functions</div>
            <a href="exam.html?file=retake-practice-1" class="nav-btn primary">Start Practice</a>
            <div class="stats-bar" id="statsBar" style="margin-top:16px;"></div>
        </div>

        <!-- Collapsible sections below the fold -->
        <details class="dash-section">
            <summary class="section-title">Your Stats üìä</summary>
            <div class="chart-box">
                <canvas id="scoreChart" aria-label="Score history chart" role="img"></canvas>
                <div class="empty-state" id="emptyChart" style="display:none;">
                    <div class="icon">üèÄ</div>
                    <p>Let's get your first score on the board. üèÄ</p>
                </div>
            </div>
        </details>

        <details class="dash-section">
            <summary class="section-title">Your Game Plan üéØ</summary>
            <div class="standards-grid" id="standardsGrid" role="list"></div>
            <ul class="study-list" id="studyList"></ul>
        </details>

        <details class="dash-section">
            <summary class="section-title">All Tests üèÜ</summary>
            <div class="test-grid" id="retakeGrid"></div>
            <div class="test-grid" id="testGrid" style="margin-top:12px;"></div>
        </details>

        <details class="dash-section">
            <summary class="section-title">Send to Dad üì±</summary>
            <div style="text-align:center; margin: 16px 0 8px;">
                <button class="nav-btn ghost" onclick="exportScores()">üì§ Send Scores to Dad</button>
            </div>
        </details>

        <div class="footer">Built with üí™üèæ by Dad ¬∑ Motor City Math</div>
    </div>

    <script>
    /* ========== TEST REGISTRY ========== */
    var tests = [
        { file: 'exam.html?file=retake-practice-1', name: 'Retake Practice #1', unit: 'nonlinear', key: 'mcm-retake-practice-1', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-2', name: 'Retake Practice #2', unit: 'nonlinear', key: 'mcm-retake-practice-2', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-3', name: 'Retake Practice #3', unit: 'nonlinear', key: 'mcm-retake-practice-3', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-4', name: 'Retake Practice #4', unit: 'nonlinear', key: 'mcm-retake-practice-4', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-5', name: 'Retake Practice #5', unit: 'nonlinear', key: 'mcm-retake-practice-5', questions: 15, retake: true },
        { file: 'nonlinear_exam_mvp.html', name: 'Nonlinear Functions Exam (MVP)', unit: 'nonlinear', key: 'mcm-nonlinear-exam-mvp', questions: 15 },
        { file: 'final_exam_251123.html', name: 'Final Exam (Nov 23)', unit: 'final', key: 'mcm-final-exam-results', questions: 20 },
        { file: 'final_exam_251123_mini.html', name: 'Final Exam Mini', unit: 'final', key: 'mcm-final-exam-mini-results', questions: 10 }
    ];

    /* ========== READ SCORES ========== */
    function getScores() {
        try { return JSON.parse(localStorage.getItem('mcm_scores') || '{}'); } catch(e) { return {}; }
    }

    /* ========== SCORE CHART ========== */
    function buildChart() {
        var scores = getScores();
        var labels = [], data = [], tooltips = [];
        var hasData = false;

        tests.forEach(function(t) {
            var s = scores[t.key];
            if (s) {
                hasData = true;
                var pct = s.pct || (s.score && s.total ? Math.round(s.score / s.total * 100) : 0);
                labels.push(t.name.length > 20 ? t.name.substring(0, 18) + '‚Ä¶' : t.name);
                data.push(pct);
                tooltips.push(t.name + ': ' + pct + '% ¬∑ ' + (s.score || '?') + '/' + (s.total || '?'));
            }
            // Check extended format (MVP-style with attempts)
            if (scores[t.key] && scores[t.key].attempts) {
                var att = scores[t.key].attempts;
                if (att.length > 0) {
                    var latest = att[att.length - 1];
                    // Already pushed from simple format ‚Äî update with latest attempt
                    var idx = labels.length - 1;
                    if (idx >= 0) {
                        data[idx] = latest.pct;
                        tooltips[idx] = t.name + ': ' + latest.pct + '% ¬∑ ' + latest.score + '/' + latest.total;
                    }
                }
            }
        });

        if (!hasData) {
            document.getElementById('scoreChart').style.display = 'none';
            document.getElementById('emptyChart').style.display = 'block';
            return;
        }

        var cs = getComputedStyle(document.documentElement);
        var tkBlue = cs.getPropertyValue('--accent-blue').trim() || '#1D42BA';
        var tkGrid = cs.getPropertyValue('--chart-grid').trim() || '#E2E5EF';
        var tkSecondary = cs.getPropertyValue('--text-secondary').trim() || '#5E6378';
        var tkCorrect = cs.getPropertyValue('--color-correct').trim() || '#1B7D3A';
        var tkRed = cs.getPropertyValue('--accent-red').trim() || '#C8102E';

        var ctx = document.getElementById('scoreChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Score %',
                    data: data,
                    borderColor: tkBlue,
                    backgroundColor: 'rgba(29, 66, 186, 0.08)',
                    borderWidth: 3,
                    pointBackgroundColor: tkBlue,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0, max: 100,
                        ticks: { callback: function(v) { return v + '%'; } },
                        grid: { color: tkGrid }
                    },
                    x: { grid: { display: false } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) { return tooltips[ctx.dataIndex] || ''; }
                        }
                    },
                    annotation: {
                        annotations: {
                            passingLine: {
                                type: 'line', yMin: 80, yMax: 80,
                                borderColor: tkSecondary, borderWidth: 1, borderDash: [6, 4],
                                label: { content: 'Passing (80%)', display: true, position: 'start', font: { size: 10 }, color: tkSecondary }
                            }
                        }
                    }
                },
                animation: { duration: 800, easing: 'easeOutQuart' }
            }
        });
    }

    /* ========== STANDARDS ========== */
    function buildStandards() {
        var scores = getScores();
        var stdData = {};

        // Aggregate per-question standard data from MVP-style storage
        tests.forEach(function(t) {
            var s = scores[t.key];
            if (!s) return;

            // MVP format with per-question tracking
            if (s.attempts && s.attempts.length > 0) {
                var latest = s.attempts[s.attempts.length - 1];
                if (latest.questions) {
                    Object.keys(latest.questions).forEach(function(qid) {
                        var q = latest.questions[qid];
                        var std = q.standard || 'unknown';
                        if (!stdData[std]) stdData[std] = { correct: 0, total: 0, types: {} };
                        stdData[std].total++;
                        if (q.correct) stdData[std].correct++;
                        var type = q.type || 'unknown';
                        if (!stdData[std].types[type]) stdData[std].types[type] = 0;
                        stdData[std].types[type]++;
                    });
                }
            }

            // Simple format with standardScores
            if (s.standardScores) {
                Object.keys(s.standardScores).forEach(function(id) {
                    var ss = s.standardScores[id];
                    if (!stdData[id]) stdData[id] = { correct: 0, total: 0, types: {}, name: ss.name };
                    stdData[id].correct += ss.correct || 0;
                    stdData[id].total += ss.total || 0;
                    if (ss.name) stdData[id].name = ss.name;
                });
            }
        });

        var grid = document.getElementById('standardsGrid');
        var keys = Object.keys(stdData);

        if (keys.length === 0) {
            grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;padding:20px;"><p>No standard data yet. Complete a test to see your breakdown.</p></div>';
            return;
        }

        // Sort lowest first
        keys.sort(function(a, b) {
            var pa = stdData[a].total ? (stdData[a].correct / stdData[a].total) : 0;
            var pb = stdData[b].total ? (stdData[b].correct / stdData[b].total) : 0;
            return pa - pb;
        });

        var html = '';
        keys.forEach(function(id) {
            var s = stdData[id];
            var pct = s.total ? Math.round((s.correct / s.total) * 100) : 0;
            var tier = pct >= 90 ? 'high' : pct >= 70 ? 'mid' : pct >= 50 ? 'warn' : s.total === 0 ? 'none' : 'low';
            var copy = pct >= 90 ? 'Locked in. ‚úÖ' : pct >= 70 ? 'Solid.' : pct >= 50 ? 'Getting there.' : s.total === 0 ? 'Not tested yet.' : '‚ö†Ô∏è Needs work.';
            var name = s.name || id;
            html += '<div class="std-card tier-' + tier + '" role="listitem">' +
                '<div class="std-id">' + id + '</div>' +
                '<div class="std-name">' + name + '</div>' +
                '<div class="std-pct">' + (s.total ? pct + '%' : '‚Äî') + '</div>' +
                '<div class="std-bar" role="progressbar" aria-valuenow="' + pct + '" aria-valuemin="0" aria-valuemax="100">' +
                '<div class="std-fill" style="width:' + pct + '%"></div></div>' +
                '<div class="std-copy">' + copy + '</div>' +
                '</div>';
        });
        grid.innerHTML = html;

        return { keys: keys, data: stdData };
    }

    /* ========== STUDY NEXT ========== */
    function buildStudyNext(stdResult) {
        var list = document.getElementById('studyList');
        if (!stdResult || !stdResult.keys || stdResult.keys.length === 0) {
            list.innerHTML = '<li class="study-item"><span class="emoji">üèÄ</span> Take a test to get personalized study recommendations.</li>';
            return;
        }

        var html = '';
        var count = 0;
        stdResult.keys.forEach(function(id) {
            if (count >= 3) return;
            var s = stdResult.data[id];
            if (s.total === 0) return;
            var pct = Math.round((s.correct / s.total) * 100);
            var emoji = pct < 70 ? 'üèÄ' : pct < 90 ? 'üìà' : '‚úÖ';
            var action = pct < 70 ? 'Start here.' : pct < 90 ? 'Almost there.' : 'Review only.';
            var name = s.name || id;
            html += '<li class="study-item"><span class="emoji">' + emoji + '</span> <strong>' + id + '</strong> (' + name + ') ‚Äî ' + pct + '%. ' + action + '</li>';
            count++;
        });
        list.innerHTML = html || '<li class="study-item"><span class="emoji">‚úÖ</span> All standards looking strong!</li>';
    }

    /* ========== TEST INDEX ========== */
    function buildTestGrid() {
        var scores = getScores();
        var grid = document.getElementById('testGrid');
        var html = '';

        tests.forEach(function(t) {
            if (t.retake) return;
            var s = scores[t.key];
            var scoreHtml = '';
            var sparkHtml = '';
            if (s) {
                var pct;
                if (s.attempts && s.attempts.length > 0) {
                    pct = s.attempts[s.attempts.length - 1].pct;
                    // Build sparkline from last 5 attempts
                    var atts = s.attempts.slice(-5);
                    if (atts.length >= 2) {
                        sparkHtml = buildSparkline(atts.map(function(a) { return a.pct; }));
                    }
                } else {
                    pct = s.pct || (s.score && s.total ? Math.round(s.score / s.total * 100) : null);
                }
                if (pct !== null) {
                    scoreHtml = '<span class="test-score' + (pct < 70 ? ' low' : '') + '">' + pct + '%</span>';
                }
            }
            html += '<a href="' + t.file + '" class="test-link">' +
                t.name + scoreHtml +
                '<div class="test-meta">' + t.questions + ' questions ¬∑ ' + t.unit + '</div>' +
                sparkHtml +
                '</a>';
        });
        grid.innerHTML = html;
    }

    function buildSparkline(values) {
        var w = 80, h = 20, pad = 2;
        var min = Math.min.apply(null, values);
        var max = Math.max.apply(null, values);
        var range = max - min || 1;
        var points = values.map(function(v, i) {
            var x = pad + (i / (values.length - 1)) * (w - 2 * pad);
            var y = h - pad - ((v - min) / range) * (h - 2 * pad);
            return x.toFixed(1) + ',' + y.toFixed(1);
        });
        // Trend color: green if rising, red if falling, blue if flat
        var trend = values[values.length - 1] - values[0];
        var color = trend > 0 ? tkCorrect : trend < 0 ? tkRed : tkBlue;
        return '<svg class="sparkline" width="' + w + '" height="' + h + '" viewBox="0 0 ' + w + ' ' + h + '">' +
            '<polyline fill="none" stroke="' + color + '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" points="' + points.join(' ') + '"/>' +
            '<circle cx="' + points[points.length - 1].split(',')[0] + '" cy="' + points[points.length - 1].split(',')[1] + '" r="2" fill="' + color + '"/>' +
            '</svg>';
    }

    /* ========== STATS BAR ========== */
    function buildStats() {
        var scores = getScores();
        var testCount = 0, lastTest = null, lastPct = null;
        tests.forEach(function(t) {
            var s = scores[t.key];
            if (s) {
                testCount++;
                var ts = s.timestamp;
                if (s.attempts && s.attempts.length > 0) {
                    ts = s.attempts[s.attempts.length - 1].timestamp;
                    lastPct = s.attempts[s.attempts.length - 1].pct;
                } else {
                    lastPct = s.pct;
                }
                if (ts && (!lastTest || ts > lastTest)) lastTest = ts;
            }
        });

        var bar = document.getElementById('statsBar');
        if (testCount === 0) {
            bar.textContent = 'No tests completed yet.';
        } else {
            var dateStr = lastTest ? new Date(lastTest).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '‚Äî';
            bar.textContent = 'Last test: ' + dateStr + (lastPct !== null ? ' ¬∑ ' + lastPct + '%' : '') + ' ¬∑ ' + testCount + ' test' + (testCount !== 1 ? 's' : '') + ' completed';
        }
    }

    /* ========== RETAKE GRID ========== */
    function buildRetakeGrid() {
        var scores = getScores();
        var grid = document.getElementById('retakeGrid');
        var retakeTests = tests.filter(function(t) { return t.retake; });
        var html = '';
        retakeTests.forEach(function(t, i) {
            var scoreHtml = '';
            var s = scores[t.key];
            if (s) {
                var pct = null;
                if (s.attempts && s.attempts.length > 0) {
                    pct = s.attempts[s.attempts.length - 1].pct;
                } else {
                    pct = s.pct || (s.score && s.total ? Math.round(s.score / s.total * 100) : null);
                }
                if (pct !== null) {
                    scoreHtml = '<span class="test-score' + (pct < 70 ? ' low' : '') + '">' + pct + '%</span>';
                }
            }
            html += '<a href="' + t.file + '" class="test-link" style="border-left-color:var(--accent-red);">' +
                'üìù ' + t.name + scoreHtml +
                '<div class="test-meta">' + t.questions + ' questions ¬∑ 60 min ¬∑ nonlinear</div></a>';
        });
        grid.innerHTML = html;
    }

    /* ========== INIT ========== */
    window.addEventListener('DOMContentLoaded', function() {
        buildChart();
        var stdResult = buildStandards();
        buildStudyNext(stdResult);
        buildRetakeGrid();
        buildTestGrid();
        buildStats();
    });

    function exportScores() {
        var data = {
            version: 1,
            exported: new Date().toISOString(),
            student: 'Kai',
            mcm_scores: null,
            mcm_srs: null,
            standardScores: null
        };

        try { data.mcm_scores = JSON.parse(localStorage.getItem('mcm_scores') || 'null'); } catch(e) {}
        try { data.mcm_srs = JSON.parse(localStorage.getItem('mcm_srs') || 'null'); } catch(e) {}
        try { data.standardScores = JSON.parse(localStorage.getItem('standardScores') || 'null'); } catch(e) {}

        if (!data.mcm_scores && !data.mcm_srs) {
            alert('No scores to export yet. Take a test first!');
            return;
        }

        var json = JSON.stringify(data, null, 2);
        var blob = new Blob([json], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'kai-scores-' + new Date().toISOString().slice(0, 10) + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    </script>
    <script src="shared/scripts.js"></script>
</body>
</html>
