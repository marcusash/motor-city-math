<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="shared/favicon.svg">
    <title>Motor City Math ‚Äî Dashboard</title>
    <link rel="stylesheet" href="shared/styles.css">
    <link rel="stylesheet" href="shared/print.css">
    <script src="shared/chart.min.js"></script>
    <script>if(typeof Chart==="undefined"){var s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/chart.js";document.head.appendChild(s);}</script>
    <script src="shared/chart-theme.js"></script>
    <style>
        body { background: var(--bg-page); }
        .dashboard { max-width: 600px; margin: 0 auto; padding: 28px 20px 80px; }
        .dash-header { text-align: center; margin-bottom: 24px; }
        .dash-header h1 { color: var(--accent-navy); font-size: var(--text-2xl); font-weight: 700; margin: 0; }
        .dash-header .subtitle { color: var(--text-secondary); font-weight: 400; font-size: var(--text-base); margin-top: 4px; }
        .section-title {
            color: var(--accent-navy);
            font-weight: 700;
            font-size: var(--text-base);
            margin: 28px 0 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            list-style: none;
        }
        .section-title::-webkit-details-marker { display: none; }
        .section-title::after { content: '‚ñ∏'; transition: transform 0.2s; margin-left: 8px; }
        details[open] > .section-title::after { transform: rotate(90deg); }
        .dash-section { margin-bottom: 8px; }
        .hero-card {
            text-align: center;
            margin: 0 0 24px;
            padding: 24px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-default);
            position: relative;
            overflow: hidden;
        }
        .hero-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(
                to right,
                var(--accent-red) 0%, var(--accent-red) 30%,
                var(--accent-blue) 30%, var(--accent-blue) 70%,
                var(--accent-red) 70%, var(--accent-red) 100%
            );
            border-radius: 8px 8px 0 0;
        }
        .hero-card .hero-title {
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--accent-navy);
            margin-bottom: 4px;
        }
        .hero-card .hero-subtitle {
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        .chart-box {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart-box canvas { max-height: 250px; }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: var(--text-base);
        }
        .empty-state .icon { font-size: var(--text-2xl); margin-bottom: 12px; }

        /* Standards grid */
        .standards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .std-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-left: 4px solid var(--border-default);
            border-radius: 4px;
            padding: 14px;
        }
        .std-card .std-id { font-weight: 700; color: var(--accent-navy); font-size: var(--text-sm); text-transform: uppercase; }
        .std-card .std-name { color: var(--text-secondary); font-size: var(--text-sm); margin-bottom: 8px; }
        .std-card .std-pct { font-size: var(--text-xl); font-weight: 800; margin: 4px 0; }
        .std-card .std-bar { height: 8px; background: var(--border-subtle); border-radius: 4px; overflow: hidden; margin: 6px 0; }
        .std-card .std-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
        .std-card .std-copy { font-size: var(--text-sm); color: var(--text-secondary); }
        .std-card.tier-high { border-left-color: var(--color-correct); }
        .std-card.tier-high .std-pct { color: var(--color-correct); }
        .std-card.tier-high .std-fill { background: var(--color-correct); }
        .std-card.tier-mid { border-left-color: var(--accent-blue); }
        .std-card.tier-mid .std-pct { color: var(--accent-blue); }
        .std-card.tier-mid .std-fill { background: var(--accent-blue); }
        .std-card.tier-low { border-left-color: var(--accent-red); }
        .std-card.tier-low .std-pct { color: var(--accent-red); }
        .std-card.tier-low .std-fill { background: var(--accent-red); }
        .std-card.tier-warn { border-left-color: var(--color-warning); }
        .std-card.tier-warn .std-pct { color: var(--color-warning); }
        .std-card.tier-warn .std-fill { background: var(--color-warning); }
        .std-card.tier-none .std-pct { color: var(--border-default); }

        /* Study next */
        .study-list { list-style: none; padding: 0; margin: 0; }
        .study-item {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            padding: 12px 16px;
            margin: 6px 0;
            font-size: var(--text-sm);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .study-item .emoji { font-size: var(--text-lg); }

        /* Stats bar */
        .stats-bar {
            text-align: center;
            color: var(--text-secondary);
            font-size: var(--text-sm);
            padding: 12px 0;
            border-top: 1px solid var(--border-subtle);
            margin-top: 16px;
        }

        /* Test index */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .test-link {
            display: block;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-left: 4px solid var(--accent-blue);
            border-radius: 4px;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--accent-navy);
            font-weight: 600;
            font-size: var(--text-sm);
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .test-link:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 2px 8px rgba(29,66,186,0.12);
        }
        .test-link .test-meta { color: var(--text-secondary); font-weight: 400; font-size: var(--text-sm); margin-top: 4px; }
        .test-link .test-score { font-weight: 700; color: var(--color-correct); float: right; }
        .test-link .test-score.low { color: var(--accent-red); }
        .sparkline { display: block; margin-top: 6px; }

        .footer { text-align: center; color: var(--text-secondary); font-size: var(--text-sm); padding: 20px 0 10px; }
        .nav-btn {
            display: inline-block; padding: 12px 32px;
            font-weight: 700; font-size: var(--text-base); border-radius: 6px; text-decoration: none;
            border: 2px solid transparent; transition: background 0.15s, border-color 0.15s;
            cursor: pointer;
        }
        .nav-btn.primary { background: var(--accent-red); color: var(--text-inverse); border-color: var(--accent-red); }
        .nav-btn.primary:hover { background: var(--accent-red-hover); border-color: var(--accent-red-hover); }
        .nav-btn.secondary { background: transparent; color: var(--accent-navy); border-color: var(--accent-navy); }
        .nav-btn.secondary:hover { background: var(--accent-navy); color: var(--text-inverse); }
        .nav-btn.ghost { background: transparent; color: var(--text-secondary); border: none; text-decoration: underline; }

        @media (max-width: 768px) {
            .standards-grid { grid-template-columns: 1fr; }
            .test-grid { grid-template-columns: 1fr; }
            .dash-header h1 { font-size: var(--text-xl); }
            .chart-box canvas { max-height: 200px; }
        }
        @media print { .dashboard { display: none; } }

        /* Dashboard header: suppress global header border so hero-card accent bar doesn't double up */
        header.dash-header { border-bottom: none; padding-bottom: 0; margin-bottom: 16px; }

        /* ‚îÄ‚îÄ FD Design Tokens (Feb 2026 redesign) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        :root {
            --fd-bg:      #0d1117;
            --fd-card:    #161b22;
            --fd-raised:  #1c2128;
            --fd-border:  rgba(255,255,255,0.07);
            --fd-border2: rgba(255,255,255,0.14);
            --fd-green:   #3FB950;   /* reserved: scores ‚â• 93% only */
            --fd-text-1:  #E6EDF3;
            --fd-text-2:  #8B949E;
            --fd-text-3:  #6E7681;
            --fd-r:       10px;
        }

        /* ‚îÄ‚îÄ Hero (FD redesign) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .hero {
            background: var(--fd-card);
            border: 1px solid var(--fd-border);
            border-radius: var(--fd-r);
            padding: 28px 24px 22px;
            margin-bottom: 14px;
            text-align: center;
        }
        .hero-eye {
            font-size: 0.72rem; font-weight: 700;
            letter-spacing: 0.1em; text-transform: uppercase;
            color: var(--fd-text-2); margin-bottom: 6px;
        }
        .hero-name {
            font-size: 1.1rem; font-weight: 700;
            margin-bottom: 20px; color: var(--fd-text-1);
            letter-spacing: 0.01em;
        }
        .hero-last {
            color: var(--fd-text-2);
            font-size: 0.75rem; margin-top: 16px;
            letter-spacing: 0.01em;
            border: none; padding: 0;
        }
        .hero-last b { color: var(--fd-text-1); font-weight: 700; }

        /* ‚îÄ‚îÄ Last 2 Tests cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .slabel {
            font-size: 0.68rem; font-weight: 700;
            letter-spacing: 0.11em; text-transform: uppercase;
            color: var(--fd-text-3); margin-bottom: 10px;
            display: block;
        }
        .cards-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .test-card {
            background: var(--fd-card); border: 1px solid var(--fd-border);
            border-radius: var(--fd-r); padding: 18px 18px 14px;
            display: flex; flex-direction: column;
        }
        .tc-head {
            display: flex; justify-content: space-between;
            align-items: flex-start; margin-bottom: 12px;
        }
        .tc-name { font-size: 0.82rem; font-weight: 700; color: var(--fd-text-1); }
        .tc-date { font-size: 0.73rem; color: var(--fd-text-3); margin-top: 3px; }
        .tc-score {
            font-size: 2.5rem; font-weight: 900; line-height: 1;
            letter-spacing: -0.025em;
        }
        .tc-attempt { font-size: 0.73rem; color: var(--fd-text-3); margin: 5px 0 16px; }
        .tc-rib {
            margin-top: auto; border-top: 1px solid var(--fd-border); padding-top: 11px;
            display: flex; align-items: center; gap: 8px;
        }
        .tc-norib {
            margin-top: auto; border-top: 1px solid var(--fd-border); padding-top: 11px;
            font-size: 0.73rem; color: var(--fd-text-3);
        }
        .rib-text { font-size: 0.73rem; color: var(--fd-text-2); line-height: 1.6; }
        .rib-delta { font-weight: 700; }

        /* ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .bottom-nav { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 24px 0; }
        .bn-tile {
            background: var(--fd-card); border: 1px solid var(--fd-border);
            border-radius: 8px; padding: 15px 18px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: border-color 0.12s;
            text-decoration: none;
        }
        .bn-tile:hover { border-color: var(--fd-border2); }
        .bn-title { font-size: 0.875rem; font-weight: 700; color: var(--fd-text-1); }
        .bn-sub { font-size: 0.73rem; color: var(--fd-text-2); margin-top: 3px; }
        .bn-arrow { color: var(--fd-text-2); font-size: 0.85rem; }
        @media (max-width: 500px) {
            .cards-2 { grid-template-columns: 1fr; }
            .bottom-nav { grid-template-columns: 1fr; }
        }
        /* .dad-banner and .hero-greeting moved to shared/styles.css */
        /* ‚îÄ‚îÄ App Header (FD redesign) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .app-hd { text-align: center; margin-bottom: 24px; }
        .app-hd h1 { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.025em; color: var(--fd-text-1); margin: 0; }
        .app-hd p  { color: var(--fd-text-2); font-size: 0.82rem; margin-top: 4px; }
        /* Hide arena toggle ‚Äî FD design is always dark */
        #arenaToggle { display: none !important; }
        .trend-card {
            background: var(--fd-card); border: 1px solid var(--fd-border);
            border-radius: var(--fd-r); padding: 18px 18px 14px; margin-bottom: 14px;
        }
        .trend-hd {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 14px;
        }
        .ch-legend {
            display: flex; align-items: center; gap: 16px;
            font-size: 0.82rem; color: var(--fd-text-2);
        }
        .ch-legend span { display: flex; align-items: center; gap: 8px; }
        .swatch-solid {
            display: inline-block; width: 22px; height: 2px;
            background: rgba(255,255,255,0.52); border-radius: 2px; flex-shrink: 0;
        }
        .swatch-dash {
            display: inline-block; width: 22px; height: 2px;
            background: repeating-linear-gradient(to right,rgba(255,255,255,0.35) 0,rgba(255,255,255,0.35) 5px,transparent 5px,transparent 8px);
            flex-shrink: 0;
        }
        .trend-hd-r { font-size: 0.73rem; color: var(--fd-text-3); }
        .trend-hd-r b { color: var(--fd-green); font-weight: 700; font-size: 0.82rem; }
        .trend-empty {
            text-align: center; padding: 28px 0; color: var(--fd-text-3); font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <script>localStorage.removeItem('mcm-arena-mode');</script>
    <a href="#main" class="sr-only">Skip to content</a>
    <div class="dashboard" role="main" id="main">

        <!-- Dad Mode banner (hidden until ?dad=1) -->
        <div class="dad-banner" id="dadBanner" style="display:none;">
            <span class="dad-label">üë® Dad View</span>
            <span class="dad-status" id="dadStatus">Loading Kai's scores...</span>
            <label class="dad-upload-label">
                Update from Kai's device
                <input type="file" accept=".json" id="dadFileInput" style="display:none;" onchange="loadDadFile(this)">
            </label>
        </div>

        <div class="print-header">
            <strong>Motor City Math ‚Äî Dashboard</strong><br>
            Name: _____________________ Date: ___________
        </div>
        <header class="app-hd">
            <h1>Motor City Math üèÄ</h1>
            <p>Algebra II &middot; Kai</p>
        </header>

        <!-- UP NEXT hero (FD redesign) -->
        <div class="hero">
            <div class="hero-eye">Up Next</div>
            <div class="hero-name" id="upNextInfo">Retake Practice ‚Äî Nonlinear Functions</div>
            <a href="exam.html?file=retake-practice-1" class="nav-btn primary">Start Practice</a>
            <div class="hero-last" id="statsBar"></div>
        </div>

        <!-- Progress Chart (FD design) -->
        <span class="slabel">Your Progress</span>
        <div class="trend-card">
            <div class="trend-hd">
                <div class="ch-legend">
                    <span><span class="swatch-solid"></span>First attempt</span>
                    <span><span class="swatch-dash"></span>Run it back</span>
                </div>
                <div class="trend-hd-r">Target: <b>A (93%+)</b></div>
            </div>
            <div id="trendChartContainer"></div>
        </div>

        <!-- Last 2 Tests -->
        <span class="slabel" id="last2Label" style="display:none;">Last 2 Tests</span>
        <div class="cards-2" id="last2Grid" style="display:none;"></div>

        <!-- Bottom Nav -->
        <div class="bottom-nav">
            <div class="bn-tile" onclick="var s=document.getElementById('allTestsSection');s.open=true;s.scrollIntoView({behavior:'smooth'});">
                <div><div class="bn-title">All Tests</div><div class="bn-sub">Every score over time</div></div>
                <span class="bn-arrow">&#8594;</span>
            </div>
            <div class="bn-tile" onclick="var s=document.getElementById('gamePlanSection');s.open=true;s.scrollIntoView({behavior:'smooth'});">
                <div><div class="bn-title">Per Standard</div><div class="bn-sub">W2 &middot; W3 breakdown</div></div>
                <span class="bn-arrow">&#8594;</span>
            </div>
        </div>

        <!-- Collapsible sections below the fold -->
        

        <details class="dash-section" id="gamePlanSection">
            <summary class="section-title">Your Game Plan üéØ</summary>
            <div class="standards-grid" id="standardsGrid" role="list"></div>
            <ul class="study-list" id="studyList"></ul>
        </details>

        <details class="dash-section" id="allTestsSection">
            <summary class="section-title">All Tests üèÜ</summary>
            <div class="test-grid" id="retakeGrid"></div>
            <div class="test-grid" id="testGrid" style="margin-top:12px;"></div>
        </details>

        <details class="dash-section">
            <summary class="section-title">Send to Dad üì±</summary>
            <div style="text-align:center; margin: 16px 0 8px;">
                <button class="nav-btn ghost" onclick="exportScores()">üì§ Send Scores to Dad</button>
                <label class="nav-btn ghost" style="cursor:pointer; display:inline-block; margin-top:8px;">
                    üì• Load Corrected Scores
                    <input type="file" accept=".json" style="display:none;" onchange="restoreScores(this)">
                </label>
            </div>
        </details>

        <div class="footer">Built with üí™üèæ by Dad ¬∑ Motor City Math</div>
    </div>

    <script>
    /* ========== TEST REGISTRY ========== */
    var tests = [
        { file: 'exam.html?file=retake-practice-1', name: 'Retake Practice #1', unit: 'nonlinear', key: 'mcm-retake-practice-1', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-2', name: 'Retake Practice #2', unit: 'nonlinear', key: 'mcm-retake-practice-2', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-3', name: 'Retake Practice #3', unit: 'nonlinear', key: 'mcm-retake-practice-3', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-4', name: 'Retake Practice #4', unit: 'nonlinear', key: 'mcm-retake-practice-4', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-5', name: 'Retake Practice #5', unit: 'nonlinear', key: 'mcm-retake-practice-5', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-6', name: 'Retake Practice #6 (W2.b Drill)', unit: 'nonlinear', key: 'mcm-retake-practice-6', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-7', name: 'Retake Practice #7 (Mock Retake)', unit: 'nonlinear', key: 'mcm-retake-practice-7', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-8', name: 'Retake Practice #8', unit: 'nonlinear', key: 'mcm-retake-practice-8', questions: 15, retake: true },
        { file: 'exam.html?file=retake-practice-9', name: 'Retake Practice #9', unit: 'nonlinear', key: 'mcm-retake-practice-9', questions: 15, retake: true },
        { file: 'nonlinear_exam_mvp.html', name: 'Nonlinear Functions Exam (MVP)', unit: 'nonlinear', key: 'mcm-nonlinear-exam-mvp', questions: 15 },
        { file: 'final_exam_251123.html', name: 'Final Exam (Nov 23)', unit: 'final', key: 'mcm-final-exam-results', questions: 20 },
        { file: 'final_exam_251123_mini.html', name: 'Final Exam Mini', unit: 'final', key: 'mcm-final-exam-mini-results', questions: 10 }
    ];

    /* ========== DAD MODE ========== */
    var _dadMode = new URLSearchParams(window.location.search).get('dad') === '1';
    var _dadScores = null;
    var _chartInstance = null;

    /* ========== READ SCORES ========== */
    function getScores() {
        if (_dadMode && _dadScores) return _dadScores;
        try { return JSON.parse(localStorage.getItem('mcm_scores') || '{}'); } catch(e) { return {}; }
    }

    /* ========== SCORE CHART (FD SVG design) ========== */
    function buildChart() {
        var container = document.getElementById('trendChartContainer');
        if (!container) return;
        var scores = getScores();

        // Collect ordered data points: original exam first, then retake practices
        var pts = [];
        var origScore = scores['mcm-nonlinear-exam-mvp'];
        if (origScore) {
            var att = origScore.attempts || (origScore.pct ? [origScore] : []);
            if (att[0]) {
                var fa = att[0].pct || Math.round(att[0].score / att[0].total * 100);
                var rib = att[1] ? (att[1].pct || Math.round(att[1].score / att[1].total * 100)) : null;
                pts.push({ label: '1st Test', fa: fa, rib: rib });
            }
        }
        var retakes = tests.filter(function(t) { return t.retake; });
        var practiceNum = 0;
        retakes.forEach(function(t) {
            var s = scores[t.key];
            if (!s) return;
            var att = s.attempts || (s.pct ? [s] : []);
            if (!att[0]) return;
            practiceNum++;
            var fa = att[0].pct || Math.round(att[0].score / att[0].total * 100);
            var rib = att[1] ? (att[1].pct || Math.round(att[1].score / att[1].total * 100)) : null;
            pts.push({ label: 'Practice ' + practiceNum, fa: fa, rib: rib });
        });

        if (pts.length === 0) {
            container.innerHTML = '<div class="trend-empty">üèÄ Complete your first test to see your progress</div>';
            return;
        }

        // Coordinate math
        var n = pts.length;
        var xL = 50, xR = 490;
        var xs = pts.map(function(_, i) {
            return n === 1 ? (xL + xR) / 2 : xL + i * (xR - xL) / (n - 1);
        });
        function yPt(s) {
            var clamped = Math.min(100, Math.max(40, s));
            return 14 + 95 * (1 - (clamped - 40) / 60);
        }
        // Grade reference y-values (A=93%, B=80%, C=67%)
        var yA = 25.1, yB = 45.7, yC = 66.3;

        // Build smooth bezier path through points
        function makePath(xArr, yArr) {
            if (!xArr.length) return '';
            if (xArr.length === 1) return 'M ' + xArr[0] + ',' + yArr[0];
            var d = 'M ' + xArr[0] + ',' + yArr[0];
            for (var i = 1; i < xArr.length; i++) {
                var cx = (xArr[i-1] + xArr[i]) / 2;
                d += ' C ' + cx + ',' + yArr[i-1] + ' ' + cx + ',' + yArr[i] + ' ' + xArr[i] + ',' + yArr[i];
            }
            return d;
        }

        var faYs = pts.map(function(p) { return yPt(p.fa); });
        var faPath = makePath(xs, faYs);
        var fillPath = faPath + ' V 108 H ' + xs[0] + ' Z';

        // RIB points (where rib score exists)
        var ribXs = [], ribYs = [], ribPcts = [];
        pts.forEach(function(p, i) {
            if (p.rib !== null && p.rib !== undefined) {
                ribXs.push(xs[i]); ribYs.push(yPt(p.rib)); ribPcts.push(p.rib);
            }
        });
        var ribPath = ribXs.length > 1 ? makePath(ribXs, ribYs) : '';

        // Last scores for right-edge labels
        var lastX = xs[n-1], lastFaY = faYs[n-1], lastFaPct = pts[n-1].fa;
        var lastRibPct = ribPcts.length ? ribPcts[ribPcts.length-1] : null;
        var lastRibY = ribYs.length ? ribYs[ribYs.length-1] : null;
        var lastRibX = ribXs.length ? ribXs[ribXs.length-1] : null;
        var labelX = (lastRibPct !== null ? lastRibX : lastX) + 10;

        // FA dots SVG
        var faDots = pts.map(function(p, i) {
            var x = xs[i], y = faYs[i];
            if (i === n-1 && p.fa >= 93) {
                return '<circle cx="'+x+'" cy="'+y+'" r="9" fill="rgba(63,185,80,0.07)"/>' +
                       '<circle cx="'+x+'" cy="'+y+'" r="5" fill="rgba(63,185,80,0.15)" stroke="#3FB950" stroke-width="2"/>' +
                       '<circle cx="'+x+'" cy="'+y+'" r="2" fill="#3FB950"/>';
            }
            return '<circle cx="'+x+'" cy="'+y+'" r="4" fill="#161b22" stroke="rgba(255,255,255,0.5)" stroke-width="2"/>';
        }).join('');

        // RIB dots SVG
        var ribDots = ribXs.map(function(rx, i) {
            var isLast = i === ribXs.length-1;
            var isGreen = ribPcts[i] >= 93;
            if (isLast && isGreen) {
                return '<circle cx="'+rx+'" cy="'+ribYs[i]+'" r="9" fill="rgba(63,185,80,0.07)"/>' +
                       '<circle cx="'+rx+'" cy="'+ribYs[i]+'" r="5" fill="rgba(63,185,80,0.15)" stroke="#3FB950" stroke-width="2"/>' +
                       '<circle cx="'+rx+'" cy="'+ribYs[i]+'" r="2" fill="#3FB950"/>';
            }
            return '<circle cx="'+rx+'" cy="'+ribYs[i]+'" r="3" fill="#161b22" stroke="rgba(255,255,255,0.28)" stroke-width="1.5"/>';
        }).join('');

        // Score labels
        var faColor = lastFaPct >= 93 ? '#3FB950' : '#8B949E';
        var rightLabels = '';
        if (lastRibPct !== null) {
            var ribColor = lastRibPct >= 93 ? '#3FB950' : '#E6EDF3';
            rightLabels = '<text x="'+(labelX+4)+'" y="'+(lastRibY+4)+'" font-size="12" font-weight="700" fill="'+ribColor+'" font-family="var(--font-body)">'+lastRibPct+'%</text>' +
                          '<text x="'+(labelX+4)+'" y="'+(lastFaY+4)+'" font-size="12" font-weight="700" fill="'+faColor+'" font-family="var(--font-body)">'+lastFaPct+'%</text>';
        } else {
            rightLabels = '<text x="'+(labelX+4)+'" y="'+(lastFaY+4)+'" font-size="12" font-weight="700" fill="'+faColor+'" font-family="var(--font-body)">'+lastFaPct+'%</text>';
        }

        // X-axis labels
        var xLabels = pts.map(function(p, i) {
            return '<text x="'+xs[i]+'" y="116" font-size="10" fill="rgba(255,255,255,0.35)" text-anchor="middle" font-family="var(--font-body)">'+p.label+'</text>';
        }).join('');

        var gid = 'fdg' + Date.now();
        var legendSvg = ribXs.length > 0 ?
            '<div style="display:flex;gap:16px;padding:4px 0 0 50px;font-size:11px;font-family:var(--font-body);color:rgba(255,255,255,0.5)">' +
            '<span><svg width="16" height="10" style="vertical-align:middle;margin-right:4px"><line x1="0" y1="5" x2="16" y2="5" stroke="rgba(255,255,255,0.52)" stroke-width="2.5"/><circle cx="8" cy="5" r="3" fill="#161b22" stroke="rgba(255,255,255,0.5)" stroke-width="2"/></svg>First try</span>' +
            '<span><svg width="16" height="10" style="vertical-align:middle;margin-right:4px"><line x1="0" y1="5" x2="16" y2="5" stroke="rgba(63,185,80,0.65)" stroke-width="1.5" stroke-dasharray="5 4"/><circle cx="8" cy="5" r="2" fill="#161b22" stroke="rgba(255,255,255,0.28)" stroke-width="1.5"/></svg>Run It Back</span>' +
            '</div>' : '';
        container.innerHTML =
            '<svg role="img" aria-label="Score progress chart showing ' + n + ' test' + (n !== 1 ? 's' : '') + '" viewBox="0 0 560 120" height="120" style="display:block;width:100%;overflow:visible">' +
            '<defs><linearGradient id="'+gid+'" x1="'+xs[0]+'" y1="108" x2="'+lastX+'" y2="'+lastFaY+'" gradientUnits="userSpaceOnUse">' +
            '<stop offset="0%" stop-color="rgba(255,255,255,0.01)"/>' +
            '<stop offset="55%" stop-color="rgba(255,255,255,0.08)"/>' +
            '<stop offset="100%" stop-color="rgba(255,255,255,0.17)"/>' +
            '</linearGradient></defs>' +
            // Grade lines
            '<line x1="28" y1="'+yC+'" x2="508" y2="'+yC+'" stroke="rgba(255,255,255,0.20)" stroke-width="1" stroke-dasharray="3 7"/>' +
            '<text x="16" y="'+(yC+3.5)+'" font-size="10" font-weight="700" fill="rgba(255,255,255,0.42)" font-family="var(--font-body)" text-anchor="middle">C</text>' +
            '<line x1="28" y1="'+yB+'" x2="508" y2="'+yB+'" stroke="rgba(255,255,255,0.25)" stroke-width="1" stroke-dasharray="3 7"/>' +
            '<text x="16" y="'+(yB+3.5)+'" font-size="10" font-weight="700" fill="rgba(255,255,255,0.55)" font-family="var(--font-body)" text-anchor="middle">B</text>' +
            '<line x1="28" y1="'+yA+'" x2="508" y2="'+yA+'" stroke="rgba(63,185,80,0.65)" stroke-width="1" stroke-dasharray="3 7"/>' +
            '<text x="14" y="'+(yA+3.5)+'" font-size="12" font-weight="700" fill="rgba(63,185,80,1)" font-family="var(--font-body)" text-anchor="middle">A</text>' +
            // Fill + FA line
            '<path d="'+fillPath+'" fill="url(#'+gid+')"/>' +
            '<path d="'+faPath+'" fill="none" stroke="rgba(255,255,255,0.52)" stroke-width="2.5" stroke-linecap="round"/>' +
            // RIB line + dots
            (ribPath ? '<path d="'+ribPath+'" fill="none" stroke="rgba(63,185,80,0.65)" stroke-width="1.5" stroke-dasharray="5 4" stroke-linecap="round"/>' : '') +
            ribDots + faDots + rightLabels + xLabels +
            '</svg>' + legendSvg;
    }
    /* ========== STANDARDS ========== */
    function buildStandards() {
        var scores = getScores();
        var stdData = {};

        // Aggregate per-question standard data from all tests with question tracking
        tests.forEach(function(t) {
            var s = scores[t.key];
            if (!s) return;

            // MVP format with per-question tracking
            if (s.attempts && s.attempts.length > 0) {
                var latest = s.attempts[s.attempts.length - 1];
                if (latest.questions) {
                    Object.keys(latest.questions).forEach(function(qid) {
                        var q = latest.questions[qid];
                        var std = q.standard || 'unknown';
                        if (!stdData[std]) stdData[std] = { correct: 0, total: 0, types: {} };
                        stdData[std].total++;
                        if (q.correct) stdData[std].correct++;
                        var type = q.type || 'unknown';
                        if (!stdData[std].types[type]) stdData[std].types[type] = 0;
                        stdData[std].types[type]++;
                    });
                }
            }
        });

        var grid = document.getElementById('standardsGrid');
        var keys = Object.keys(stdData);

        if (keys.length === 0) {
            grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;padding:20px;"><p>Take a test and we\'ll break down your game. üìä</p></div>';
            return;
        }

        // Sort lowest first
        keys.sort(function(a, b) {
            var pa = stdData[a].total ? (stdData[a].correct / stdData[a].total) : 0;
            var pb = stdData[b].total ? (stdData[b].correct / stdData[b].total) : 0;
            return pa - pb;
        });

        var html = '';
        keys.forEach(function(id) {
            var s = stdData[id];
            var pct = s.total ? Math.round((s.correct / s.total) * 100) : 0;
            var tier = pct >= 90 ? 'high' : pct >= 70 ? 'mid' : pct >= 50 ? 'warn' : s.total === 0 ? 'none' : 'low';
            var copy = pct >= 90 ? 'Locked in. ‚úÖ' : pct >= 70 ? 'Solid.' : pct >= 50 ? 'Getting there.' : s.total === 0 ? 'Not tested yet.' : '‚ö†Ô∏è Needs work.';
            var name = s.name || id;
            html += '<div class="std-card tier-' + tier + '" role="listitem">' +
                '<div class="std-id">' + id + '</div>' +
                '<div class="std-name">' + name + '</div>' +
                '<div class="std-pct">' + (s.total ? pct + '%' : '‚Äî') + '</div>' +
                '<div class="std-bar" role="progressbar" aria-label="' + id + ' ' + pct + '%'" aria-valuenow="' + pct + '" aria-valuemin="0" aria-valuemax="100">' +
                '<div class="std-fill" style="width:' + pct + '%"></div></div>' +
                '<div class="std-copy">' + copy + '</div>' +
                '</div>';
        });
        grid.innerHTML = html;

        return { keys: keys, data: stdData };
    }

    /* ========== STUDY NEXT ========== */
    function buildStudyNext(stdResult) {
        var list = document.getElementById('studyList');
        if (!stdResult || !stdResult.keys || stdResult.keys.length === 0) {
            list.innerHTML = '<li class="study-item"><span class="emoji">üí™</span> Your highlights reel starts with test #1.</li>';
            return;
        }

        var html = '';
        var count = 0;
        stdResult.keys.forEach(function(id) {
            if (count >= 3) return;
            var s = stdResult.data[id];
            if (s.total === 0) return;
            var pct = Math.round((s.correct / s.total) * 100);
            var emoji = pct < 70 ? 'üèÄ' : pct < 90 ? 'üìà' : '‚úÖ';
            var action = pct < 70 ? 'Start here.' : pct < 90 ? 'Almost there.' : 'Review only.';
            var name = s.name || id;
            html += '<li class="study-item"><span class="emoji">' + emoji + '</span> <strong>' + id + '</strong> (' + name + ') ‚Äî ' + pct + '%. ' + action + '</li>';
            count++;
        });
        list.innerHTML = html || '<li class="study-item"><span class="emoji">‚úÖ</span> All standards looking strong!</li>';
    }

    /* ========== TEST INDEX ========== */
    function buildTestGrid() {
        var scores = getScores();
        var grid = document.getElementById('testGrid');
        var html = '';

        tests.forEach(function(t) {
            if (t.retake) return;
            var s = scores[t.key];
            var scoreHtml = '';
            var sparkHtml = '';
            if (s) {
                var pct;
                if (s.attempts && s.attempts.length > 0) {
                    pct = s.attempts[s.attempts.length - 1].pct;
                    // Build sparkline from last 5 attempts
                    var atts = s.attempts.slice(-5);
                    if (atts.length >= 2) {
                        sparkHtml = buildSparkline(atts.map(function(a) { return a.pct; }));
                    }
                } else {
                    pct = s.pct || (s.score && s.total ? Math.round(s.score / s.total * 100) : null);
                }
                if (pct !== null) {
                    scoreHtml = '<span class="test-score' + (pct < 70 ? ' low' : '') + '">' + pct + '%</span>';
                }
            }
            html += '<a href="' + t.file + '" class="test-link">' +
                t.name + scoreHtml +
                '<div class="test-meta">' + t.questions + ' questions ¬∑ ' + t.unit + '</div>' +
                sparkHtml +
                '</a>';
        });
        grid.innerHTML = html;
    }

    function buildSparkline(values) {
        var cs = getComputedStyle(document.documentElement);
        var tkBlue = cs.getPropertyValue('--accent-blue').trim() || '#1D42BA';
        var tkCorrect = cs.getPropertyValue('--color-correct').trim() || '#1B7D3A';
        var tkRed = cs.getPropertyValue('--accent-red').trim() || '#C8102E';
        var w = 80, h = 20, pad = 2;
        var min = Math.min.apply(null, values);
        var max = Math.max.apply(null, values);
        var range = max - min || 1;
        var points = values.map(function(v, i) {
            var x = pad + (i / (values.length - 1)) * (w - 2 * pad);
            var y = h - pad - ((v - min) / range) * (h - 2 * pad);
            return x.toFixed(1) + ',' + y.toFixed(1);
        });
        // Trend color: green if rising, red if falling, blue if flat
        var trend = values[values.length - 1] - values[0];
        var color = trend > 0 ? tkCorrect : trend < 0 ? tkRed : tkBlue;
        return '<svg class="sparkline" width="' + w + '" height="' + h + '" viewBox="0 0 ' + w + ' ' + h + '">' +
            '<polyline fill="none" stroke="' + color + '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" points="' + points.join(' ') + '"/>' +
            '<circle cx="' + points[points.length - 1].split(',')[0] + '" cy="' + points[points.length - 1].split(',')[1] + '" r="2" fill="' + color + '"/>' +
            '</svg>';
    }

    /* ========== LAST 2 TESTS CARDS (FD redesign) ========== */
    function buildLast2Tests() {
        var scores = getScores();
        var grid = document.getElementById('last2Grid');
        var label = document.getElementById('last2Label');
        if (!grid) return;

        var played = [];
        tests.forEach(function(t) {
            var s = scores[t.key];
            if (!s) return;
            var firstAtt = null, ribAtt = null, ts = 0;
            if (s.attempts && s.attempts.length > 0) {
                firstAtt = s.attempts[0];
                ribAtt = s.attempts.length > 1 ? s.attempts[s.attempts.length - 1] : null;
                ts = firstAtt.timestamp || 0;
            } else if (s.pct || s.score) {
                firstAtt = { pct: s.pct || Math.round((s.score / s.total) * 100), score: s.score, total: s.total, timestamp: s.timestamp };
                ts = s.timestamp || 0;
            }
            if (!firstAtt) return;
            played.push({ t: t, firstAtt: firstAtt, ribAtt: ribAtt, ts: ts });
        });

        if (played.length === 0) {
            if (label) label.style.display = 'none';
            grid.style.display = 'none';
            return;
        }

        played.sort(function(a, b) { return (b.ts || 0) - (a.ts || 0); });
        var recent = played.slice(0, 2);

        if (label) label.style.display = 'block';
        grid.style.display = 'grid';

        var html = '';
        recent.forEach(function(item) {
            var pct = item.firstAtt.pct || Math.round(((item.firstAtt.score || 0) / (item.firstAtt.total || 1)) * 100);
            var isGreen = pct >= 93;
            var scoreColor = isGreen ? 'var(--fd-green)' : 'var(--fd-text-1)';
            var dateStr = item.firstAtt.timestamp
                ? new Date(item.firstAtt.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                : '';
            var ribHtml = '';
            if (item.ribAtt) {
                var ribPct = item.ribAtt.pct || Math.round(((item.ribAtt.score || 0) / (item.ribAtt.total || 1)) * 100);
                var delta = ribPct - pct;
                var deltaStr = delta > 0 ? ' +' + delta : (delta < 0 ? ' ' + delta : '');
                ribHtml = '<div class="tc-rib"><div class="rib-text">Run It Back<br>' +
                    '<span class="rib-delta" style="color:' + (ribPct >= 93 ? 'var(--fd-green)' : 'var(--fd-text-2)') + '">' +
                    ribPct + '%' + deltaStr + '</span></div></div>';
            } else {
                ribHtml = '<div class="tc-norib">No retake yet</div>';
            }
            html += '<div class="test-card">' +
                '<div class="tc-head"><div>' +
                '<div class="tc-name">' + item.t.name + '</div>' +
                (dateStr ? '<div class="tc-date">' + dateStr + '</div>' : '') +
                '</div></div>' +
                '<div class="tc-score" style="color:' + scoreColor + '">' + pct + '%</div>' +
                '<div class="tc-attempt">First attempt &middot; ' + (item.firstAtt.score || '?') + '/' + (item.firstAtt.total || '?') + '</div>' +
                ribHtml + '</div>';
        });
        grid.innerHTML = html;
    }

    /* ========== STATS BAR ========== */
    function buildStats() {
        var scores = getScores();
        var testCount = 0, lastTest = null, lastPct = null;
        tests.forEach(function(t) {
            var s = scores[t.key];
            if (s) {
                testCount++;
                var ts = s.timestamp;
                var pct = s.pct;
                if (s.attempts && s.attempts.length > 0) {
                    ts = s.attempts[s.attempts.length - 1].timestamp;
                    pct = s.attempts[s.attempts.length - 1].pct;
                }
                if (ts && (!lastTest || ts > lastTest)) {
                    lastTest = ts;
                    lastPct = pct;
                }
            }
        });

        var bar = document.getElementById('statsBar');
        if (testCount === 0) {
            bar.textContent = 'Your highlights reel starts with test #1. üí™';
        } else {
            var dateStr = lastTest ? new Date(lastTest).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '‚Äî';
            bar.textContent = 'Last test: ' + dateStr + (lastPct !== null ? ' ¬∑ ' + lastPct + '%' : '') + ' ¬∑ ' + testCount + ' test' + (testCount !== 1 ? 's' : '') + ' completed';
        }
    }

    /* ========== RETAKE GRID ========== */
    function buildRetakeGrid() {
        var scores = getScores();
        var grid = document.getElementById('retakeGrid');
        var retakeTests = tests.filter(function(t) { return t.retake; });
        var html = '';
        retakeTests.forEach(function(t, i) {
            var scoreHtml = '';
            var borderColor = 'var(--accent-blue)';
            var s = scores[t.key];
            if (s) {
                var pct = null;
                if (s.attempts && s.attempts.length > 0) {
                    pct = s.attempts[s.attempts.length - 1].pct;
                } else {
                    pct = s.pct || (s.score && s.total ? Math.round(s.score / s.total * 100) : null);
                }
                if (pct !== null) {
                    scoreHtml = '<span class="test-score' + (pct < 70 ? ' low' : '') + '">' + pct + '%</span>';
                    // SAAS grade colors: ‚â•92% green, 82-91% blue, 70-81% warning, <70% red
                    if (pct >= 92) borderColor = 'var(--color-correct)';
                    else if (pct >= 82) borderColor = 'var(--accent-blue)';
                    else if (pct >= 70) borderColor = 'var(--color-warning)';
                    else borderColor = 'var(--accent-red)';
                }
            }
            html += '<a href="' + t.file + '" class="test-link" style="border-left-color:' + borderColor + ';">' +
                'üìù ' + t.name + scoreHtml +
                '<div class="test-meta">' + t.questions + ' questions ¬∑ 60 min ¬∑ nonlinear</div></a>';
        });
        grid.innerHTML = html;
    }

    /* ========== UP NEXT (ADHD: one recommendation) ========== */
    function updateUpNext() {
        var scores = getScores();
        var retakes = tests.filter(function(t) { return t.retake; });
        var next = null;

        // Priority 1: first practice exam with no score
        for (var i = 0; i < retakes.length; i++) {
            var s = scores[retakes[i].key];
            if (!s || !s.attempts || s.attempts.length === 0) {
                next = retakes[i];
                break;
            }
        }

        // Priority 2: lowest-scoring practice exam (below 92% / Grade 4)
        if (!next) {
            var lowest = null, lowestPct = 100;
            retakes.forEach(function(t) {
                var s = scores[t.key];
                if (s && s.attempts && s.attempts.length > 0) {
                    var last = s.attempts[s.attempts.length - 1];
                    var pct = last.pct || Math.round((last.score / last.total) * 100);
                    if (pct < lowestPct) { lowestPct = pct; lowest = t; }
                }
            });
            if (lowest && lowestPct < 92) next = lowest;
        }

        // Priority 3: all ‚â•92% ‚Äî celebrate
        if (!next) {
            document.getElementById('upNextInfo').textContent = 'All practice exams at Grade 4. You crushed it. üí™';
            var btn = document.querySelector('.nav-btn.primary');
            if (btn) { btn.textContent = 'Run It Back'; btn.href = 'exam.html?file=retake-practice-7'; }
            return;
        }

        // Show name + last score (if retrying) as motivation
        var info = next.name;
        var s = scores[next.key];
        if (s && s.attempts && s.attempts.length > 0) {
            var lastPct = s.attempts[s.attempts.length - 1].pct ||
                Math.round((s.attempts[s.attempts.length - 1].score / s.attempts[s.attempts.length - 1].total) * 100);
            info += ' ¬∑ Last: ' + lastPct + '% ‚Äî beat it.';
        }
        document.getElementById('upNextInfo').textContent = info;
        var btn = document.querySelector('.nav-btn.primary');
        if (btn) btn.href = next.file;
    }

    /* ========== INIT ========== */
    function rerenderAll() {
        buildChart();
        var stdResult = buildStandards();
        buildStudyNext(stdResult);
        buildRetakeGrid();
        buildTestGrid();
        buildStats();
        buildLast2Tests();
        updateUpNext();
    }

    function dadModeInit() {
        if (!_dadMode) return;
        document.getElementById('dadBanner').style.display = 'flex';
        fetch('data/kai-scores-2026-02-22.json')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data && data.mcm_scores) {
                    _dadScores = data.mcm_scores;
                    document.getElementById('dadStatus').textContent = 'Kai\'s scores loaded (Feb 21). Click "Update" to load a fresher file.';
                    rerenderAll();
                }
            })
            .catch(function() {
                document.getElementById('dadStatus').textContent = 'Click "Update from Kai\'s device" to load his score file.';
            });
    }

    function loadDadFile(input) {
        var file = input.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = JSON.parse(e.target.result);
                if (data && data.mcm_scores) {
                    _dadScores = data.mcm_scores;
                    var exported = data.exported
                        ? new Date(data.exported).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                        : 'unknown date';
                    document.getElementById('dadStatus').textContent = 'Kai\'s scores loaded from ' + exported + ' export.';
                    rerenderAll();
                } else {
                    alert('File missing score data. Make sure it\'s from the "Send to Dad" button.');
                }
            } catch(err) {
                alert('Could not read score file.');
            }
        };
        reader.readAsText(file);
    }

    window.addEventListener('DOMContentLoaded', function() {
        // ?restore=1 ‚Äî auto-seeds localStorage from server JSON, no file needed
        // Dad can text Kai: https://marcusash.github.io/motor-city-math/?restore=1
        var _restoreMode = new URLSearchParams(window.location.search).get('restore') === '1';
        if (_restoreMode) {
            fetch('data/kai-scores-2026-02-22.json')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data && data.mcm_scores) {
                        localStorage.setItem('mcm_scores', JSON.stringify(data.mcm_scores));
                        alert('‚úÖ Scores restored! Original exam, Practice 1 & Practice 2 are all back.');
                        window.location.href = window.location.pathname;
                    }
                })
                .catch(function() { alert('Could not load score file.'); });
            return;
        }
        dadModeInit();
        rerenderAll();
    });

    function restoreScores(input) {
        var file = input.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = JSON.parse(e.target.result);
                if (data && data.mcm_scores) {
                    localStorage.setItem('mcm_scores', JSON.stringify(data.mcm_scores));
                    alert('Scores restored. Reloading...');
                    location.reload();
                } else {
                    alert('Invalid score file. Use the "Send Scores to Dad" export.');
                }
            } catch(err) { alert('Could not read file.'); }
        };
        reader.readAsText(file);
    }

    function exportScores() {
        var data = {
            version: 1,
            exported: new Date().toISOString(),
            student: 'Kai',
            mcm_scores: null,
            mcm_srs: null,
            standardScores: null
        };

        try { data.mcm_scores = JSON.parse(localStorage.getItem('mcm_scores') || 'null'); } catch(e) {}
        try { data.mcm_srs = JSON.parse(localStorage.getItem('mcm_srs') || 'null'); } catch(e) {}
        try { data.standardScores = JSON.parse(localStorage.getItem('standardScores') || 'null'); } catch(e) {}

        if (!data.mcm_scores && !data.mcm_srs) {
            alert('Take a test first, then we\'ll send your scores! üèÄ');
            return;
        }

        var json = JSON.stringify(data, null, 2);
        var blob = new Blob([json], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'kai-scores-' + new Date().toISOString().slice(0, 10) + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    </script>
    <script src="shared/scripts.js"></script>
</body>
</html>



<!-- publish test 2026-02-21T03:35:13 -->

