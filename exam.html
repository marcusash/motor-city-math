<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="shared/favicon.svg">
    <title>Motor City Math ‚Äî Exam</title>
    <link rel="stylesheet" href="shared/katex/katex.min.css">
    <script src="shared/katex/katex.min.js"></script>
    <script src="shared/katex/auto-render.min.js"></script>
    <link rel="stylesheet" href="shared/styles.css">
    <link rel="stylesheet" href="shared/print.css" media="print">
    <style>
        .exam-container { max-width: 800px; margin: 0 auto; padding: 16px; }
        .exam-subtitle { text-align: center; color: var(--text-secondary); font-size: var(--text-sm); margin: -8px 0 16px; }
        .question-card { background: var(--bg-card); border: 1px solid var(--border-default); border-left: none; border-radius: 8px; padding: 20px 20px 20px 24px; margin-bottom: 16px; position: relative; box-shadow: var(--shadow-card); transition: border-color 0.2s; }
        .question-card.answered { border-color: var(--accent-blue); }
        .question-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid var(--border-subtle); }
        .question-number { font-weight: 800; color: var(--accent-navy); font-size: var(--text-base); letter-spacing: 0.05em; }
        .standard-badge { background: var(--bg-highlight); color: var(--accent-blue); font-size: var(--text-xs); font-weight: 700; padding: 2px 8px; border-radius: 12px; }
        .input-group { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin: 10px 0; }
        .input-group label { font-weight: 600; color: var(--text-primary); min-width: 120px; }
        .input-group input[type="number"], .input-group input[type="text"], .input-group select { padding: 8px 12px; border: 1px solid var(--border-default); border-radius: 6px; font-size: var(--text-base); background: var(--bg-input); color: var(--text-primary); width: 120px; }
        .input-group select { width: 180px; }
        .input-hint { font-size: 0.72rem; color: var(--text-secondary, #888); line-height: 1.3; margin-top: 2px; }
        .input-with-hint { display: flex; flex-direction: column; gap: 2px; }
        .radio-group { margin: 10px 0; }
        .radio-option { display: flex; align-items: center; gap: 8px; padding: 8px 12px; margin: 4px 0; border: 1px solid var(--border-subtle); border-radius: 6px; cursor: pointer; background: var(--bg-input); }
        .radio-option:hover { border-color: var(--accent-blue); }
        .radio-option input[type="radio"] { accent-color: var(--accent-blue); }
        .radio-option label { cursor: pointer; flex: 1; color: var(--text-primary); }
        .answer-feedback { display: none; padding: 8px 12px; border-radius: 6px; margin-top: 8px; font-weight: 600; font-size: var(--text-sm); }
        .answer-feedback.show { display: block; }
        .answer-feedback.correct { background: rgba(27,125,58,0.1); color: var(--color-correct); }
        .answer-feedback.incorrect { background: rgba(200,16,46,0.1); color: var(--color-incorrect); }
        .hint-layers { margin-top: 10px; }
        .hint-btn { background: var(--bg-highlight); color: var(--accent-blue); border: 1px solid var(--border-subtle); border-radius: 6px; padding: 6px 14px; cursor: pointer; font-size: var(--text-sm); margin: 4px 4px 4px 0; }
        .hint-btn:hover { background: var(--accent-blue); color: white; }
        .hint-layer { display: none; background: var(--bg-highlight); border: 1px solid var(--border-subtle); border-radius: 6px; padding: 12px; margin-top: 8px; font-size: var(--text-sm); color: var(--text-primary); }
        .hint-layer.show { display: block; }
        /* Graph */
        .graph-container { text-align: center; margin: 12px 0; position: relative; }
        .graph-container canvas { border: 1px solid var(--border-default); border-radius: 4px; max-width: 100%; cursor: crosshair; }
        .graph-controls { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin: 8px 0; }
        .graph-btn { padding: 6px 14px; border: 1px solid var(--border-default); border-radius: 6px; background: var(--bg-input); color: var(--text-primary); cursor: pointer; font-size: var(--text-sm); font-weight: 600; }
        .graph-btn:hover { border-color: var(--accent-blue); }
        .graph-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .graph-btn.check-graph { background: transparent; color: var(--accent-navy); border-color: var(--accent-navy); font-weight: 700; }
        .graph-btn.check-graph:disabled { opacity: 0.5; cursor: not-allowed; }
        .graph-counter { text-align: center; color: var(--text-secondary); font-size: var(--text-sm); margin: 4px 0; }
        .graph-result { display: none; text-align: center; font-weight: 700; padding: 8px; border-radius: 6px; margin: 8px 0; }
        .graph-result.show { display: block; }
        .graph-result.correct { background: rgba(27,125,58,0.1); color: var(--color-correct); }
        .graph-result.incorrect { background: rgba(200,16,46,0.1); color: var(--color-incorrect); }
        .graph-tooltip { position: fixed; background: var(--accent-navy); color: white; padding: 3px 8px; border-radius: 4px; font-size: var(--text-xs); pointer-events: none; display: none; z-index: 100; }
        /* Scorecard */
        .scorecard { background: var(--bg-card); border: 2px solid var(--accent-blue); border-radius: 12px; padding: 24px; margin: 24px 0; text-align: center; box-shadow: var(--shadow-card); }
        .scorecard h2 { color: var(--text-primary); margin: 0 0 8px; }
        .scorecard .score-big { font-size: var(--text-2xl); font-weight: 900; color: var(--accent-navy); }
        @keyframes grade-a-flash { 0%,100%{background:transparent} 50%{background:rgba(63,185,80,0.18)} }
        .grade-a-flash { animation: grade-a-flash 0.6s ease 1; }
        @media (prefers-reduced-motion: reduce) { .grade-a-flash { animation: none; background: rgba(63,185,80,0.18); } }
        .scorecard .score-pct { font-size: var(--text-lg); color: var(--text-secondary); margin: 4px 0 12px; }
        .saas-grade { display: inline-block; padding: 6px 20px; border-radius: 20px; font-weight: 800; font-size: var(--text-lg); color: white; }
        .saas-grade.g4 { background: var(--color-correct); }
        .saas-grade.g3 { background: var(--accent-blue); }
        .saas-grade.g2 { background: var(--color-warning); }
        .saas-grade.g1 { background: var(--color-incorrect); }
        .standards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; margin: 16px 0; text-align: left; }
        .std-card { background: var(--bg-highlight); border-radius: 8px; padding: 10px 14px; }
        .std-card .std-name { font-weight: 700; color: var(--text-primary); font-size: var(--text-sm); }
        .std-card .std-score { color: var(--text-secondary); font-size: var(--text-sm); }
        .submit-area { text-align: center; margin: 24px 0; }
        .submit-warning { background: rgba(249,115,22,0.12); border: 1px solid rgba(249,115,22,0.4); color: var(--text-primary); border-radius: 8px; padding: 12px 16px; margin-bottom: 14px; font-size: var(--text-sm); text-align: left; }
        .error-msg { text-align: center; padding: 40px; color: var(--color-incorrect); font-size: var(--text-lg); }
        /* Progress bar ‚Äî ADHD: show progress position */
        .progress-strip {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
            padding: 8px 16px;
            display: none;
            align-items: center;
            gap: 12px;
            font-size: var(--text-sm);
            color: var(--text-secondary);
            box-shadow: 0 2px 8px rgba(0,45,98,0.06);
        }
        .progress-strip.active { display: flex; }
        .progress-bar { flex: 1; height: 6px; background: var(--border-subtle); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent-blue); border-radius: 3px; transition: width 0.3s ease; }
        .progress-text { font-weight: 600; white-space: nowrap; }
        .exam-picker { text-align: center; padding: 24px 0; }
        .exam-picker p { color: var(--text-secondary); font-size: var(--text-base); margin-bottom: 20px; }
        .exam-picker-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; max-width: 600px; margin: 0 auto; }
        .exam-picker-card { display: block; text-decoration: none; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: 8px; padding: 16px; text-align: left; position: relative; box-shadow: var(--shadow-card); transition: border-color 0.15s, box-shadow 0.15s; }
        .exam-picker-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; border-radius: 8px 0 0 8px; background: linear-gradient(to bottom, var(--accent-red), var(--accent-blue), var(--accent-red)); }
        .exam-picker-card:hover { border-color: var(--accent-blue); box-shadow: 0 2px 12px rgba(0,45,98,0.12); }
        .exam-picker-card .card-title { font-weight: 700; color: var(--text-primary); font-size: var(--text-base); margin-bottom: 4px; }
        .exam-picker-card .card-desc { color: var(--text-secondary); font-size: var(--text-sm); }
        /* WCAG 2.4.7: visible focus indicator */
        :focus-visible { outline: 2px solid rgba(255,255,255,0.9); outline-offset: 2px; }
        /* Answer format guide */
        .answer-format-guide {
            font-size: var(--text-sm); color: var(--text-secondary);
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            border-radius: 6px; padding: 8px 14px; margin: 8px 0 16px; line-height: 1.5;
        }
    </style>
</head>
<body>
    <script>if(localStorage.getItem('mcm-arena-mode')==='on')document.body.classList.add('arena-mode');</script>
    <a href="#questionsContainer" class="sr-only">Skip to questions</a>
    <div class="exam-container" role="main">
        <div class="print-header">
            <strong>Motor City Math ‚Äî Practice Test</strong><br>
            Name: _____________________ Date: ___________
        </div>
        <header class="test-header">
            <a href="index.html" class="header-back" aria-label="Back to dashboard">‚Üê</a>
            <h1 id="examTitle"></h1>
        </header>
        <p class="subtitle exam-subtitle" id="examSubtitle"></p>
        <div class="answer-format-guide" id="answerFormatGuide" style="display:none">
            <strong>Answer formats:</strong> whole numbers (5 or -8) &nbsp;&middot;&nbsp; fractions (4/3) &nbsp;&middot;&nbsp; square roots (sqrt(5) or 2sqrt(3))
        </div>

        <div class="progress-strip" id="progressStrip">
            <div class="progress-text" id="progressText">0 / 15</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        </div>

        <div id="questionsContainer"></div>

        <div class="submit-area" id="submitArea" style="display:none;">
            <button class="btn-primary" onclick="gradeExam()">üìù SUBMIT & GRADE</button>
        </div>

        <div id="scorecard" style="display:none;"></div>

        <div style="text-align:center; margin: 16px 0;">
            <a href="index.html" class="nav-btn ghost" style="text-decoration:none;">‚Üê Back to Dashboard</a>
        </div>
        <div class="footer" style="text-align:center; color:var(--text-secondary); font-size:var(--text-sm); padding:10px 0;">Built with üí™üèæ by Dad ¬∑ Motor City Math</div>
    </div>

    <script src="shared/scripts.js"></script>
    <script>
    /* ========== EXAM RENDERER ========== */
    var examData = null;
    var examId = new URLSearchParams(window.location.search).get('file') || 'unknown';

    function autosave() {
        if (!examData) return;
        var state = {};
        try {
            examData.questions.forEach(function(q) {
                q.inputs.forEach(function(inp) {
                    if (inp.type === 'radio') {
                        var el = document.querySelector('input[name="' + inp.id + '"]:checked');
                        state[inp.id] = el ? el.value : '';
                    } else {
                        var el = document.getElementById(inp.id);
                        state[inp.id] = el ? el.value : '';
                    }
                });
            });
            sessionStorage.setItem('exam-autosave-' + examId, JSON.stringify(state));
        } catch(e) { /* sessionStorage full or unavailable */ }
    }

    function restoreAutosave() {
        try {
            var saved = sessionStorage.getItem('exam-autosave-' + examId);
            if (!saved) return;
            var state = JSON.parse(saved);
            examData.questions.forEach(function(q) {
                q.inputs.forEach(function(inp) {
                    if (inp.type === 'radio') {
                        if (state[inp.id]) {
                            var el = document.getElementById(inp.id + '_' + state[inp.id]);
                            if (el) el.checked = true;
                        }
                    } else {
                        var el = document.getElementById(inp.id);
                        if (el && state[inp.id]) el.value = state[inp.id];
                    }
                });
            });
        } catch(e) { /* parse error */ }
    }
    var graphData = {};
    var examGraded = false;

    // Canvas drawing constants
    var CANVAS = {
        bg: '#FFFFFF', gridMajor: '#B0B8C8', gridMinor: '#D0D5E0',
        axis: '#002D62', label: '#002D62', blue: '#1D42BA',
        correct: '#1B7D3A', incorrect: '#C8102E', pointStroke: '#FFFFFF'
    };

    /* --- URL Param + JSON Loader --- */
    (function() {
        var params = new URLSearchParams(window.location.search);
        var file = params.get('file');
        if (!file) {
            document.getElementById('examTitle').textContent = 'Pick Your Challenge üèÄ';
            document.getElementById('examSubtitle').textContent = 'Choose a test below to get started';
            var FALLBACK_EXAMS = [
                { id: 'retake-practice-1', title: 'Retake Practice 1', desc: '15 questions ¬∑ Nonlinear Functions' },
                { id: 'retake-practice-2', title: 'Retake Practice 2', desc: '15 questions ¬∑ Nonlinear Functions' },
                { id: 'retake-practice-3', title: 'Retake Practice 3', desc: '15 questions ¬∑ Nonlinear Functions' },
                { id: 'retake-practice-4', title: 'Retake Practice 4', desc: '15 questions ¬∑ Nonlinear Functions' },
                { id: 'retake-practice-5', title: 'Retake Practice 5', desc: '15 questions ¬∑ Nonlinear Functions' },
                { id: 'retake-practice-6', title: 'Retake Practice 6 (W2.b Drill)', desc: '15 questions ¬∑ W2.b Intercepts' },
                { id: 'retake-practice-7', title: 'Retake Practice 7 (Mock Retake)', desc: '15 questions ¬∑ Full Mock' },
                { id: 'retake-practice-8', title: 'Retake Practice 8', desc: '15 questions ¬∑ Nonlinear Functions' },
                { id: 'retake-practice-9', title: 'Retake Practice 9', desc: '15 questions ¬∑ Nonlinear Functions' }
            ];
            function renderPicker(exams) {
                var cards = exams.map(function(e) {
                    return '<a class="exam-picker-card" href="exam.html?file=' + e.id + '"><div class="card-title">' + e.title + '</div><div class="card-desc">' + e.desc + '</div></a>';
                }).join('');
                document.getElementById('questionsContainer').innerHTML =
                    '<div class="exam-picker">' +
                    '<div class="exam-picker-grid">' + cards + '</div>' +
                    '<p style="margin-top:20px;"><a href="index.html" class="btn-ghost">‚Üê Back to Dashboard</a></p>' +
                    '</div>';
            }
            if (typeof fetch === 'function' && window.location.protocol !== 'file:') {
                fetch('data/manifest.json').then(function(r) { return r.json(); }).then(function(m) {
                    renderPicker(m.exams || FALLBACK_EXAMS);
                }).catch(function() { renderPicker(FALLBACK_EXAMS); });
            } else {
                renderPicker(FALLBACK_EXAMS);
            }
            return;
        }

        var url = 'data/' + file + '.json';

        function showLoadError(msg) {
            document.getElementById('questionsContainer').innerHTML =
                '<div class="error-msg">' +
                '<p style="margin:0 0 16px">' + msg + '</p>' +
                '<a href="exam.html" class="btn-ghost" style="display:inline-block;margin-right:10px">‚Üê Pick a different test</a>' +
                '<button onclick="location.reload()" style="padding:8px 18px;border:1px solid var(--border-default);border-radius:6px;background:var(--bg-input);color:var(--text-primary);cursor:pointer;font-size:var(--text-sm)">Retry</button>' +
                '</div>';
        }

        // Fetch with file:// fallback
        if (typeof fetch === 'function' && window.location.protocol !== 'file:') {
            fetch(url).then(function(r) {
                if (!r.ok) throw new Error('Not found');
                return r.json();
            }).then(loadExam).catch(function() {
                showLoadError('Could not load <strong>' + file + '</strong>. Check your connection and try again.');
            });
        } else {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onload = function() {
                if (xhr.status === 200 || xhr.status === 0) {
                    try { loadExam(JSON.parse(xhr.responseText)); } catch(e) {
                        showLoadError('Error reading exam data. The file may be corrupted.');
                    }
                } else {
                    showLoadError('Could not load <strong>' + file + '</strong> (status ' + xhr.status + ').');
                }
            };
            xhr.onerror = function() {
                showLoadError('Network error loading <strong>' + file + '</strong>. Try reloading.');
            };
            xhr.send();
        }
    })();

    /* Curriculum title: "Unit X: Topic ‚Äî Standards" (Task 12) */
    function formatCurriculumTitle(data) {
        var title = data.title || '';
        var subtitle = data.subtitle || '';
        var stdMatch = subtitle.match(/Standards?\s+([^¬∑]+)/);
        var standards = stdMatch ? stdMatch[1].trim() : '';
        var parts = title.split(/\s*‚Äî\s*/);
        if (parts.length === 2 && standards) {
            var unitMatch = parts[0].match(/(Unit\s+\d+)/);
            var unit = unitMatch ? unitMatch[1] : parts[0];
            return unit + ': ' + parts[1] + ' ‚Äî ' + standards;
        }
        return title;
    }

    function loadExam(data) {
        examData = data;
        // Curriculum-based title: "Unit X: Topic ‚Äî Standards" (Task 12)
        var displayTitle = formatCurriculumTitle(data);
        document.title = displayTitle + ' ‚Äî Motor City Math';
        document.getElementById('examTitle').textContent = displayTitle;
        document.getElementById('examSubtitle').textContent = data.subtitle || '';

        // Show answer format guide if exam has any number inputs
        var hasNumberInputs = data.questions.some(function(q) {
            return q.inputs && q.inputs.some(function(i) { return i.type === 'number'; });
        });
        if (hasNumberInputs) {
            var guide = document.getElementById('answerFormatGuide');
            if (guide) guide.style.display = '';
        }

        // Timer: set data-time-minutes on header for shared/scripts.js timer
        if (data.time_minutes) {
            document.querySelector('.test-header').setAttribute('data-time-minutes', data.time_minutes);
            if (typeof initTimer === 'function') initTimer();
        }

        renderQuestions(data.questions);
        restoreAutosave();
        // Delegated autosave listener
        document.getElementById('questionsContainer').addEventListener('input', autosave);
        document.getElementById('questionsContainer').addEventListener('change', autosave);
        document.getElementById('submitArea').style.display = '';

        // Render KaTeX after DOM is populated
        if (typeof renderMathInElement === 'function') {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ]
            });
        }

        // Initialize progress tracking
        initProgress(data.questions.length);
    }

    /* --- Question Renderer --- */
    function renderQuestions(questions) {
        var container = document.getElementById('questionsContainer');
        var html = '';

        questions.forEach(function(q) {
            html += '<div class="question-card" id="card-' + q.id + '">';
            html += '<div class="question-header">';
            html += '<span class="question-number">Question ' + q.number + '</span>';
            html += '<span class="standard-badge">' + q.standard + '</span>';
            html += '</div>';
            html += '<div class="question-text">' + q.question_html + '</div>';

            // Graph canvas (if present)
            if (q.graph) {
                html += renderGraph(q);
            }

            // Input fields
            q.inputs.forEach(function(inp) {
                html += renderInput(inp, q);
            });

            // Feedback area
            html += '<div class="answer-feedback" id="feedback-' + q.id + '"></div>';

            // Hint layers
            html += '<div class="hint-layers" id="hints-' + q.id + '" style="display:none;">';
            html += '<button class="hint-btn" onclick="showHint(\'' + q.id + '\', 1)">üí° HINT</button>';
            html += '<div class="hint-layer" id="hint-' + q.id + '-1">' + (q.hint || '') + '</div>';
            html += '<button class="hint-btn" id="hintBtn-' + q.id + '-2" style="display:none;" onclick="showHint(\'' + q.id + '\', 2)">üìñ SHOW ANSWER</button>';
            html += '<div class="hint-layer" id="hint-' + q.id + '-2"></div>';
            html += '<button class="hint-btn" id="hintBtn-' + q.id + '-3" style="display:none;" onclick="showHint(\'' + q.id + '\', 3)">üìù SOLUTION STEPS</button>';
            html += '<div class="hint-layer" id="hint-' + q.id + '-3"></div>';
            html += '</div>';

            html += '</div>'; // end question-card
        });

        container.innerHTML = html;

        // Init graph canvases after DOM is built
        questions.forEach(function(q) {
            if (q.graph) initGraph(q.graph.canvas_id, q.graph);
        });
    }

    function renderInput(inp, q) {
        var html = '';
        if (inp.type === 'dropdown') {
            html += '<div class="input-group">';
            if (inp.label) html += '<label>' + inp.label + '</label>';
            html += '<select id="' + inp.id + '">';
            html += '<option value="">‚Äî Select ‚Äî</option>';
            inp.options.forEach(function(opt) {
                html += '<option value="' + opt + '">' + opt + '</option>';
            });
            html += '</select></div>';
        } else if (inp.type === 'number') {
            html += '<div class="input-group">';
            if (inp.label) html += '<label>' + inp.label + '</label>';
            html += '<div class="input-with-hint">';
            html += '<input type="text" inputmode="decimal" id="' + inp.id + '" autocomplete="off" placeholder="e.g. 3/2 or sqrt(2)">';
            html += '<span class="input-hint">decimal ¬∑ fraction (3/2) ¬∑ sqrt(2) ¬∑ 1+sqrt(3)</span>';
            html += '</div>';
            html += '</div>';
        } else if (inp.type === 'radio') {
            html += '<div class="radio-group">';
            if (inp.label) html += '<div style="font-weight:600; margin-bottom:6px; color:var(--text-primary);">' + inp.label + '</div>';
            inp.options.forEach(function(opt) {
                html += '<div class="radio-option">';
                html += '<input type="radio" name="' + inp.id + '" id="' + inp.id + '_' + opt.value + '" value="' + opt.value + '">';
                html += '<label for="' + inp.id + '_' + opt.value + '">' + opt.value + '. ' + opt.text + '</label>';
                html += '</div>';
            });
            html += '</div>';
        } else if (inp.type === 'text') {
            html += '<div class="input-group">';
            if (inp.label) html += '<label>' + inp.label + '</label>';
            html += '<input type="text" id="' + inp.id + '" style="width:200px;" autocomplete="off">';
            html += '</div>';
        }
        return html;
    }

    function renderGraph(q) {
        var g = q.graph;
        var html = '<div class="graph-container">';
        html += '<canvas id="' + g.canvas_id + '" width="500" height="500"></canvas>';
        html += '<div class="graph-tooltip" id="tooltip-' + g.canvas_id + '"></div>';
        html += '</div>';
        html += '<div class="graph-counter" id="counter-' + g.canvas_id + '">Click to plot points on the graph</div>';
        html += '<div class="graph-controls">';
        if (g.asymptotes) {
            html += '<button class="graph-btn" id="vaBtn-' + g.canvas_id + '" onclick="setAsymptoteMode(\'' + g.canvas_id + '\',\'vertical\')">ADD VERTICAL ASYMPTOTE</button>';
            html += '<button class="graph-btn" id="haBtn-' + g.canvas_id + '" onclick="setAsymptoteMode(\'' + g.canvas_id + '\',\'horizontal\')">ADD HORIZONTAL ASYMPTOTE</button>';
        }
        html += '<button class="graph-btn check-graph" id="checkBtn-' + g.canvas_id + '" disabled onclick="checkGraphAnswer(\'' + g.canvas_id + '\')">CHECK GRAPH</button>';
        html += '<button class="graph-btn" onclick="clearGraph(\'' + g.canvas_id + '\')">CLEAR</button>';
        html += '</div>';
        html += '<div class="graph-result" id="result-' + g.canvas_id + '"></div>';
        return html;
    }

    /* --- Graph Engine --- */
    function initGraph(canvasId, graphConfig) {
        var canvas = document.getElementById(canvasId);
        if (!canvas) return;
        var ctx = canvas.getContext('2d');
        var w = canvas.width, h = canvas.height;
        var ml = 40, mr = 20, mt = 20, mb = 35;
        var pw = w - ml - mr, ph = h - mt - mb;

        graphData[canvasId] = {
            canvas: canvas, ctx: ctx, config: graphConfig,
            points: [], asymptotes: { vertical: [], horizontal: [] },
            asymptoteMode: null, answerOverlay: false,
            w: w, h: h, ml: ml, mr: mr, mt: mt, mb: mb, pw: pw, ph: ph
        };

        canvas.addEventListener('mousemove', function(e) {
            var rect = canvas.getBoundingClientRect();
            var sx = Math.round((((e.clientX - rect.left) * (w / rect.width) - ml) / pw * 32 - 16) * 4) / 4;
            var sy = Math.round((-((e.clientY - rect.top) * (h / rect.height) - mt) / ph * 32 + 16) * 4) / 4;
            var tip = document.getElementById('tooltip-' + canvasId);
            if (tip) {
                tip.style.display = 'block';
                tip.textContent = '(' + sx + ', ' + sy + ')';
                tip.style.left = (e.clientX + 12) + 'px';
                tip.style.top = (e.clientY - 28) + 'px';
            }
        });

        canvas.addEventListener('mouseleave', function() {
            var tip = document.getElementById('tooltip-' + canvasId);
            if (tip) tip.style.display = 'none';
        });

        canvas.addEventListener('click', function(e) {
            var d = graphData[canvasId];
            var rect = canvas.getBoundingClientRect();
            var cx = (e.clientX - rect.left) * (w / rect.width);
            var cy = (e.clientY - rect.top) * (h / rect.height);
            var sx = Math.round(((cx - ml) / pw * 32 - 16) * 4) / 4;
            var sy = Math.round((-((cy - mt) / ph * 32 - 16)) * 4) / 4;

            if (d.asymptoteMode === 'vertical') {
                d.asymptotes.vertical = [sx];
                d.asymptoteMode = null;
                var vb = document.getElementById('vaBtn-' + canvasId);
                if (vb) vb.classList.remove('active');
                updateGraphCounter(canvasId);
                redrawGraph(canvasId);
                return;
            }
            if (d.asymptoteMode === 'horizontal') {
                d.asymptotes.horizontal = [sy];
                d.asymptoteMode = null;
                var hb = document.getElementById('haBtn-' + canvasId);
                if (hb) hb.classList.remove('active');
                updateGraphCounter(canvasId);
                redrawGraph(canvasId);
                return;
            }

            // Remove if near existing point
            for (var i = d.points.length - 1; i >= 0; i--) {
                if (Math.abs(d.points[i].gx - sx) < 0.5 && Math.abs(d.points[i].gy - sy) < 0.5) {
                    d.points.splice(i, 1);
                    updateGraphCounter(canvasId);
                    redrawGraph(canvasId);
                    return;
                }
            }
            var screenX = ml + ((sx + 16) / 32) * pw;
            var screenY = mt + ((-sy + 16) / 32) * ph;
            d.points.push({ x: screenX, y: screenY, gx: sx, gy: sy, status: null });
            updateGraphCounter(canvasId);
            redrawGraph(canvasId);
        });

        drawGrid(canvasId);
    }

    function drawGrid(canvasId) {
        var d = graphData[canvasId];
        var ctx = d.ctx;
        ctx.clearRect(0, 0, d.w, d.h);
        ctx.fillStyle = CANVAS.bg;
        ctx.fillRect(0, 0, d.w, d.h);
        var step = d.pw / 32;

        ctx.strokeStyle = CANVAS.gridMinor; ctx.lineWidth = 1;
        for (var i = 0; i <= 32; i++) {
            var x = d.ml + i * step;
            ctx.beginPath(); ctx.moveTo(x, d.mt); ctx.lineTo(x, d.mt + d.ph); ctx.stroke();
            var y = d.mt + i * step;
            ctx.beginPath(); ctx.moveTo(d.ml, y); ctx.lineTo(d.ml + d.pw, y); ctx.stroke();
        }
        ctx.strokeStyle = CANVAS.gridMajor; ctx.lineWidth = 1.5;
        for (var i2 = -15; i2 <= 15; i2 += 5) {
            if (i2 === 0) continue;
            var mx = d.ml + (i2 + 16) * step;
            ctx.beginPath(); ctx.moveTo(mx, d.mt); ctx.lineTo(mx, d.mt + d.ph); ctx.stroke();
            var my = d.mt + (16 - i2) * step;
            ctx.beginPath(); ctx.moveTo(d.ml, my); ctx.lineTo(d.ml + d.pw, my); ctx.stroke();
        }
        ctx.strokeStyle = CANVAS.axis; ctx.lineWidth = 2;
        var xAxisY = d.mt + d.ph / 2, yAxisX = d.ml + d.pw / 2;
        ctx.beginPath(); ctx.moveTo(d.ml, xAxisY); ctx.lineTo(d.ml + d.pw, xAxisY); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(yAxisX, d.mt); ctx.lineTo(yAxisX, d.mt + d.ph); ctx.stroke();

        ctx.fillStyle = CANVAS.label; ctx.font = 'bold 14px Arial'; ctx.textAlign = 'center';
        for (var n = -15; n <= 15; n += 5) {
            if (n === 0) continue;
            ctx.fillText(n, d.ml + d.pw / 2 + n * step, xAxisY + 20);
        }
        ctx.textAlign = 'right';
        for (var m = -15; m <= 15; m += 5) {
            if (m === 0) continue;
            ctx.fillText(m, yAxisX - 8, d.mt + d.ph / 2 - m * step + 5);
        }
        ctx.textAlign = 'left';
        ctx.fillText('0', yAxisX + 6, xAxisY + 18);
    }

    function redrawGraph(canvasId) {
        var d = graphData[canvasId];
        if (!d) return;
        drawGrid(canvasId);
        var ctx = d.ctx;

        // Asymptotes (dashed red)
        ctx.save();
        ctx.setLineDash([8, 6]);
        ctx.strokeStyle = CANVAS.incorrect; ctx.lineWidth = 2.5;
        d.asymptotes.vertical.forEach(function(gx) {
            var sx = d.ml + ((gx + 16) / 32) * d.pw;
            ctx.beginPath(); ctx.moveTo(sx, d.mt); ctx.lineTo(sx, d.mt + d.ph); ctx.stroke();
        });
        d.asymptotes.horizontal.forEach(function(gy) {
            var sy = d.mt + ((-gy + 16) / 32) * d.ph;
            ctx.beginPath(); ctx.moveTo(d.ml, sy); ctx.lineTo(d.ml + d.pw, sy); ctx.stroke();
        });
        ctx.restore();

        // Answer overlay curve
        if (d.answerOverlay && d.config && d.config.function) {
            try {
                var func = new Function('x', 'return ' + d.config.function);
                ctx.save();
                ctx.strokeStyle = CANVAS.blue; ctx.lineWidth = 3;
                ctx.beginPath();
                var started = false;
                for (var gx = -16; gx <= 16; gx += 0.05) {
                    var fy = func(gx);
                    if (fy === null || fy === undefined || !isFinite(fy) || fy < -16 || fy > 16) { started = false; continue; }
                    var px = d.ml + ((gx + 16) / 32) * d.pw;
                    var py = d.mt + ((-fy + 16) / 32) * d.ph;
                    if (!started) { ctx.moveTo(px, py); started = true; }
                    else ctx.lineTo(px, py);
                }
                ctx.stroke();
                ctx.restore();
            } catch(e) {}
        }

        // Points
        d.points.forEach(function(p) {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 6, 0, 2 * Math.PI);
            if (p.status === 'correct') ctx.fillStyle = CANVAS.correct;
            else if (p.status === 'incorrect') ctx.fillStyle = CANVAS.incorrect;
            else ctx.fillStyle = CANVAS.blue;
            ctx.fill();
            ctx.strokeStyle = CANVAS.pointStroke; ctx.lineWidth = 1.5;
            ctx.stroke();
        });
    }

    function updateGraphCounter(canvasId) {
        var d = graphData[canvasId];
        var cfg = d.config;
        var n = d.points.length;
        var minPts = cfg.min_points || 5;
        var counter = document.getElementById('counter-' + canvasId);
        var checkBtn = document.getElementById('checkBtn-' + canvasId);

        var ready = n >= minPts;
        if (cfg.asymptotes) {
            var va = d.asymptotes.vertical.length;
            var ha = d.asymptotes.horizontal.length;
            var needVA = cfg.asymptotes.vertical ? cfg.asymptotes.vertical.length : 0;
            var needHA = cfg.asymptotes.horizontal ? cfg.asymptotes.horizontal.length : 0;
            counter.textContent = n + ' of ' + minPts + ' points ¬∑ Asymptotes: ' + (va + ha) + '/' + (needVA + needHA);
            ready = ready && va >= needVA && ha >= needHA;
        } else {
            counter.textContent = n > 0 ? n + ' of ' + minPts + ' points' : 'Click to plot at least ' + minPts + ' points';
        }
        checkBtn.disabled = !ready;
    }

    function setAsymptoteMode(canvasId, type) {
        var d = graphData[canvasId];
        d.asymptoteMode = type;
        var vb = document.getElementById('vaBtn-' + canvasId);
        var hb = document.getElementById('haBtn-' + canvasId);
        if (vb) vb.classList.toggle('active', type === 'vertical');
        if (hb) hb.classList.toggle('active', type === 'horizontal');
    }

    function clearGraph(canvasId) {
        var d = graphData[canvasId];
        d.points = [];
        d.asymptotes = { vertical: [], horizontal: [] };
        d.asymptoteMode = null;
        d.answerOverlay = false;
        var r = document.getElementById('result-' + canvasId);
        if (r) { r.className = 'graph-result'; r.textContent = ''; }
        updateGraphCounter(canvasId);
        redrawGraph(canvasId);
    }

    function checkGraphAnswer(canvasId) {
        var d = graphData[canvasId];
        var cfg = d.config;
        var tolerance = cfg.tolerance || 0.25;
        var func;
        try { func = new Function('x', 'return ' + cfg.function); } catch(e) { return; }

        var correct = 0;
        d.points.forEach(function(p) {
            var expected = func(p.gx);
            if (expected !== null && isFinite(expected) && Math.abs(p.gy - expected) <= tolerance) {
                p.status = 'correct'; correct++;
            } else {
                p.status = 'incorrect';
            }
        });

        // Check asymptotes
        var asymOk = true;
        if (cfg.asymptotes) {
            if (cfg.asymptotes.vertical) {
                cfg.asymptotes.vertical.forEach(function(expected) {
                    if (d.asymptotes.vertical.length === 0 || Math.abs(d.asymptotes.vertical[0] - expected) > tolerance) asymOk = false;
                });
            }
            if (cfg.asymptotes.horizontal) {
                cfg.asymptotes.horizontal.forEach(function(expected) {
                    if (d.asymptotes.horizontal.length === 0 || Math.abs(d.asymptotes.horizontal[0] - expected) > tolerance) asymOk = false;
                });
            }
        }

        var allCorrect = correct === d.points.length && asymOk;
        var r = document.getElementById('result-' + canvasId);
        if (allCorrect) {
            r.className = 'graph-result show correct';
            r.textContent = 'üî• ' + correct + '/' + d.points.length + ' points correct.' + (cfg.asymptotes ? ' Asymptotes correct.' : '');
        } else {
            r.className = 'graph-result show incorrect';
            r.textContent = correct + '/' + d.points.length + ' points.' + (cfg.asymptotes ? ' Asymptotes: ' + (asymOk ? '‚úì' : '‚úó') + '.' : '') + ' Red = off.';
            d.answerOverlay = true;
        }
        redrawGraph(canvasId);

        // Store graph result on the graphData for grading
        d.gradeResult = allCorrect;
    }

    /* --- Hint System --- */
    function showHint(qId, layer) {
        var q = examData.questions.find(function(q) { return q.id === qId; });
        if (!q) return;

        var el = document.getElementById('hint-' + qId + '-' + layer);
        if (!el) return;

        if (layer === 1) {
            el.classList.add('show');
            document.getElementById('hintBtn-' + qId + '-2').style.display = 'inline-block';
        } else if (layer === 2) {
            // Show answer
            var answerText = '';
            q.inputs.forEach(function(inp) {
                if (inp.type === 'radio') {
                    var opt = inp.options.find(function(o) { return o.value === inp.answer; });
                    answerText += inp.answer + (opt ? ': ' + opt.text : '') + '<br>';
                } else {
                    answerText += (inp.label || inp.id) + ' ' + inp.answer + '<br>';
                }
            });
            el.innerHTML = answerText;
            el.classList.add('show');
            document.getElementById('hintBtn-' + qId + '-3').style.display = 'inline-block';
        } else if (layer === 3) {
            // Solution steps
            if (q.solution_steps) {
                el.innerHTML = q.solution_steps.map(function(s) { return '<p>' + s + '</p>'; }).join('');
            }
            el.classList.add('show');
        }

        // Re-render KaTeX in hint layers
        if (typeof renderMathInElement === 'function') {
            renderMathInElement(el, {
                delimiters: [{left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true}]
            });
        }
    }

    /* --- Progress Tracking (ADHD: show progress position) --- */
    function initProgress(totalQuestions) {
        var strip = document.getElementById('progressStrip');
        var fill = document.getElementById('progressFill');
        var text = document.getElementById('progressText');
        if (!strip) return;

        strip.classList.add('active');
        text.textContent = '0 / ' + totalQuestions;

        var container = document.getElementById('questionsContainer');
        container.addEventListener('input', function() {
            updateProgress(totalQuestions);
        });
        container.addEventListener('change', function() {
            updateProgress(totalQuestions);
        });
    }

    function updateProgress(total) {
        var answered = 0;
        var cards = document.querySelectorAll('.question-card');
        cards.forEach(function(card) {
            var inputs = card.querySelectorAll('input, select, textarea');
            var hasValue = false;
            inputs.forEach(function(inp) {
                if (inp.type === 'radio') {
                    if (inp.checked) hasValue = true;
                } else if (inp.value && inp.value.trim() !== '') {
                    hasValue = true;
                }
            });
            if (hasValue) {
                answered++;
                card.classList.add('answered');
            } else {
                card.classList.remove('answered');
            }
        });

        var pct = total > 0 ? Math.round((answered / total) * 100) : 0;
        var fill = document.getElementById('progressFill');
        var text = document.getElementById('progressText');
        if (fill) fill.style.width = pct + '%';
        if (text) text.textContent = answered + ' / ' + total;

        // Color shift at milestones
        if (fill) {
            if (pct >= 100) fill.style.background = 'var(--color-correct)';
            else if (pct >= 50) fill.style.background = 'var(--accent-blue)';
            else fill.style.background = 'var(--accent-blue)';
        }
    }

    /* --- Grading Engine --- */

    // Accept decimals, integers, fractions (4/3), and sqrt expressions (sqrt(2), 1+sqrt(3), (1+sqrt(5))/2)
    function parseStudentAnswer(raw) {
        if (!raw || !raw.trim()) return NaN;
        var s = raw.trim().replace(/\s/g, '');

        // Plain fraction: 4/3 or -5/2
        var fracMatch = s.match(/^(-?\d+)\/(-?\d+)$/);
        if (fracMatch) {
            var num = parseInt(fracMatch[1], 10);
            var den = parseInt(fracMatch[2], 10);
            return den === 0 ? NaN : num / den;
        }

        // Plain decimal/integer
        var plain = parseFloat(s);
        if (!isNaN(plain) && s.match(/^-?\d*\.?\d+$/)) return plain;

        // sqrt() expressions ‚Äî safe evaluator
        // Only allow digits, . + - * / ( ) and letters s,q,r,t (only valid as "sqrt")
        if (/^[0-9.\+\-\*\/\(\)sqrt]+$/.test(s)) {
            try {
                // Handle implicit multiplication: 2sqrt(3) -> 2*sqrt(3)
                var expr = s.replace(/(\d)\s*sqrt/g, '$1*sqrt').replace(/sqrt/g, 'Math.sqrt');
                var result = Function('"use strict"; return (' + expr + ')')();
                if (typeof result === 'number' && isFinite(result)) return result;
            } catch(e) { /* invalid expression ‚Äî fall through */ }
        }

        return NaN;
    }

    function gradeExam() {
        if (examGraded) return;

        // Block grading if any required field is blank
        var missing = [];
        examData.questions.forEach(function(q, qi) {
            var qLabel = 'Q' + (qi + 1);
            q.inputs.forEach(function(inp) {
                if (inp.type === 'dropdown') {
                    var el = document.getElementById(inp.id);
                    if (!el || !el.value) missing.push(qLabel + ' ‚Äî ' + (inp.label || 'Parent function'));
                } else if (inp.type === 'number') {
                    var el2 = document.getElementById(inp.id);
                    if (!el2 || el2.value.trim() === '') missing.push(qLabel + ' ‚Äî ' + (inp.label || inp.id));
                } else if (inp.type === 'radio') {
                    var sel = document.querySelector('input[name="' + inp.id + '"]:checked');
                    if (!sel) missing.push(qLabel + ' ‚Äî answer choice');
                }
            });
        });
        if (missing.length > 0) {
            var warnEl = document.getElementById('submitWarning');
            if (!warnEl) {
                warnEl = document.createElement('div');
                warnEl.id = 'submitWarning';
                warnEl.className = 'submit-warning';
                document.getElementById('submitArea').insertBefore(warnEl, document.getElementById('submitArea').firstChild);
            }
            warnEl.innerHTML = '<strong>Fill in everything before grading.</strong> Missing: ' +
                missing.join(', ') + '.';
            warnEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        examGraded = true;
        sessionStorage.removeItem('exam-autosave-' + examId);

        // Hide progress bar after grading
        var strip = document.getElementById('progressStrip');
        if (strip) strip.classList.remove('active');

        var questions = examData.questions;
        var score = 0, total = questions.length;
        var results = [];
        var stdScores = {};

        questions.forEach(function(q) {
            var qCorrect = true;
            var std = q.standard;
            if (!stdScores[std]) stdScores[std] = { correct: 0, total: 0 };
            stdScores[std].total++;

            // Check graph questions
            if (q.graph) {
                var gd = graphData[q.graph.canvas_id];
                if (!gd || !gd.gradeResult) {
                    // Auto-check graph if not checked yet
                    if (gd && gd.points.length >= (q.graph.min_points || 5)) {
                        checkGraphAnswer(q.graph.canvas_id);
                        gd = graphData[q.graph.canvas_id];
                    }
                    if (!gd || !gd.gradeResult) qCorrect = false;
                }
            }

            // Check all inputs
            var numberInputs = [];
            q.inputs.forEach(function(inp) {
                if (inp.type === 'dropdown') {
                    var el = document.getElementById(inp.id);
                    if (!el || el.value !== inp.answer) qCorrect = false;
                } else if (inp.type === 'number') {
                    var el2 = document.getElementById(inp.id);
                    var val = el2 ? parseStudentAnswer(el2.value) : NaN;
                    numberInputs.push({ el: el2, val: val, answer: inp.answer, tolerance: inp.tolerance || 0.01 });
                } else if (inp.type === 'radio') {
                    var selected = document.querySelector('input[name="' + inp.id + '"]:checked');
                    if (!selected || selected.value !== inp.answer) qCorrect = false;
                } else if (inp.type === 'text') {
                    // Text is self-graded ‚Äî skip auto-grade
                }
            });

            // Handle plus_minus: accept either ordering of number inputs
            if (q.plus_minus && numberInputs.length === 2) {
                var a = numberInputs[0], b = numberInputs[1];
                var order1 = Math.abs(a.val - a.answer) <= a.tolerance && Math.abs(b.val - b.answer) <= b.tolerance;
                var order2 = Math.abs(a.val - b.answer) <= a.tolerance && Math.abs(b.val - a.answer) <= b.tolerance;
                if (!order1 && !order2) qCorrect = false;
            } else {
                numberInputs.forEach(function(n) {
                    var ok = !isNaN(n.val) && Math.abs(n.val - n.answer) <= n.tolerance;
                    if (!ok) qCorrect = false;
                    if (n.el) {
                        n.el.style.borderColor = ok ? 'var(--color-correct, #3FB950)' : 'var(--color-incorrect, #F85149)';
                        n.el.style.borderWidth = '2px';
                        n.el.style.borderStyle = 'solid';
                    }
                });
            }

            if (qCorrect) {
                score++;
                stdScores[std].correct++;
            }
            results.push(qCorrect);

            // Show feedback
            var fb = document.getElementById('feedback-' + q.id);
            if (fb) {
                var msg = qCorrect ? (q.feedback_correct || 'üî• Correct!') : (q.feedback_wrong || 'Review the hint.');
                // Graph+vertex split: if graph failed but all number inputs were correct, say so
                if (!qCorrect && q.graph && numberInputs.length > 0) {
                    var allInputsCorrect = numberInputs.every(function(n) {
                        return !isNaN(n.val) && Math.abs(n.val - n.answer) <= n.tolerance;
                    });
                    if (allInputsCorrect) {
                        msg = 'Graph points need work ‚Äî but your vertex is correct. Check the plotted points.';
                    }
                }
                // Check for specific wrong feedback variants
                if (!qCorrect) {
                    if (q.feedback_wrong_parent || q.feedback_wrong_intercepts) {
                        var parentInp = q.inputs.find(function(i) { return i.id.indexOf('_parent') !== -1; });
                        var parentEl = parentInp ? document.getElementById(parentInp.id) : null;
                        if (parentEl && parentInp) {
                            if (parentEl.value === parentInp.answer && q.feedback_wrong_intercepts) {
                                msg = q.feedback_wrong_intercepts;
                            } else if (q.feedback_wrong_parent) {
                                msg = q.feedback_wrong_parent;
                            }
                        }
                    }
                }
                fb.className = 'answer-feedback show ' + (qCorrect ? 'correct' : 'incorrect');
                // Append format hint if any number input has a non-integer answer
                if (!qCorrect) {
                    var hasNonIntAnswer = numberInputs.some(function(n) {
                        return typeof n.answer === 'number' && n.answer % 1 !== 0;
                    });
                    if (hasNonIntAnswer) msg += ' (Accepted: whole numbers, fractions like 4/3, square roots like sqrt(5))';
                }
                fb.textContent = msg;
            }

            // Show hints on wrong answers
            if (!qCorrect) {
                var hints = document.getElementById('hints-' + q.id);
                if (hints) hints.style.display = '';
            }
        });

        // Show scorecard
        showScorecard(score, total, stdScores, results);

        // Save to localStorage
        saveResults(score, total, results, stdScores);

        // Hide submit button
        document.getElementById('submitArea').style.display = 'none';

        // Scroll to scorecard
        document.getElementById('scorecard').scrollIntoView({ behavior: 'smooth' });
    }

    function showScorecard(score, total, stdScores, results) {
        var pct = Math.round((score / total) * 100);
        var grade = pct >= 92 ? 4 : pct >= 82 ? 3 : pct >= 70 ? 2 : 1;
        var gradeClass = 'g' + grade;

        // Coach voice message based on grade
        var coachMsg = '';
        if (grade === 4) coachMsg = 'Grade 4. That\'s the standard. You earned it. üí™';
        else if (grade === 3) coachMsg = 'Almost there. A few more right and you\'re at Grade 4. üèÄ';
        else if (grade === 2) coachMsg = 'Good start. Review the hints below and run it back. üîÑ';
        else coachMsg = 'Rough one. Check the hints, study the gaps, then come back stronger. üí™';

        var html = '<div class="scorecard">';
        html += '<h2>You got ' + score + ' out of ' + total + '</h2>';
        html += '<div class="score-big" id="scoreBigEl">0%</div>';
        html += '<div class="saas-grade ' + gradeClass + '">Grade ' + grade + '</div>';
        html += '<p style="margin-top:12px; color:var(--text-secondary); font-size:var(--text-sm);">' + coachMsg + '</p>';

        // Per-standard breakdown
        html += '<h3 style="margin-top:20px; color:var(--text-primary);">Your Game Plan</h3>';
        html += '<div class="standards-grid">';
        var stdKeys = Object.keys(stdScores).sort();
        stdKeys.forEach(function(std) {
            var s = stdScores[std];
            var sPct = s.total > 0 ? Math.round((s.correct / s.total) * 100) : 0;
            var icon = sPct >= 85 ? '‚úÖ' : sPct >= 60 ? 'üèÄ' : sPct > 0 ? 'üéØ' : '‚¨ú';
            html += '<div class="std-card">';
            html += '<div class="std-name">' + icon + ' ' + std + '</div>';
            html += '<div class="std-score">' + s.correct + '/' + s.total + ' (' + sPct + '%)</div>';
            html += '</div>';
        });
        html += '</div>';

        // CTA: practice exams get "Run It Back"; real exams lock after grading
        var isRetake = examData && examData.exam_id && examData.exam_id.indexOf('retake') !== -1;
        if (grade >= 3 || !isRetake) {
            html += '<div style="margin-top:16px;"><a href="index.html" class="nav-btn primary" style="text-decoration:none;">üèÄ Back to Dashboard</a></div>';
            if (!isRetake && grade < 3) {
                html += '<p style="margin-top:10px; color:var(--text-secondary); font-size:var(--text-sm);">Score locked. Study the hints above, then hit the practice tests. üí™</p>';
            }
        } else {
            html += '<div style="margin-top:16px;"><a href="javascript:location.reload()" class="nav-btn primary" style="text-decoration:none;">üîÑ Run It Back</a>';
            html += ' <a href="index.html" class="nav-btn ghost" style="text-decoration:none; margin-left:8px;">‚Üê Dashboard</a></div>';
        }
        html += '</div>';

        document.getElementById('scorecard').innerHTML = html;
        // Animate score reveal
        (function() {
            var el = document.getElementById('scoreBigEl');
            if (!el) return;
            var prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (prefersReduced) {
                el.textContent = pct + '%';
                if (pct >= 93) {
                    el.classList.add('grade-a-flash');
                    document.dispatchEvent(new CustomEvent('mcm:scoreReveal', { detail: { pct: pct, grade: grade } }));
                }
                return;
            }
            var start = null, dur = 600;
            function step(ts) {
                if (!start) start = ts;
                var prog = Math.min((ts - start) / dur, 1);
                el.textContent = Math.round(prog * pct) + '%';
                if (prog < 1) requestAnimationFrame(step);
                else {
                    el.textContent = pct + '%';
                    if (pct >= 93) {
                        el.classList.add('grade-a-flash');
                        document.dispatchEvent(new CustomEvent('mcm:scoreReveal', { detail: { pct: pct, grade: grade } }));
                    }
                }
            }
            requestAnimationFrame(step);
        })();
        document.getElementById('scorecard').style.display = '';
    }

    function saveResults(score, total, results, stdScores) {
        var pct = Math.round((score / total) * 100);
        var grade = pct >= 92 ? 4 : pct >= 82 ? 3 : pct >= 70 ? 2 : 1;
        var storageKey = 'mcm-' + examData.exam_id;

        // Build per-question results
        var qResults = {};
        examData.questions.forEach(function(q, i) {
            qResults[q.id] = { correct: results[i], type: q.type, standard: q.standard };
        });

        var attempt = {
            score: score, total: total, pct: pct, grade: grade,
            sections: {},
            questions: qResults,
            timestamp: new Date().toISOString()
        };

        // Build section scores
        examData.questions.forEach(function(q, i) {
            var sec = q.section;
            if (!attempt.sections[sec]) attempt.sections[sec] = { score: 0, total: 0 };
            attempt.sections[sec].total++;
            if (results[i]) attempt.sections[sec].score++;
        });

        try {
            var scores = JSON.parse(localStorage.getItem('mcm_scores') || '{}');
            if (!scores[storageKey]) scores[storageKey] = { attempts: [], best: null };
            // Real exams (not retake practice): lock after first attempt. Score of truth = first submission.
            var isRetakeExam = storageKey.indexOf('retake') !== -1;
            if (!isRetakeExam && scores[storageKey].attempts.length > 0) {
                return; // Score already recorded, do not overwrite
            }
            scores[storageKey].attempts.push(attempt);
            if (!scores[storageKey].best || pct > scores[storageKey].best.pct) {
                scores[storageKey].best = { score: score, pct: pct, grade: grade };
            }
            localStorage.setItem('mcm_scores', JSON.stringify(scores));
        } catch(e) {}

        // standardScores are now derived from attempts[].questions in the dashboard
        // Removed: additive accumulator that never reset, causing score inflation

        // LPM stub
        if (typeof MCM_LPM !== 'undefined' && MCM_LPM.recordResults) {
            try { MCM_LPM.recordResults(examData.exam_id, results, stdScores); } catch(e) {}
        }
    }
    </script>
</body>
</html>
