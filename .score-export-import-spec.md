# Score Export/Import ‚Äî Implementation Spec for Agent A

> Written by: Agent FA (Staff Engineer)
> Date: Feb 18, 2026
> Status: Ready for implementation
> Review: Agent A must submit implementation summary + code diff for FA review before merging

---

## Overview

Kai takes tests on GitHub Pages. Scores save to `localStorage` in his browser. Marcus can't see them. We need:
1. **Export button** on Kai's dashboard (`index.html`) ‚Äî downloads a JSON file
2. **Import button** on Marcus's parent dashboard (`parent.html`) ‚Äî reads that JSON and loads the data

No server. No accounts. Kai exports, texts/emails the file to Marcus, Marcus imports.

---

## Task 1: Export (index.html)

### What to build

A "üì§ Send Scores to Dad" button that downloads all MCM data as a JSON file.

### Placement

Add between the existing `<div class="stats-bar">` and `<div class="footer">` (around line 195-196):

```html
<div style="text-align:center; margin: 16px 0 8px;">
    <button class="nav-btn secondary" onclick="exportScores()">üì§ Send Scores to Dad</button>
</div>
```

### JavaScript function

Add `exportScores()` inside the existing `<script>` block:

```javascript
function exportScores() {
    var data = {
        version: 1,
        exported: new Date().toISOString(),
        student: 'Kai',
        mcm_scores: null,
        mcm_srs: null,
        standardScores: null
    };

    try { data.mcm_scores = JSON.parse(localStorage.getItem('mcm_scores') || 'null'); } catch(e) {}
    try { data.mcm_srs = JSON.parse(localStorage.getItem('mcm_srs') || 'null'); } catch(e) {}
    try { data.standardScores = JSON.parse(localStorage.getItem('standardScores') || 'null'); } catch(e) {}

    if (!data.mcm_scores && !data.mcm_srs) {
        alert('No scores to export yet. Take a test first!');
        return;
    }

    var json = JSON.stringify(data, null, 2);
    var blob = new Blob([json], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'kai-scores-' + new Date().toISOString().slice(0, 10) + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
```

### Requirements
- [ ] Button visible in both light and dark (Arena) mode
- [ ] Downloads file named `kai-scores-YYYY-MM-DD.json`
- [ ] File contains `version`, `exported`, `mcm_scores`, `mcm_srs`, `standardScores`
- [ ] Shows alert if no scores exist yet
- [ ] No external dependencies ‚Äî pure JS Blob API

---

## Task 2: Import (parent.html)

### What to build

A "üì• Import Kai's Scores" button that reads an exported JSON file and merges data into `localStorage`.

### Placement

Add between the "‚Üê Back to Dashboard" link and the footer (around line 184-186):

```html
<div style="text-align:center; margin: 16px 0 8px;">
    <button class="nav-btn secondary" onclick="document.getElementById('importFile').click()">üì• Import Kai's Scores</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importScores(this)">
    <div id="importStatus" style="margin-top:8px; font-size:0.9em; color:var(--text-secondary);"></div>
</div>
```

### JavaScript function

Add `importScores()` inside the existing `<script>` block:

```javascript
function importScores(input) {
    var file = input.files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var data = JSON.parse(e.target.result);
        } catch(err) {
            document.getElementById('importStatus').textContent = '‚ùå Invalid file ‚Äî not valid JSON.';
            return;
        }

        // Validate structure
        if (!data.mcm_scores && !data.mcm_srs) {
            document.getElementById('importStatus').textContent = '‚ùå No score data found in this file.';
            return;
        }

        var imported = 0;

        // Merge mcm_scores (keep newest timestamp per test)
        if (data.mcm_scores) {
            var existing = {};
            try { existing = JSON.parse(localStorage.getItem('mcm_scores') || '{}'); } catch(e) {}

            var keys = Object.keys(data.mcm_scores);
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var incoming = data.mcm_scores[key];
                var current = existing[key];

                if (!current || !current.timestamp || (incoming.timestamp && incoming.timestamp > current.timestamp)) {
                    existing[key] = incoming;
                    imported++;
                }
            }
            localStorage.setItem('mcm_scores', JSON.stringify(existing));
        }

        // Merge standardScores (additive ‚Äî sum correct/total per standard)
        if (data.standardScores) {
            var existingStd = {};
            try { existingStd = JSON.parse(localStorage.getItem('standardScores') || '{}'); } catch(e) {}

            var skeys = Object.keys(data.standardScores);
            for (var j = 0; j < skeys.length; j++) {
                var sid = skeys[j];
                var inc = data.standardScores[sid];
                if (!existingStd[sid]) {
                    existingStd[sid] = inc;
                } else {
                    existingStd[sid].correct = (existingStd[sid].correct || 0) + (inc.correct || 0);
                    existingStd[sid].total = (existingStd[sid].total || 0) + (inc.total || 0);
                    if (inc.name) existingStd[sid].name = inc.name;
                }
            }
            localStorage.setItem('standardScores', JSON.stringify(existingStd));
        }

        // Replace mcm_srs if incoming is newer (by session count)
        if (data.mcm_srs && data.mcm_srs.version === 1) {
            var existingSrs = null;
            try { existingSrs = JSON.parse(localStorage.getItem('mcm_srs')); } catch(e) {}

            if (!existingSrs || !existingSrs.sessions ||
                (data.mcm_srs.sessions && data.mcm_srs.sessions.length > (existingSrs.sessions || []).length)) {
                localStorage.setItem('mcm_srs', JSON.stringify(data.mcm_srs));
            }
        }

        var dateStr = data.exported ? new Date(data.exported).toLocaleDateString() : 'unknown date';
        document.getElementById('importStatus').textContent =
            '‚úÖ Imported ' + imported + ' test score' + (imported !== 1 ? 's' : '') + ' from ' + dateStr;

        // Reset file input so same file can be re-imported
        input.value = '';

        // Reload after brief delay so user sees the success message
        setTimeout(function() { location.reload(); }, 1500);
    };

    reader.readAsText(file);
}
```

### Requirements
- [ ] Button visible in both light and dark mode
- [ ] Hidden `<input type="file" accept=".json">` triggered by button click
- [ ] Validates JSON structure ‚Äî shows error if invalid or missing data
- [ ] **Smart merge for mcm_scores**: per test key, keeps the entry with the latest `timestamp`
- [ ] **Replace for standardScores**: incoming data overwrites local (imported data is the complete picture from Kai's browser ‚Äî no additive merge needed)
- [ ] **SRS replacement**: replaces only if incoming has more sessions
- [ ] Shows success message with count and date
- [ ] Reloads page after 1.5s so charts re-render with imported data
- [ ] No external dependencies

---

## Task 3: Fix parent.html footer color (while you're in the file)

The footer on parent.html uses `color: var(--border-default)` ‚Äî same bug we fixed on index.html. Change it:

```html
<!-- Line ~186, change: -->
<div style="text-align:center; color:var(--border-default); ...">
<!-- To: -->
<div style="text-align:center; color:var(--text-secondary); ...">
```

---

## Verification Checklist (Agent A must complete ALL before requesting review)

### Pre-flight
- [ ] Read `index.html` lines 190-200 (placement area) ‚Äî note current line count
- [ ] Read `parent.html` lines 180-190 (placement area) ‚Äî note current line count
- [ ] Run `git status` ‚Äî confirm clean working tree

### After implementation
- [ ] `git diff --stat` ‚Äî only `index.html` and `parent.html` should show changes
- [ ] Line counts: `index.html` increased by ~25 lines, `parent.html` increased by ~55 lines
- [ ] Open `index.html` in Chrome ‚Äî verify export button visible
- [ ] Toggle Arena Mode ‚Äî verify button visible in dark mode
- [ ] Click "Send Scores to Dad" with no scores ‚Äî should show alert
- [ ] Take a quick test, grade it, go back to dashboard, click export ‚Äî should download JSON
- [ ] Open the JSON file ‚Äî verify it has `version`, `exported`, `mcm_scores` keys
- [ ] Open `parent.html` ‚Äî verify import button visible
- [ ] Toggle Arena Mode on parent.html ‚Äî verify button visible in dark mode
- [ ] Click "Import Kai's Scores" ‚Äî select the exported JSON file
- [ ] Verify success message appears with correct count and date
- [ ] Verify page reloads and charts show the imported data
- [ ] Try importing the same file again ‚Äî should NOT create duplicate scores
- [ ] Try importing a non-JSON file ‚Äî should show error message

### Self-review (write this up before requesting FA review)
- [ ] List every file you changed and why
- [ ] Confirm no hardcoded hex values added
- [ ] Confirm button styling uses existing CSS classes (`.nav-btn`, `.secondary`)
- [ ] Confirm all localStorage reads are wrapped in try/catch
- [ ] Confirm merge logic handles: empty localStorage, missing timestamps, re-imports
- [ ] Note anything you changed from this spec and explain why

---

## What This Tests (Staff Engineering Skills)

This task is a training exercise. FA will evaluate:

1. **Did you follow the spec exactly, or did you deviate?** Deviations are fine IF you document why.
2. **Did you complete the verification checklist?** Every box.
3. **Did you write a self-review?** Quality matters ‚Äî did you catch issues before FA did?
4. **Did you check both themes?** Light AND Arena Mode.
5. **Did you only touch the two files?** `git diff --stat` should show exactly 2 files.
6. **Is the merge logic correct?** This is the hardest part ‚Äî think about edge cases.

---

_After completing implementation, post your full self-review and `git diff` in `.agent-status.md` under your section. Tag it "Ready for FA Review." Do NOT tell Marcus it's done until FA signs off._
