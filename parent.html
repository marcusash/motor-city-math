<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="shared/favicon.svg">
    <title>Motor City Math ‚Äî Parent Dashboard</title>
    <link rel="stylesheet" href="shared/styles.css">
    <link rel="stylesheet" href="shared/print.css">
    <link rel="stylesheet" href="shared/katex/katex.min.css">
    <script src="shared/chart.min.js"></script>
    <script>if(typeof Chart==="undefined"){var s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/chart.js";document.head.appendChild(s);}</script>
    <script src="shared/chart-theme.js"></script>
    <script src="shared/scripts.js"></script>
    <style>
        /* Parent-specific overrides (uses shared .container + header from styles.css) */
        .back-link {
            display: inline-block;
            color: var(--accent-blue);
            font-size: 0.85em;
            text-decoration: none;
            margin-bottom: 8px;
        }
        .back-link:hover { text-decoration: underline; }

        .section-title {
            color: var(--accent-navy);
            font-weight: 700;
            font-size: 1.15em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 24px 0 10px;
        }

        .pistons-stripe {
            height: 4px;
            background: linear-gradient(90deg, var(--accent-red) 30%, var(--accent-blue) 50%, var(--accent-red) 70%);
            border-radius: 2px;
            margin: 16px 0 0;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-card);
        }

        /* Latest test */
        .latest-test-name { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; }
        .latest-score { font-size: 2.5em; font-weight: 700; color: var(--accent-navy); line-height: 1.1; }
        .latest-detail { font-size: 0.95em; color: var(--text-secondary); margin-top: 4px; }
        .latest-voice { font-size: 0.95em; margin-top: 8px; color: var(--text-primary); }
        .card.passing-card {
            background: linear-gradient(135deg, var(--accent-navy) 0%, var(--accent-blue) 100%);
            color: var(--text-inverse);
            border: none;
        }
        .card.passing-card .latest-test-name,
        .card.passing-card .latest-detail { opacity: 0.8; }
        .card.passing-card .latest-score,
        .card.passing-card .latest-voice { color: var(--text-inverse); }

        /* Summary stats */
        .stat-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.95em; }
        .stat-label { color: var(--text-secondary); }
        .stat-value { color: var(--text-primary); font-weight: 600; }

        /* Chart containers */
        .chart-wrap { position: relative; height: 220px; }
        .chart-wrap.time-chart { height: 150px; }

        /* Standards grid */
        .std-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .std-item {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            padding: 12px;
        }
        .std-head { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; }
        .std-name { font-weight: 600; color: var(--text-primary); font-size: 0.9em; }
        .std-pct { font-weight: 700; font-size: 1.1em; }
        .std-bar { height: 8px; background: var(--border-subtle); border-radius: 4px; overflow: hidden; }
        .std-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
        .std-fraction { font-size: 0.8em; color: var(--text-secondary); margin-top: 4px; }

        /* Color tiers */
        .tier-green .std-pct { color: var(--color-correct); }
        .tier-green .std-fill { background: var(--color-correct); }
        .tier-blue .std-pct { color: var(--accent-blue); }
        .tier-blue .std-fill { background: var(--accent-blue); }
        .tier-amber .std-pct { color: var(--color-warning); }
        .tier-amber .std-fill { background: var(--color-warning); }
        .tier-red .std-pct { color: var(--accent-red); }
        .tier-red .std-fill { background: var(--accent-red); }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        .empty-state .icon { font-size: 2.5em; margin-bottom: 12px; }

        /* Two-column layout */
        .two-col { margin-bottom: 8px; }

        /* Desktop two-column */
        @media (min-width: 768px) {
            .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
            .chart-wrap { height: 260px; }
            .chart-wrap.time-chart { height: 200px; }
            .std-grid { grid-template-columns: repeat(3, 1fr); }
        }

        @media print { .container { display: none; } }
    </style>
</head>
<body>
    <a href="#main" class="sr-only">Skip to content</a>
    <div class="container" role="main" id="main">
        <header>
            <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
            <h1>Motor City Math</h1>
            <div class="subtitle">Parent Dashboard ¬∑ Kai's Progress</div>
            <div class="pistons-stripe"></div>
        </header>

        <div id="emptyState" class="empty-state" style="display:none;">
            <div class="icon">üèÄ</div>
            <p><strong>No scores yet.</strong></p>
            <p>Kai hasn't taken any scored tests yet.</p>
            <a href="index.html" class="submit-btn" style="display:inline-block; margin-top:16px; text-decoration:none;">‚Üê Take a Test</a>
        </div>

        <div id="mainContent" style="display:none;">
            <!-- Latest Test + Summary (two-col on desktop) -->
            <div class="two-col">
                <div>
                    <div class="section-title">Latest Test</div>
                    <div class="card" id="latestCard">
                        <div class="latest-test-name" id="latestName"></div>
                        <div class="latest-score" id="latestScore"></div>
                        <div class="latest-detail" id="latestDetail"></div>
                        <div class="latest-voice" id="latestVoice"></div>
                    </div>
                </div>
                <div>
                    <div class="section-title">Summary</div>
                    <div class="card" id="summaryCard"></div>
                </div>
            </div>

            <!-- Score Trend + Time Spent (two-col on desktop) -->
            <div class="two-col">
                <div>
                    <div class="section-title">Score Trend</div>
                    <div class="card">
                        <div class="chart-wrap">
                            <canvas id="trendChart" aria-label="Score trend chart" role="img"></canvas>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="section-title">Time Spent</div>
                    <div class="card">
                        <div class="chart-wrap time-chart">
                            <canvas id="timeChart" aria-label="Time spent per test" role="img"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Standards -->
            <div class="section-title">Standards</div>
            <div class="std-grid" id="standardsGrid"></div>
        </div>

        <div style="text-align:center; margin-top:24px;">
            <a href="index.html" style="color:var(--accent-blue); font-weight:600; text-decoration:none; font-size:0.95em;">‚Üê Back to Dashboard</a>
        </div>
        <div style="text-align:center; margin: 16px 0 8px;">
            <button class="nav-btn secondary" onclick="document.getElementById('importFile').click()">üì• Import Kai's Scores</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importScores(this)">
            <div id="importStatus" style="margin-top:8px; font-size:0.9em; color:var(--text-secondary);"></div>
        </div>
        <div style="text-align:center; color:var(--text-secondary); font-size:0.85em; padding:20px 0 10px;">Built with üí™üèæ by Dad ¬∑ Motor City Math</div>

    </div>

    <script>
    // Init arena mode toggle
    if (typeof initArenaToggle === 'function') initArenaToggle();
    /* ========== TEST REGISTRY ========== */
    var testRegistry = {
        'mcm-quiz-1117': {name: 'Quiz 11/17', file: 'quiz_251117.html', questions: 4},
        'mcm-quiz-1120': {name: 'Quiz 11/20', file: 'quiz_251120.html', questions: 5},
        'mcm-quiz-1121': {name: 'Quiz 11/21', file: 'quiz_251121.html', questions: 7},
        'mcm-index-results': {name: 'Linear Functions', file: 'linear_functions_test.html', questions: 14},
        'mcm-index-calc': {name: 'Linear + Calc', file: 'index_calc.html', questions: 16},
        'mcm-nonlinear-test': {name: 'Nonlinear Functions', file: 'nonlinear_functions_test.html', questions: 7},
        'mcm-exponents-exam': {name: 'Exponents Exam', file: 'exponents_exam.html', questions: 6},
        'mcm-unit1-v1': {name: 'Exponents Unit 1 v1', file: '20260119_Exponents_Unit1.html', questions: 17},
        'mcm-unit1-v2': {name: 'Exponents Unit 1 v2', file: '20260119_Exponents_Unit1_2nd.html', questions: 17},
        'mcm-unit1-v3': {name: 'Exponents Unit 1 v3', file: '20260119_Exponents_Unit1_3rd.html', questions: 17},
        'mcm-final-exam': {name: 'Final Exam', file: 'final_exam_251123.html', questions: 20},
        'mcm-final-mini': {name: 'Final Exam Mini', file: 'final_exam_251123_mini.html', questions: 8},
        'mcm-unit2-nonlinear-review': {name: 'Unit 2 Review', file: 'unit2_nonlinear_review.html', questions: 26},
        'mcm-mvp-nonlinear': {name: 'Nonlinear Exam MVP', file: 'nonlinear_exam_mvp.html', questions: 15}
    };

    /* ========== DATA HELPERS ========== */
    function getScores() {
        try { return JSON.parse(localStorage.getItem('mcm_scores') || '{}'); } catch(e) { return {}; }
    }

    function getStandardScores() {
        try { return JSON.parse(localStorage.getItem('standardScores') || '{}'); } catch(e) { return {}; }
    }

    /** Extract a flat entry from simple or MVP format */
    function resolveEntry(entry) {
        if (!entry) return null;
        if (entry.attempts && entry.attempts.length > 0) {
            var latest = entry.attempts[entry.attempts.length - 1];
            return {
                score: latest.score,
                total: latest.total,
                pct: latest.pct != null ? latest.pct : Math.round((latest.score / latest.total) * 100),
                timestamp: latest.timestamp || entry.timestamp,
                time: latest.time || entry.time || null
            };
        }
        return {
            score: entry.score,
            total: entry.total,
            pct: entry.pct != null ? entry.pct : (entry.score && entry.total ? Math.round((entry.score / entry.total) * 100) : 0),
            timestamp: entry.timestamp || null,
            time: entry.time || null
        };
    }

    /** Build sorted list of all completed tests */
    function getCompletedTests(scores) {
        var results = [];
        var keys = Object.keys(scores);
        for (var i = 0; i < keys.length; i++) {
            var key = keys[i];
            var entry = resolveEntry(scores[key]);
            if (!entry) continue;
            var reg = testRegistry[key];
            results.push({
                key: key,
                name: reg ? reg.name : key,
                score: entry.score,
                total: entry.total,
                pct: entry.pct,
                timestamp: entry.timestamp,
                time: entry.time
            });
        }
        // Sort by timestamp ascending
        results.sort(function(a, b) {
            if (!a.timestamp) return -1;
            if (!b.timestamp) return 1;
            return new Date(a.timestamp) - new Date(b.timestamp);
        });
        return results;
    }

    function formatDate(ts) {
        if (!ts) return '';
        var d = new Date(ts);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function formatMinutes(time) {
        if (time == null) return null;
        if (typeof time === 'number') return Math.round(time / 60);
        if (typeof time === 'string') {
            var parts = time.split(':');
            if (parts.length >= 2) return parseInt(parts[0], 10);
            return Math.round(parseInt(time, 10) / 60);
        }
        return null;
    }

    /* ========== VOICE COPY (parent voice) ========== */
    function getVoiceCopy(tests) {
        if (tests.length === 0) return '';
        var latest = tests[tests.length - 1];
        if (tests.length === 1) return 'üìù First test done. ' + latest.pct + '%.';

        // Check if all scores ‚â• 90
        var allHigh = tests.every(function(t) { return t.pct >= 90; });
        if (allHigh) return 'üí™ Strong across the board.';

        // Trend: compare last 3 or last 2
        var recent = tests.slice(-3);
        if (recent.length >= 2) {
            var first = recent[0].pct;
            var last = recent[recent.length - 1].pct;
            var diff = last - first;
            if (diff > 5) return 'üìà Trending up. ' + latest.pct + '% latest.';
            if (diff < -5) return 'üìâ Dropped from ' + first + '% to ' + last + '%.';
            return '‚û°Ô∏è Holding at ' + latest.pct + '%. Consistent.';
        }
        return 'üìà Trending up. ' + latest.pct + '% latest.';
    }

    /* ========== LATEST TEST CARD ========== */
    function buildLatestTest(completed) {
        var card = document.getElementById('latestCard');
        if (completed.length === 0) return;

        var latest = completed[completed.length - 1];
        var isPassing = latest.pct >= 90;
        if (isPassing) card.classList.add('passing-card');

        document.getElementById('latestName').textContent = latest.name + (latest.timestamp ? ' ¬∑ ' + formatDate(latest.timestamp) : '');
        document.getElementById('latestScore').textContent = latest.pct + '%';

        var detail = latest.score + '/' + latest.total;
        var mins = formatMinutes(latest.time);
        if (mins) detail += ' ¬∑ ' + mins + ' min';
        document.getElementById('latestDetail').textContent = detail;
        document.getElementById('latestVoice').textContent = getVoiceCopy(completed);
    }

    /* ========== SUMMARY STATS ========== */
    function buildSummary(completed) {
        var card = document.getElementById('summaryCard');
        if (completed.length === 0) return;

        var totalPct = 0, totalTime = 0, timeCount = 0, bestPct = 0, bestName = '';
        for (var i = 0; i < completed.length; i++) {
            totalPct += completed[i].pct;
            if (completed[i].pct > bestPct) {
                bestPct = completed[i].pct;
                bestName = completed[i].name;
            }
            var mins = formatMinutes(completed[i].time);
            if (mins) { totalTime += mins; timeCount++; }
        }

        var avgPct = Math.round(totalPct / completed.length);
        var avgTime = timeCount > 0 ? Math.round(totalTime / timeCount) : null;

        // Guess current unit from latest test name
        var latestName = completed[completed.length - 1].name;
        var unit = 'Unknown';
        if (/nonlinear|unit\s*2/i.test(latestName)) unit = 'Nonlinear';
        else if (/exponent|unit\s*1/i.test(latestName)) unit = 'Exponents';
        else if (/linear|calc/i.test(latestName)) unit = 'Linear';
        else if (/final/i.test(latestName)) unit = 'Final';
        else if (/quiz/i.test(latestName)) unit = 'Quizzes';

        var html = '';
        html += '<div class="stat-row"><span class="stat-label">Tests taken</span><span class="stat-value">' + completed.length + '</span></div>';
        html += '<div class="stat-row"><span class="stat-label">Average score</span><span class="stat-value">' + avgPct + '%</span></div>';
        if (avgTime) html += '<div class="stat-row"><span class="stat-label">Average time</span><span class="stat-value">' + avgTime + ' min</span></div>';
        html += '<div class="stat-row"><span class="stat-label">Best score</span><span class="stat-value">' + bestPct + '% (' + bestName + ')</span></div>';
        html += '<div class="stat-row"><span class="stat-label">Current unit</span><span class="stat-value">' + unit + '</span></div>';
        card.innerHTML = html;
    }

    /* ========== SCORE TREND CHART ========== */
    function buildTrendChart(completed) {
        if (completed.length === 0) return;
        var ctx = document.getElementById('trendChart').getContext('2d');

        // Group by unit for multi-series
        var unitMap = {};
        var allLabels = [];
        for (var i = 0; i < completed.length; i++) {
            var t = completed[i];
            var uname = guessUnit(t.key, t.name);
            if (!unitMap[uname]) unitMap[uname] = [];
            unitMap[uname].push({ label: shortName(t.name), pct: t.pct, index: i });
            allLabels.push(shortName(t.name));
        }

        var unitNames = Object.keys(unitMap);
        var cs = getComputedStyle(document.body);
        var colors = [
            cs.getPropertyValue('--accent-blue').trim() || '#1D42BA',
            cs.getPropertyValue('--accent-red').trim() || '#C8102E',
            cs.getPropertyValue('--accent-navy').trim() || '#002D62',
            cs.getPropertyValue('--color-correct').trim() || '#1B7D3A',
            cs.getPropertyValue('--color-warning').trim() || '#E8A317',
            cs.getPropertyValue('--border-default').trim() || '#C8CCD8'
        ];

        // Single-series if only one unit
        var datasets;
        if (unitNames.length <= 1) {
            datasets = [{
                label: unitNames[0] || 'Scores',
                data: completed.map(function(t) { return t.pct; }),
                borderColor: MCM_CHART_COLORS.primary,
                backgroundColor: MCM_CHART_COLORS.fill,
                pointBackgroundColor: MCM_CHART_COLORS.point,
                fill: true,
                tension: 0.3
            }];
        } else {
            // Multi-series: each unit is a separate line, sparse data
            datasets = unitNames.map(function(uname, ui) {
                var data = new Array(completed.length).fill(null);
                unitMap[uname].forEach(function(item) { data[item.index] = item.pct; });
                return {
                    label: uname,
                    data: data,
                    borderColor: colors[ui % colors.length],
                    pointBackgroundColor: colors[ui % colors.length],
                    fill: false,
                    tension: 0.3,
                    spanGaps: true
                };
            });
        }

        new Chart(ctx, {
            type: 'line',
            data: { labels: allLabels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0, max: 100,
                        ticks: { callback: function(v) { return v + '%'; } },
                        grid: { color: 'var(--chart-grid)' }
                    },
                    x: { grid: { display: false }, ticks: { maxRotation: 45, font: { size: 11 } } }
                },
                plugins: {
                    legend: { display: unitNames.length > 1, position: 'top', labels: { boxWidth: 12, font: { size: 11 } } },
                    annotation: {
                        annotations: {
                            target: {
                                type: 'line', yMin: 80, yMax: 80,
                                borderColor: MCM_CHART_COLORS.target,
                                borderWidth: 1, borderDash: [6, 4],
                                label: { content: '80% target', display: true, position: 'start', font: { size: 10 }, color: MCM_CHART_COLORS.target }
                            }
                        }
                    }
                }
            }
        });
    }

    /* ========== TIME SPENT CHART ========== */
    function buildTimeChart(completed) {
        var labels = [], data = [], hasTime = false;
        for (var i = 0; i < completed.length; i++) {
            var mins = formatMinutes(completed[i].time);
            labels.push(shortName(completed[i].name));
            if (mins) { data.push(mins); hasTime = true; }
            else { data.push(0); }
        }
        if (!hasTime) {
            document.getElementById('timeChart').parentNode.parentNode.innerHTML =
                '<p style="text-align:center;color:var(--text-secondary);padding:20px;">No time data recorded yet.</p>';
            return;
        }
        var ctx = document.getElementById('timeChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Minutes',
                    data: data,
                    backgroundColor: MCM_CHART_COLORS.primary,
                    borderRadius: 4,
                    barThickness: 18
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { callback: function(v) { return v + 'm'; } },
                        grid: { color: 'var(--chart-grid)' }
                    },
                    y: { grid: { display: false }, ticks: { font: { size: 11 } } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    /* ========== STANDARDS GRID ========== */
    function buildStandards() {
        var standardScores = getStandardScores();
        var grid = document.getElementById('standardsGrid');

        // Also check mcm_scores entries for embedded standardScores
        var scores = getScores();
        var keys = Object.keys(scores);
        for (var i = 0; i < keys.length; i++) {
            var entry = scores[keys[i]];
            if (entry && entry.standardScores) {
                var skeys = Object.keys(entry.standardScores);
                for (var j = 0; j < skeys.length; j++) {
                    var sid = skeys[j], ss = entry.standardScores[sid];
                    if (!standardScores[sid]) {
                        standardScores[sid] = { name: ss.name || sid, correct: 0, total: 0 };
                    }
                    standardScores[sid].correct += (ss.correct || 0);
                    standardScores[sid].total += (ss.total || 0);
                    if (ss.name) standardScores[sid].name = ss.name;
                }
            }
        }

        var stdKeys = Object.keys(standardScores);
        if (stdKeys.length === 0) {
            grid.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:16px;grid-column:1/-1;">No standard data recorded yet.</p>';
            return;
        }

        // Sort lowest first
        stdKeys.sort(function(a, b) {
            var pa = standardScores[a].total ? (standardScores[a].correct / standardScores[a].total) : 0;
            var pb = standardScores[b].total ? (standardScores[b].correct / standardScores[b].total) : 0;
            return pa - pb;
        });

        var html = '';
        for (var k = 0; k < stdKeys.length; k++) {
            var id = stdKeys[k];
            var s = standardScores[id];
            var pct = s.total ? Math.round((s.correct / s.total) * 100) : 0;
            var tier = pct >= 90 ? 'green' : pct >= 70 ? 'blue' : pct >= 50 ? 'amber' : 'red';
            html += '<div class="std-item tier-' + tier + '">' +
                '<div class="std-head"><span class="std-name">' + (s.name || id) + '</span>' +
                '<span class="std-pct">' + pct + '%</span></div>' +
                '<div class="std-bar"><div class="std-fill" style="width:' + pct + '%"></div></div>' +
                '<div class="std-fraction">' + s.correct + '/' + s.total + ' ¬∑ ' + id + '</div></div>';
        }
        grid.innerHTML = html;
    }

    /* ========== UTILITY ========== */
    function shortName(name) {
        return name.length > 16 ? name.substring(0, 14) + '‚Ä¶' : name;
    }

    function guessUnit(key, name) {
        if (/nonlinear|unit2/i.test(key) || /nonlinear|unit\s*2/i.test(name)) return 'Nonlinear';
        if (/exponent|unit1/i.test(key) || /exponent|unit\s*1/i.test(name)) return 'Exponents';
        if (/linear|calc|index/i.test(key) || /linear|calc/i.test(name)) return 'Linear';
        if (/final/i.test(key) || /final/i.test(name)) return 'Final';
        if (/quiz/i.test(key) || /quiz/i.test(name)) return 'Quizzes';
        return 'Other';
    }

    /* ========== INIT ========== */
    window.addEventListener('DOMContentLoaded', function() {
        var scores = getScores();
        var completed = getCompletedTests(scores);

        if (completed.length === 0) {
            document.getElementById('emptyState').style.display = 'block';
            return;
        }

        document.getElementById('mainContent').style.display = 'block';
        buildLatestTest(completed);
        buildSummary(completed);
        buildTrendChart(completed);
        buildTimeChart(completed);
        buildStandards();
    });

    function importScores(input) {
        var file = input.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = JSON.parse(e.target.result);
            } catch(err) {
                document.getElementById('importStatus').textContent = '‚ùå Invalid file ‚Äî not valid JSON.';
                return;
            }

            if (!data.mcm_scores && !data.mcm_srs) {
                document.getElementById('importStatus').textContent = '‚ùå No score data found in this file.';
                return;
            }

            var imported = 0;

            // Merge mcm_scores (keep newest timestamp per test)
            if (data.mcm_scores) {
                var existing = {};
                try { existing = JSON.parse(localStorage.getItem('mcm_scores') || '{}'); } catch(e) {}

                var keys = Object.keys(data.mcm_scores);
                for (var i = 0; i < keys.length; i++) {
                    var key = keys[i];
                    var incoming = data.mcm_scores[key];
                    var current = existing[key];

                    if (!current || !current.timestamp || (incoming.timestamp && incoming.timestamp > current.timestamp)) {
                        existing[key] = incoming;
                        imported++;
                    }
                }
                localStorage.setItem('mcm_scores', JSON.stringify(existing));
            }

            // Merge standardScores (additive ‚Äî sum correct/total per standard)
            if (data.standardScores) {
                var existingStd = {};
                try { existingStd = JSON.parse(localStorage.getItem('standardScores') || '{}'); } catch(e) {}

                var skeys = Object.keys(data.standardScores);
                for (var j = 0; j < skeys.length; j++) {
                    var sid = skeys[j];
                    var inc = data.standardScores[sid];
                    if (!existingStd[sid]) {
                        existingStd[sid] = inc;
                    } else {
                        existingStd[sid].correct = (existingStd[sid].correct || 0) + (inc.correct || 0);
                        existingStd[sid].total = (existingStd[sid].total || 0) + (inc.total || 0);
                        if (inc.name) existingStd[sid].name = inc.name;
                    }
                }
                localStorage.setItem('standardScores', JSON.stringify(existingStd));
            }

            // Replace mcm_srs if incoming is newer (by session count)
            if (data.mcm_srs && data.mcm_srs.version === 1) {
                var existingSrs = null;
                try { existingSrs = JSON.parse(localStorage.getItem('mcm_srs')); } catch(e) {}

                if (!existingSrs || !existingSrs.sessions ||
                    (data.mcm_srs.sessions && data.mcm_srs.sessions.length > (existingSrs.sessions || []).length)) {
                    localStorage.setItem('mcm_srs', JSON.stringify(data.mcm_srs));
                }
            }

            var dateStr = data.exported ? new Date(data.exported).toLocaleDateString() : 'unknown date';
            document.getElementById('importStatus').textContent =
                '‚úÖ Imported ' + imported + ' test score' + (imported !== 1 ? 's' : '') + ' from ' + dateStr;

            input.value = '';

            setTimeout(function() { location.reload(); }, 1500);
        };

        reader.readAsText(file);
    }
    </script>
</body>
</html>
