<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor City Math ‚Äî Test Builder</title>
    <link rel="stylesheet" href="shared/katex/katex.min.css">
    <script defer src="shared/katex/katex.min.js"></script>
    <script defer src="shared/katex/auto-render.min.js" onload="renderMathInElement(document.body,{delimiters:[{left:'\\(',right:'\\)',display:false},{left:'\\[',right:'\\]',display:true}]});"></script>
    <link rel="stylesheet" href="shared/styles.css">
    <link rel="stylesheet" href="shared/print.css">
    <style>
        body { background: #f9fafb; }
        .builder { max-width: 900px; margin: 0 auto; padding: 20px; }
        .builder-header { text-align: center; margin-bottom: 20px; }
        .builder-header h1 { color: #002D62; margin: 0; }
        .builder-header .subtitle { color: #6C6E70; }
        .pistons-stripe {
            height: 4px;
            background: linear-gradient(90deg, #C8102E 30%, #1D42BA 50%, #C8102E 70%);
            border-radius: 2px;
            margin: 12px 0 20px;
        }

        /* Config panel */
        .config-panel {
            background: white;
            border: 2px solid #1D42BA;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        .config-panel h2 { color: #002D62; font-size: 1.1em; margin: 0 0 16px; }
        .config-row { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 16px; }
        .config-field { flex: 1; min-width: 200px; }
        .config-field label { display: block; font-weight: 600; color: #002D62; font-size: 0.85em; text-transform: uppercase; margin-bottom: 4px; }
        .config-field input, .config-field select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #BEC0C2;
            border-radius: 4px;
            font-size: 0.95rem;
        }
        .config-field input:focus, .config-field select:focus {
            border-color: #1D42BA;
            outline: none;
        }

        /* Standard picker */
        .std-picker { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
        .std-chip {
            padding: 6px 12px;
            border: 2px solid #BEC0C2;
            border-radius: 16px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
        }
        .std-chip:hover { border-color: #1D42BA; }
        .std-chip.selected { background: #1D42BA; color: white; border-color: #1D42BA; }
        .std-chip .count { font-weight: 400; color: #6C6E70; margin-left: 4px; }
        .std-chip.selected .count { color: rgba(255,255,255,0.7); }

        .build-btn {
            padding: 12px 32px;
            background: #C8102E;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            margin-top: 8px;
        }
        .build-btn:hover { background: #A00D24; }
        .config-info { font-size: 0.85em; color: #6C6E70; margin-top: 8px; }

        /* Generated test */
        .gen-test { display: none; }
        .gen-test.show { display: block; }
        .gen-header {
            background: white;
            border: 2px solid #002D62;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .gen-header h2 { color: #002D62; margin: 0; }
        .gen-header .gen-meta { color: #6C6E70; font-size: 0.9em; margin-top: 6px; }
        .gen-header .name-date {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 12px;
            font-size: 0.95em;
        }
        .gen-header .name-date span { border-bottom: 1px solid #002D62; min-width: 150px; display: inline-block; padding-bottom: 2px; }

        .gen-question {
            background: white;
            border: 1px solid #BEC0C2;
            border-left: 4px solid #1D42BA;
            border-radius: 4px;
            padding: 16px 20px;
            margin-bottom: 12px;
            page-break-inside: avoid;
        }
        .gen-question .gq-num { font-weight: 700; color: #1D42BA; font-size: 0.85em; text-transform: uppercase; }
        .gen-question .gq-std { float: right; font-size: 0.7em; color: #6C6E70; background: #f0f4ff; padding: 2px 8px; border-radius: 10px; }
        .gen-question .gq-text { margin: 8px 0; line-height: 1.6; }
        .gen-question .gq-part { margin: 6px 0 6px 16px; padding-left: 12px; border-left: 2px solid #eee; }
        .gen-question .gq-answer-line { border-bottom: 1px solid #BEC0C2; min-width: 120px; display: inline-block; margin-left: 8px; }
        .gen-question .gq-work-box {
            border: 1px solid #BEC0C2;
            border-radius: 4px;
            min-height: 60px;
            margin: 8px 0;
            padding: 8px;
            color: #BEC0C2;
            font-size: 0.85em;
        }

        /* Answer key (separate page) */
        .answer-key { display: none; page-break-before: always; }
        .answer-key.show { display: block; }
        .answer-key h2 { color: #C8102E; text-align: center; }
        .ak-item { margin: 4px 0; font-size: 0.9em; }
        .ak-item strong { color: #002D62; }

        @media print {
            .config-panel, .build-btn, .action-bar { display: none !important; }
            .gen-test { display: block !important; }
            .gen-question { border-color: #000; }
        }
        @media (max-width: 768px) {
            .config-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <a href="#main" class="sr-only">Skip to content</a>
    <div class="builder" role="main" id="main">
        <div class="print-header">
            <strong>Motor City Math ‚Äî Custom Test</strong><br>
            Name: _____________________ Date: ___________
        </div>
        <header class="builder-header">
            <h1>Motor City Math ‚Äî Test Builder</h1>
            <div class="subtitle">Build custom tests from 313 questions</div>
            <div class="pistons-stripe"></div>
        </header>

        <div class="config-panel">
            <h2>üìã Configure Your Test</h2>
            <div class="config-row">
                <div class="config-field">
                    <label for="testTitle">Test Title</label>
                    <input type="text" id="testTitle" value="Algebra 2 Practice Test" placeholder="Enter test name">
                </div>
                <div class="config-field">
                    <label for="testCount">Number of Questions</label>
                    <input type="number" id="testCount" min="1" max="50" value="15">
                </div>
            </div>
            <div class="config-row">
                <div class="config-field">
                    <label for="testUnit">Unit</label>
                    <select id="testUnit"><option value="">All units</option></select>
                </div>
                <div class="config-field">
                    <label for="testDiff">Difficulty Mix</label>
                    <select id="testDiff">
                        <option value="">Balanced (auto-mix)</option>
                        <option value="easy">Easy only</option>
                        <option value="medium">Medium only</option>
                        <option value="hard">Hard only</option>
                        <option value="ramp">Ramp up (easy ‚Üí hard)</option>
                    </select>
                </div>
            </div>

            <label style="font-weight:600; color:#002D62; font-size:0.85em; text-transform:uppercase; margin-bottom:4px; display:block;">Standards (click to select)</label>
            <div class="std-picker" id="stdPicker"></div>

            <div class="config-row" style="margin-top:12px;">
                <div class="config-field">
                    <label>
                        <input type="checkbox" id="includeWork" checked> Include work space
                    </label>
                </div>
                <div class="config-field">
                    <label>
                        <input type="checkbox" id="includeKey" checked> Generate answer key
                    </label>
                </div>
            </div>

            <button class="build-btn" onclick="buildTest()">üèóÔ∏è BUILD TEST</button>
            <div class="config-info" id="configInfo">Loading question bank...</div>
        </div>

        <div class="action-bar" id="actionBar" style="display:none; margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print Test</button>
            <button class="build-btn" style="background:#1D42BA;" onclick="buildTest()">üîÑ Regenerate</button>
            <a href="index.html" style="color:#1D42BA; font-weight:600; align-self:center;">‚Üê Dashboard</a>
        </div>

        <div class="gen-test" id="genTest"></div>
        <div class="answer-key" id="answerKey"></div>
    </div>

    <script>
    var questionBank = null;

    function loadQuestions() {
        var methods = [
            function(cb) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', 'data/questions.json', true);
                xhr.onload = function() { if (xhr.status === 200) cb(JSON.parse(xhr.responseText)); };
                xhr.onerror = function() { cb(null); };
                xhr.send();
            },
            function(cb) {
                if (typeof fetch !== 'undefined') {
                    fetch('data/questions.json').then(function(r) { return r.json(); }).then(cb).catch(function() { cb(null); });
                } else { cb(null); }
            }
        ];

        methods[0](function(data) {
            if (data) { init(data); return; }
            methods[1](function(data2) {
                if (data2) init(data2);
                else document.getElementById('configInfo').textContent = 'Error loading questions.';
            });
        });
    }

    function init(data) {
        questionBank = data.questions;
        populateConfig();
        document.getElementById('configInfo').textContent = questionBank.length + ' questions available.';
    }

    function populateConfig() {
        var units = {}, standards = {};
        questionBank.forEach(function(q) {
            units[q.unit] = (units[q.unit] || 0) + 1;
            standards[q.standard] = (standards[q.standard] || 0) + 1;
        });

        var unitSel = document.getElementById('testUnit');
        Object.keys(units).sort().forEach(function(u) {
            var opt = document.createElement('option');
            opt.value = u;
            opt.textContent = u.replace(/-/g, ' ') + ' (' + units[u] + ')';
            unitSel.appendChild(opt);
        });

        var picker = document.getElementById('stdPicker');
        Object.keys(standards).sort().forEach(function(s) {
            var chip = document.createElement('span');
            chip.className = 'std-chip';
            chip.dataset.std = s;
            chip.innerHTML = s + '<span class="count">(' + standards[s] + ')</span>';
            chip.onclick = function() { chip.classList.toggle('selected'); updateInfo(); };
            picker.appendChild(chip);
        });

        document.getElementById('testUnit').addEventListener('change', updateInfo);
        document.getElementById('testDiff').addEventListener('change', updateInfo);
        updateInfo();
    }

    function getSelectedStandards() {
        var chips = document.querySelectorAll('.std-chip.selected');
        return Array.prototype.map.call(chips, function(c) { return c.dataset.std; });
    }

    function getFilteredPool() {
        var unit = document.getElementById('testUnit').value;
        var diff = document.getElementById('testDiff').value;
        var stds = getSelectedStandards();

        return questionBank.filter(function(q) {
            if (unit && q.unit !== unit) return false;
            if (diff && diff !== 'ramp' && q.difficulty !== diff) return false;
            if (stds.length > 0 && stds.indexOf(q.standard) === -1) return false;
            return true;
        });
    }

    function updateInfo() {
        var pool = getFilteredPool();
        document.getElementById('configInfo').textContent = pool.length + ' questions match. ' +
            (pool.length === 0 ? 'Broaden your filters.' : 'Ready to build.');
    }

    function buildTest() {
        var pool = getFilteredPool();
        var count = parseInt(document.getElementById('testCount').value) || 15;
        count = Math.min(count, pool.length, 50);
        var diff = document.getElementById('testDiff').value;
        var includeWork = document.getElementById('includeWork').checked;
        var includeKey = document.getElementById('includeKey').checked;
        var title = document.getElementById('testTitle').value || 'Algebra 2 Test';

        if (pool.length === 0) {
            document.getElementById('configInfo').textContent = 'No questions match. Broaden filters.';
            return;
        }

        var selected;
        if (diff === 'ramp') {
            // Sort easy ‚Üí medium ‚Üí hard, then pick evenly
            var easy = shuffle(pool.filter(function(q) { return q.difficulty === 'easy'; }));
            var med = shuffle(pool.filter(function(q) { return q.difficulty === 'medium'; }));
            var hard = shuffle(pool.filter(function(q) { return q.difficulty === 'hard'; }));
            var third = Math.ceil(count / 3);
            selected = easy.slice(0, third).concat(med.slice(0, third)).concat(hard.slice(0, third)).slice(0, count);
        } else {
            selected = shuffle(pool).slice(0, count);
        }

        renderTest(selected, title, includeWork, includeKey);
        document.getElementById('actionBar').style.display = 'flex';
    }

    function shuffle(arr) {
        var a = arr.slice();
        for (var i = a.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var t = a[i]; a[i] = a[j]; a[j] = t;
        }
        return a;
    }

    function renderTest(questions, title, includeWork, includeKey) {
        var stds = {};
        questions.forEach(function(q) { stds[q.standard] = true; });

        var html = '<div class="gen-header">' +
            '<h2>' + escHtml(title) + '</h2>' +
            '<div class="gen-meta">' + questions.length + ' questions ¬∑ Standards: ' + Object.keys(stds).sort().join(', ') + '</div>' +
            '<div class="name-date">Name: <span></span> Date: <span></span> Period: <span></span></div>' +
            '</div>';

        questions.forEach(function(q, idx) {
            html += '<div class="gen-question">';
            html += '<span class="gq-num">Question ' + (idx + 1) + '</span>';
            html += '<span class="gq-std">' + q.standard + ' ¬∑ ' + q.difficulty + '</span>';
            html += '<div class="gq-text">' + escHtml(q.question_text) + '</div>';

            if (q.sub_parts && q.sub_parts.length > 0) {
                q.sub_parts.forEach(function(p) {
                    html += '<div class="gq-part"><strong>(' + p.label + ')</strong> ' + escHtml(p.text);
                    if (p.answer_type === 'numeric' || p.answer_type === 'exact') {
                        html += ' <span class="gq-answer-line"></span>';
                    }
                    html += '</div>';
                });
            } else {
                html += '<div class="gq-part">Answer: <span class="gq-answer-line" style="min-width:200px"></span></div>';
            }

            if (includeWork) {
                html += '<div class="gq-work-box">Show your work</div>';
            }
            html += '</div>';
        });

        document.getElementById('genTest').innerHTML = html;
        document.getElementById('genTest').className = 'gen-test show';

        // Answer key
        if (includeKey) {
            var akHtml = '<h2>Answer Key ‚Äî ' + escHtml(title) + '</h2>';
            questions.forEach(function(q, idx) {
                akHtml += '<div class="ak-item"><strong>Q' + (idx + 1) + '.</strong> ';
                if (q.sub_parts && q.sub_parts.length > 0) {
                    akHtml += q.sub_parts.map(function(p) {
                        return '(' + p.label + ') ' + (p.answer || '‚Äî');
                    }).join(' ¬∑ ');
                } else {
                    akHtml += q.answer || '‚Äî';
                }
                akHtml += ' <span style="color:#6C6E70;font-size:0.8em;">[' + q.standard + ']</span></div>';
            });
            document.getElementById('answerKey').innerHTML = akHtml;
            document.getElementById('answerKey').className = 'answer-key show';
        } else {
            document.getElementById('answerKey').className = 'answer-key';
        }

        // Re-render KaTeX
        if (window.renderMathInElement) renderMathInElement(document.getElementById('testOutput'), {delimiters:[{left:'\\(',right:'\\)',display:false},{left:'\\[',right:'\\]',display:true}]});
    }

    function escHtml(s) {
        return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    window.addEventListener('DOMContentLoaded', loadQuestions);
    </script>
</body>
</html>
