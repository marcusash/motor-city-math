<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Non-Linear Functions Test</title>
    <link rel="stylesheet" href="shared/katex/katex.min.css">
    <script defer src="shared/katex/katex.min.js"></script>
    <script defer src="shared/katex/auto-render.min.js"
        onload="renderMathInElement(document.body,{delimiters:[{left:'\\(',right:'\\)',display:false},{left:'\\[',right:'\\]',display:true}]});"></script>
    <link rel="stylesheet" href="shared/styles.css">
    <link rel="stylesheet" href="shared/print.css">
    <style>
        /* === File-specific: Interactive Graph Styles === */
        .graph-section {
            margin: 30px 0;
        }

        .graph-instructions {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 4px;
            border: 2px solid #1D42BA;
            margin-bottom: 20px;
        }

        .graph-instructions p {
            font-weight: bold;
            margin-bottom: 10px;
            color: #1D42BA;
        }

        .graph-instructions ul {
            list-style: none;
            padding: 0;
            margin: 0;
            line-height: 1.8;
            font-size: 0.9em;
        }

        .graph-instructions li {
            margin-bottom: 8px;
        }

        .canvas-wrapper {
            text-align: center;
            margin: 20px 0;
        }

        .canvas-container {
            display: inline-block;
            border: 2px solid #333;
            background: white;
            padding: 15px;
        }

        canvas {
            display: block;
            cursor: crosshair;
        }

        .graph-controls {
            text-align: center;
            margin: 15px 0;
        }

        .graph-btn {
            background: #C8102E;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.9em;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
            transition: background 0.2s;
            font-weight: 600;
        }

        .graph-btn:hover {
            background: #A00D24;
        }

        .graph-btn.secondary {
            background: #dc2626;
        }

        .graph-btn.secondary:hover {
            background: #b91c1c;
        }

        .graph-btn.asymptote {
            background: #1D42BA;
        }

        .graph-btn.asymptote:hover {
            background: #002D62;
        }

        .graph-btn.asymptote.active {
            background: #16a34a;
        }

        /* File-specific print overrides */
        @media print {
            .canvas-container {
                border: 1px solid #000 !important;
                background: white !important;
            }

            .graph-instructions {
                border: 1px solid #000 !important;
                background: white !important;
            }

            .graph-controls {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <a href="#main" class="sr-only">Skip to content</a>
    <div class="container" role="main" id="main">
        <div class="print-header">
            <strong>Non-Linear Functions Test</strong><br>
            Name: _____________________ Date: ___________
        </div>
        <header>
            <h1>Non-Linear Functions Test</h1>
            <div class="subtitle">Algebra 2</div>
        </header>

        <form id="testForm">
            <!-- Question 1: Quadratic Function -->
            <div class="question-card">
                <div class="question-number">Question 1 - Quadratic Function</div>
                <div class="question-text">
                    Given: \(f(x) = -\frac{1}{2}(x - 3)^2 - 4\)
                    <br><br>
                    a) Plot the graph of the function using the canvas below.
                    <br>b) State the domain.
                    <br>c) State the range.
                    <br>d) Identify the vertex.
                </div>
                
                <div class="graph-section">
                    <p style="font-weight: bold; margin-bottom: 10px;">Plot your points on the graph below:</p>
                    <div class="graph-instructions">
                        <p>How to Use the Graph:</p>
                        <ul>
                            <li>• <strong>Click</strong> on the canvas to plot individual points (red dots will appear)</li>
                            <li>• Click the <strong>"Connect Points"</strong> button to draw lines connecting your plotted points</li>
                            <li>• Click the <strong>"Clear All"</strong> button to erase all points and start over</li>
                            <li>• The grid shows scale numbers from -16 to 16 on both axes</li>
                            <li>• Points and lines appear in red for visibility</li>
                        </ul>
                    </div>
                    <div class="canvas-wrapper">
                        <div class="canvas-container">
                            <canvas id="chart1" width="700" height="700"></canvas>
                        </div>
                    </div>
                    <div class="graph-controls">
                        <button type="button" class="graph-btn" onclick="connectPoints('chart1')">Connect Points</button>
                        <button type="button" class="graph-btn secondary" onclick="clearPoints('chart1')">Clear All</button>
                    </div>
                </div>

                <div class="work-area">
                    <span class="work-label">Show Your Work:</span>
                    <textarea id="work1" placeholder="Show your calculations for the table values..."></textarea>
                </div>
                
                <div class="input-group">
                    <label>b) Domain:</label>
                    <input type="text" id="q1_domain">
                </div>
                <div class="input-group">
                    <label>c) Range:</label>
                    <input type="text" id="q1_range">
                </div>
                <div class="input-group">
                    <label>d) Vertex:</label>
                    <input type="text" id="q1_vertex">
                </div>
            </div>
            <div class="answer-feedback" id="feedback1"></div>

            <!-- Question 2: Square Root Function -->
            <div class="question-card">
                <div class="question-number">Question 2 - Square Root Function</div>
                <div class="question-text">
                    Given: \(f(x) = \sqrt{x + 3} - 2\)
                    <br><br>
                    a) Plot the graph of the function using the canvas below.
                    <br>b) State the domain.
                    <br>c) State the range.
                    <br>d) Identify the starting point of the graph.
                </div>
                
                <div class="graph-section">
                    <p style="font-weight: bold; margin-bottom: 10px;">Plot your points on the graph below:</p>
                    <div class="graph-instructions">
                        <p>How to Use the Graph:</p>
                        <ul>
                            <li>• <strong>Click</strong> on the canvas to plot individual points (red dots will appear)</li>
                            <li>• Click the <strong>"Connect Points"</strong> button to draw lines connecting your plotted points</li>
                            <li>• Click the <strong>"Clear All"</strong> button to erase all points and start over</li>
                            <li>• The grid shows scale numbers from -16 to 16 on both axes</li>
                            <li>• Points and lines appear in red for visibility</li>
                        </ul>
                    </div>
                    <div class="canvas-wrapper">
                        <div class="canvas-container">
                            <canvas id="chart2" width="700" height="700"></canvas>
                        </div>
                    </div>
                    <div class="graph-controls">
                        <button type="button" class="graph-btn" onclick="connectPoints('chart2')">Connect Points</button>
                        <button type="button" class="graph-btn secondary" onclick="clearPoints('chart2')">Clear All</button>
                    </div>
                </div>

                <div class="work-area">
                    <span class="work-label">Show Your Work:</span>
                    <textarea id="work2" placeholder="Show your calculations for the table values..."></textarea>
                </div>
                
                <div class="input-group">
                    <label>b) Domain:</label>
                    <input type="text" id="q2_domain">
                </div>
                <div class="input-group">
                    <label>c) Range:</label>
                    <input type="text" id="q2_range">
                </div>
                <div class="input-group">
                    <label>d) Starting point:</label>
                    <input type="text" id="q2_start">
                </div>
            </div>
            <div class="answer-feedback" id="feedback2"></div>

            <!-- Question 3: Rational Function -->
            <div class="question-card">
                <div class="question-number">Question 3 - Rational Function</div>
                <div class="question-text">
                    Given: \(f(x) = \frac{4}{x} + 3\)
                    <br><br>
                    a) Plot the graph of the function using the canvas below.
                    <br>b) Plot the vertical and horizontal asymptotes on the graph.
                    <br>c) State the domain.
                    <br>d) State the range.
                </div>
                
                <div class="graph-section">
                    <p style="font-weight: bold; margin-bottom: 10px;">Plot your points and asymptotes on the graph below:</p>
                    <div class="graph-instructions">
                        <p>How to Use the Graph:</p>
                        <ul>
                            <li>• Click <strong>"Vertical Asymptote"</strong> then click on the graph where you want to draw a vertical asymptote</li>
                            <li>• Click <strong>"Horizontal Asymptote"</strong> then click on the graph where you want to draw a horizontal asymptote</li>
                            <li>• <strong>Click</strong> on the canvas to plot individual points (red dots will appear)</li>
                            <li>• Click the <strong>"Connect Points"</strong> button - the graph will automatically create separate curves that don't cross asymptotes</li>
                            <li>• Click the <strong>"Clear All"</strong> button to erase everything and start over</li>
                            <li>• The grid shows scale numbers from -16 to 16 on both axes</li>
                            <li>• Asymptotes appear as blue dashed lines, function curves as red solid lines</li>
                        </ul>
                    </div>
                    <div class="canvas-wrapper">
                        <div class="canvas-container">
                            <canvas id="chart3" width="700" height="700"></canvas>
                        </div>
                    </div>
                    <div class="graph-controls">
                        <button type="button" class="graph-btn asymptote" onclick="setAsymptoteMode('chart3', 'vertical')">Vertical Asymptote</button>
                        <button type="button" class="graph-btn asymptote" onclick="setAsymptoteMode('chart3', 'horizontal')">Horizontal Asymptote</button>
                        <button type="button" class="graph-btn" onclick="connectPoints('chart3')">Connect Points</button>
                        <button type="button" class="graph-btn secondary" onclick="clearPoints('chart3')">Clear All</button>
                    </div>
                </div>

                <div class="work-area">
                    <span class="work-label">Show Your Work:</span>
                    <textarea id="work3" placeholder="Show your calculations for the table values and identify asymptotes..."></textarea>
                </div>
                
                <div class="input-group">
                    <label>c) Domain:</label>
                    <input type="text" id="q3_domain">
                </div>
                <div class="input-group">
                    <label>d) Range:</label>
                    <input type="text" id="q3_range">
                </div>
            </div>
            <div class="answer-feedback" id="feedback3"></div>

            <!-- Question 4: Cubic Function -->
            <div class="question-card">
                <div class="question-number">Question 4 - Cubic Function</div>
                <div class="question-text">
                    Given: \(f(x) = (x - 1)^3 + 2\)
                    <br><br>
                    a) Plot the graph of the function using the canvas below.
                    <br>b) State the domain.
                    <br>c) State the range.
                    <br>d) Identify the inflection point.
                </div>
                
                <div class="graph-section">
                    <p style="font-weight: bold; margin-bottom: 10px;">Plot your points on the graph below:</p>
                    <div class="graph-instructions">
                        <p>How to Use the Graph:</p>
                        <ul>
                            <li>• <strong>Click</strong> on the canvas to plot individual points (red dots will appear)</li>
                            <li>• Click the <strong>"Connect Points"</strong> button to draw lines connecting your plotted points</li>
                            <li>• Click the <strong>"Clear All"</strong> button to erase all points and start over</li>
                            <li>• The grid shows scale numbers from -16 to 16 on both axes</li>
                            <li>• Points and lines appear in red for visibility</li>
                        </ul>
                    </div>
                    <div class="canvas-wrapper">
                        <div class="canvas-container">
                            <canvas id="chart4" width="700" height="700"></canvas>
                        </div>
                    </div>
                    <div class="graph-controls">
                        <button type="button" class="graph-btn" onclick="connectPoints('chart4')">Connect Points</button>
                        <button type="button" class="graph-btn secondary" onclick="clearPoints('chart4')">Clear All</button>
                    </div>
                </div>

                <div class="work-area">
                    <span class="work-label">Show Your Work:</span>
                    <textarea id="work4" placeholder="Show your calculations for the table values..."></textarea>
                </div>
                
                <div class="input-group">
                    <label>b) Domain:</label>
                    <input type="text" id="q4_domain">
                </div>
                <div class="input-group">
                    <label>c) Range:</label>
                    <input type="text" id="q4_range">
                </div>
                <div class="input-group">
                    <label>d) Inflection point:</label>
                    <input type="text" id="q4_inflection">
                </div>
            </div>
            <div class="answer-feedback" id="feedback4"></div>

            <!-- Question 5: Rational Function -->
            <div class="question-card">
                <div class="question-number">Question 5 - Rational Function</div>
                <div class="question-text">
                    Given: \(f(x) = \frac{-6}{x - 3} + 1\)
                    <br><br>
                    a) Plot the graph of the function using the canvas below.
                    <br>b) Plot the vertical and horizontal asymptotes on the graph.
                    <br>c) State the domain.
                    <br>d) State the range.
                </div>
                
                <div class="graph-section">
                    <p style="font-weight: bold; margin-bottom: 10px;">Plot your points and asymptotes on the graph below:</p>
                    <div class="graph-instructions">
                        <p>How to Use the Graph:</p>
                        <ul>
                            <li>• Click <strong>"Vertical Asymptote"</strong> then click on the graph where you want to draw a vertical asymptote</li>
                            <li>• Click <strong>"Horizontal Asymptote"</strong> then click on the graph where you want to draw a horizontal asymptote</li>
                            <li>• <strong>Click</strong> on the canvas to plot individual points (red dots will appear)</li>
                            <li>• Click the <strong>"Connect Points"</strong> button - the graph will automatically create separate curves that don't cross asymptotes</li>
                            <li>• Click the <strong>"Clear All"</strong> button to erase everything and start over</li>
                            <li>• The grid shows scale numbers from -16 to 16 on both axes</li>
                            <li>• Asymptotes appear as blue dashed lines, function curves as red solid lines</li>
                        </ul>
                    </div>
                    <div class="canvas-wrapper">
                        <div class="canvas-container">
                            <canvas id="chart5" width="700" height="700"></canvas>
                        </div>
                    </div>
                    <div class="graph-controls">
                        <button type="button" class="graph-btn asymptote" onclick="setAsymptoteMode('chart5', 'vertical')">Vertical Asymptote</button>
                        <button type="button" class="graph-btn asymptote" onclick="setAsymptoteMode('chart5', 'horizontal')">Horizontal Asymptote</button>
                        <button type="button" class="graph-btn" onclick="connectPoints('chart5')">Connect Points</button>
                        <button type="button" class="graph-btn secondary" onclick="clearPoints('chart5')">Clear All</button>
                    </div>
                </div>

                <div class="work-area">
                    <span class="work-label">Show Your Work:</span>
                    <textarea id="work5" placeholder="Show your calculations for the table values and identify asymptotes..."></textarea>
                </div>
                
                <div class="input-group">
                    <label>c) Domain:</label>
                    <input type="text" id="q5_domain">
                </div>
                <div class="input-group">
                    <label>d) Range:</label>
                    <input type="text" id="q5_range">
                </div>
            </div>
            <div class="answer-feedback" id="feedback5"></div>

            <!-- Question 6: Function Identification -->
            <div class="question-card">
                <div class="question-number">Question 6 - Function Identification</div>
                <div class="question-text">
                    Study the graph shown below:
                    <br><br>
                    a) Identify what type of non-linear function is shown (quadratic, square root, rational, or cubic).
                    <br>b) State the domain from the graph.
                    <br>c) State the range from the graph.
                    <br>d) Identify any key features (vertex, asymptotes, inflection point, or starting point).
                </div>

                <div class="canvas-wrapper" style="margin: 30px 0;">
                    <div class="canvas-container">
                        <canvas id="chart6" width="700" height="700"></canvas>
                    </div>
                </div>

                <div class="work-area">
                    <span class="work-label">Show Your Work:</span>
                    <textarea id="work6" placeholder="Explain how you identified the function type and its features..."></textarea>
                </div>
                
                <div class="input-group">
                    <label>a) Function type:</label>
                    <input type="text" id="q6_type">
                </div>
                <div class="input-group">
                    <label>b) Domain:</label>
                    <input type="text" id="q6_domain">
                </div>
                <div class="input-group">
                    <label>c) Range:</label>
                    <input type="text" id="q6_range">
                </div>
                <div class="input-group">
                    <label>d) Key features:</label>
                    <input type="text" id="q6_features">
                </div>
            </div>
            <div class="answer-feedback" id="feedback6"></div>

            <!-- Question 7: Exponential Function Identification -->
            <div class="question-card">
                <div class="question-number">Question 7 - Function Identification</div>
                <div class="question-text">
                    Study the graph shown below:
                    <br><br>
                    a) Identify what type of non-linear function is shown (quadratic, square root, rational, cubic, or exponential).
                    <br>b) State the domain from the graph.
                    <br>c) State the range from the graph.
                    <br>d) If exponential, identify the horizontal asymptote and whether it represents growth or decay.
                </div>

                <div class="canvas-wrapper" style="margin: 30px 0;">
                    <div class="canvas-container">
                        <canvas id="chart7" width="700" height="700"></canvas>
                    </div>
                </div>

                <div class="work-area">
                    <span class="work-label">Show Your Work:</span>
                    <textarea id="work7" placeholder="Explain how you identified the function type and its features..."></textarea>
                </div>
                
                <div class="input-group">
                    <label>a) Function type:</label>
                    <input type="text" id="q7_type">
                </div>
                <div class="input-group">
                    <label>b) Domain:</label>
                    <input type="text" id="q7_domain">
                </div>
                <div class="input-group">
                    <label>c) Range:</label>
                    <input type="text" id="q7_range">
                </div>
                <div class="input-group">
                    <label>d) Asymptote and growth/decay:</label>
                    <input type="text" id="q7_features">
                </div>
            </div>
            <div class="answer-feedback" id="feedback7"></div>

            <button type="button" class="print-btn"onclick="printTest()">Print Version (Black & White)</button>
            <button type="button" class="submit-btn" onclick="gradeNonlinearTest()">Submit Test</button>
            <button type="button" class="answer-key-btn" onclick="showNonlinearAnswerKey()">View Answer Key</button>
            <button type="button" class="answer-key-btn" onclick="saveResults('nonlinear_test_results')" style="background: #1D42BA;">Save Results</button>
            <button type="button" class="answer-key-btn" onclick="loadResults('nonlinear_test_results')" style="background: #002D62;">Load Saved Results</button>
        </form>
        <div class="result" id="finalResult"></div>
    </div>

    <!-- Answer Key Modal -->
    <div id="answerKeyModal" class="answer-key-modal">
        <div class="answer-key-content">
            <button class="close-modal" onclick="closeAnswerKey()">×</button>
            <h2 class="answer-key-title">Answer Key</h2>
            <div id="answerKeyBody"></div>
        </div>
    </div>

    <script src="shared/scripts.js"></script>
    <script src="shared/chart-theme.js"></script>
    <script>
        // Store graph data for each canvas
        const graphData = {};

        // Initialize all interactive graph canvases
        function initGraph(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const marginLeft = 40;
            const marginRight = 20;
            const marginTop = 20;
            const marginBottom = 35;
            const plotWidth = width - marginLeft - marginRight;
            const plotHeight = height - marginTop - marginBottom;
            
            // Store data for this graph
            graphData[canvasId] = {
                canvas: canvas,
                ctx: ctx,
                points: [],
                linesDrawn: false,
                asymptotes: { vertical: [], horizontal: [] },
                asymptoteMode: null, // 'vertical', 'horizontal', or null
                width: width,
                height: height,
                marginLeft: marginLeft,
                marginRight: marginRight,
                marginTop: marginTop,
                marginBottom: marginBottom,
                plotWidth: plotWidth,
                plotHeight: plotHeight
            };
            
            function drawGrid() {
                ctx.clearRect(0, 0, width, height);
                
                // Draw grid (32x32 for x: -16 to 16, y: -16 to 16)
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                
                // Vertical lines
                for (let i = 0; i <= 32; i++) {
                    const x = marginLeft + (i * plotWidth) / 32;
                    ctx.beginPath();
                    ctx.moveTo(x, marginTop);
                    ctx.lineTo(x, marginTop + plotHeight);
                    ctx.stroke();
                }
                
                // Horizontal lines
                for (let i = 0; i <= 32; i++) {
                    const y = marginTop + (i * plotHeight) / 32;
                    ctx.beginPath();
                    ctx.moveTo(marginLeft, y);
                    ctx.lineTo(marginLeft + plotWidth, y);
                    ctx.stroke();
                }
                
                // Draw axes (darker)
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                
                // X-axis (at y=0, which is middle of plot)
                const xAxisY = marginTop + plotHeight / 2;
                ctx.beginPath();
                ctx.moveTo(marginLeft, xAxisY);
                ctx.lineTo(marginLeft + plotWidth, xAxisY);
                ctx.stroke();
                
                // Y-axis (at x=0, which is middle of plot)
                const yAxisX = marginLeft + plotWidth / 2;
                ctx.beginPath();
                ctx.moveTo(yAxisX, marginTop);
                ctx.lineTo(yAxisX, marginTop + plotHeight);
                ctx.stroke();
                
                // Label axes
                ctx.fillStyle = '#000';
                ctx.font = '16px Arial';
                ctx.fillText('x', width - 25, xAxisY - 10);
                ctx.fillText('y', yAxisX + 10, marginTop + 5);
                ctx.fillText('0', yAxisX + 5, xAxisY + 18);
                
                // Draw scale numbers
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                
                // X-axis numbers (-16 to 16)
                for (let i = -16; i <= 16; i++) {
                    if (i !== 0 && i !== -1) {
                        const x = marginLeft + plotWidth / 2 + (i * plotWidth / 32);
                        ctx.fillText(i, x, xAxisY + 25);
                    }
                }
                
                // Y-axis numbers (-16 to 16)
                ctx.textAlign = 'right';
                for (let i = -16; i <= 16; i++) {
                    if (i !== 0) {
                        const y = marginTop + plotHeight / 2 - (i * plotHeight / 32);
                        ctx.fillText(i, yAxisX - 8, y + 4);
                    }
                }
                
                ctx.textAlign = 'left';
            }
            
            canvas.addEventListener('click', function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const data = graphData[canvasId];
                
                if (data.asymptoteMode === 'vertical') {
                    // Add vertical asymptote at the clicked x position
                    data.asymptotes.vertical.push(x);
                    data.asymptoteMode = null;
                    redrawGraph(canvasId);
                } else if (data.asymptoteMode === 'horizontal') {
                    // Add horizontal asymptote at the clicked y position
                    data.asymptotes.horizontal.push(y);
                    data.asymptoteMode = null;
                    redrawGraph(canvasId);
                } else {
                    // Check if clicking near an existing point to remove it
                    const clickRadius = 8; // pixels
                    let pointRemoved = false;
                    
                    for (let i = data.points.length - 1; i >= 0; i--) {
                        const point = data.points[i];
                        const distance = Math.sqrt(Math.pow(point.x - x, 2) + Math.pow(point.y - y, 2));
                        
                        if (distance <= clickRadius) {
                            // Remove this point
                            data.points.splice(i, 1);
                            pointRemoved = true;
                            break;
                        }
                    }
                    
                    // If no point was removed, add a new point
                    if (!pointRemoved) {
                        data.points.push({x, y});
                    }
                    
                    redrawGraph(canvasId);
                }
            });
            
            drawGrid();
        }

        // Redraw graph with current points (and lines if connected)
        function redrawGraph(canvasId) {
            const data = graphData[canvasId];
            if (!data) return;
            
            const ctx = data.ctx;
            
            // Clear and redraw grid
            ctx.clearRect(0, 0, data.width, data.height);
            
            // Draw grid
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 32; i++) {
                const x = data.marginLeft + (i * data.plotWidth) / 32;
                ctx.beginPath();
                ctx.moveTo(x, data.marginTop);
                ctx.lineTo(x, data.marginTop + data.plotHeight);
                ctx.stroke();
            }
            
            for (let i = 0; i <= 32; i++) {
                const y = data.marginTop + (i * data.plotHeight) / 32;
                ctx.beginPath();
                ctx.moveTo(data.marginLeft, y);
                ctx.lineTo(data.marginLeft + data.plotWidth, y);
                ctx.stroke();
            }
            
            // Draw axes
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            
            const xAxisY = data.marginTop + data.plotHeight / 2;
            ctx.beginPath();
            ctx.moveTo(data.marginLeft, xAxisY);
            ctx.lineTo(data.marginLeft + data.plotWidth, xAxisY);
            ctx.stroke();
            
            const yAxisX = data.marginLeft + data.plotWidth / 2;
            ctx.beginPath();
            ctx.moveTo(yAxisX, data.marginTop);
            ctx.lineTo(yAxisX, data.marginTop + data.plotHeight);
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#000';
            ctx.font = '16px Arial';
            ctx.fillText('x', data.width - 25, xAxisY - 10);
            ctx.fillText('y', yAxisX + 10, data.marginTop + 5);
            ctx.fillText('0', yAxisX + 5, xAxisY + 18);
            
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            for (let i = -16; i <= 16; i++) {
                if (i !== 0 && i !== -1) {
                    const x = data.marginLeft + data.plotWidth / 2 + (i * data.plotWidth / 32);
                    ctx.fillText(i, x, xAxisY + 25);
                }
            }
            
            ctx.textAlign = 'right';
            for (let i = -16; i <= 16; i++) {
                if (i !== 0) {
                    const y = data.marginTop + data.plotHeight / 2 - (i * data.plotHeight / 32);
                    ctx.fillText(i, yAxisX - 8, y + 4);
                }
            }
            
            ctx.textAlign = 'left';
            
            // Draw asymptotes
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 5]);
            
            // Draw vertical asymptotes
            data.asymptotes.vertical.forEach(x => {
                ctx.beginPath();
                ctx.moveTo(x, data.marginTop);
                ctx.lineTo(x, data.marginTop + data.plotHeight);
                ctx.stroke();
            });
            
            // Draw horizontal asymptotes
            data.asymptotes.horizontal.forEach(y => {
                ctx.beginPath();
                ctx.moveTo(data.marginLeft, y);
                ctx.lineTo(data.marginLeft + data.plotWidth, y);
                ctx.stroke();
            });
            
            ctx.setLineDash([]); // Reset to solid line
            
            // Draw lines if connected
            if (data.linesDrawn && data.points.length > 0) {
                ctx.strokeStyle = '#e74c3c';
                ctx.lineWidth = 2;
                
                // If less than 3 points, just connect them
                if (data.points.length < 3) {
                    const sortedPoints = [...data.points].sort((a, b) => a.x - b.x);
                    if (sortedPoints.length === 2) {
                        ctx.beginPath();
                        ctx.moveTo(sortedPoints[0].x, sortedPoints[0].y);
                        ctx.lineTo(sortedPoints[1].x, sortedPoints[1].y);
                        ctx.stroke();
                    }
                } else {
                    // 3+ points: extrapolate the function
                    // Convert screen coordinates to graph coordinates for fitting
                    const graphPoints = data.points.map(p => ({
                        x: ((p.x - data.marginLeft) / data.plotWidth) * 32 - 16,
                        y: -(((p.y - data.marginTop) / data.plotHeight) * 32 - 16)
                    }));
                    
                    // Get asymptote values in graph coordinates
                    const asymptoteXValues = data.asymptotes.vertical.map(screenX => 
                        ((screenX - data.marginLeft) / data.plotWidth) * 32 - 16
                    );
                    const asymptoteYValues = data.asymptotes.horizontal.map(screenY => 
                        -(((screenY - data.marginTop) / data.plotHeight) * 32 - 16)
                    );
                    
                    // Determine function type and fit accordingly
                    let evaluateFunc = null;
                    
                    if (asymptoteXValues.length > 0) {
                        // Rational function: y = k/(x - a) + b
                        const verticalAsym = asymptoteXValues[0];
                        const horizontalAsym = asymptoteYValues.length > 0 ? asymptoteYValues[0] : 0;
                        
                        // Find k using least squares with the points
                        let sumK = 0;
                        let count = 0;
                        for (const pt of graphPoints) {
                            if (Math.abs(pt.x - verticalAsym) > 0.5) {
                                const k = (pt.y - horizontalAsym) * (pt.x - verticalAsym);
                                sumK += k;
                                count++;
                            }
                        }
                        const kValue = count > 0 ? sumK / count : 1;
                        
                        evaluateFunc = (x) => kValue / (x - verticalAsym) + horizontalAsym;
                    } else {
                        // Check if it might be a square root or exponential based on point pattern
                        const sortedByX = [...graphPoints].sort((a, b) => a.x - b.x);
                        const xRange = sortedByX[sortedByX.length - 1].x - sortedByX[0].x;
                        const yRange = Math.max(...graphPoints.map(p => p.y)) - Math.min(...graphPoints.map(p => p.y));
                        
                        // Check for square root pattern (starts at a point and curves gently)
                        const isSquareRoot = sortedByX.length >= 3 && sortedByX[0].x >= -16;
                        
                        if (isSquareRoot) {
                            // Try to fit square root: y = a*sqrt(x - h) + k
                            const minX = Math.min(...graphPoints.map(p => p.x));
                            const minXPoint = graphPoints.find(p => Math.abs(p.x - minX) < 0.5);
                            
                            if (minXPoint) {
                                const h = minX;
                                const k = minXPoint.y;
                                
                                // Find 'a' using another point
                                let sumA = 0;
                                let countA = 0;
                                for (const pt of graphPoints) {
                                    if (pt.x > h + 0.1) {
                                        const a = (pt.y - k) / Math.sqrt(pt.x - h);
                                        sumA += a;
                                        countA++;
                                    }
                                }
                                const aValue = countA > 0 ? sumA / countA : 1;
                                
                                evaluateFunc = (x) => {
                                    if (x < h) return null;
                                    return aValue * Math.sqrt(x - h) + k;
                                };
                            }
                        }
                        
                        // If not square root, use polynomial
                        if (!evaluateFunc) {
                            const degree = Math.min(graphPoints.length - 1, 3);
                            const coefficients = polynomialRegression(graphPoints, degree);
                            if (coefficients) {
                                evaluateFunc = (x) => evaluatePolynomial(coefficients, x);
                            }
                        }
                    }
                    
                    if (evaluateFunc) {
                        // Create segments based on vertical asymptotes
                        let segments = [];
                        if (asymptoteXValues.length === 0) {
                            segments.push({ start: -16, end: 16 });
                        } else {
                            const sortedAsymptotes = [...asymptoteXValues].sort((a, b) => a - b);
                            segments.push({ start: -16, end: sortedAsymptotes[0] - 0.1 });
                            for (let i = 1; i < sortedAsymptotes.length; i++) {
                                segments.push({ start: sortedAsymptotes[i-1] + 0.1, end: sortedAsymptotes[i] - 0.1 });
                            }
                            segments.push({ start: sortedAsymptotes[sortedAsymptotes.length - 1] + 0.1, end: 16 });
                        }
                        
                        // Draw each segment
                        segments.forEach(segment => {
                            ctx.beginPath();
                            let started = false;
                            
                            for (let graphX = segment.start; graphX <= segment.end; graphX += 0.05) {
                                const graphY = evaluateFunc(graphX);
                                
                                if (graphY !== null && Math.abs(graphY) < 100 && graphY >= -16 && graphY <= 16) {
                                    const screenX = data.marginLeft + data.plotWidth / 2 + (graphX * data.plotWidth / 32);
                                    const screenY = data.marginTop + data.plotHeight / 2 - (graphY * data.plotHeight / 32);
                                    
                                    if (!started) {
                                        ctx.moveTo(screenX, screenY);
                                        started = true;
                                    } else {
                                        ctx.lineTo(screenX, screenY);
                                    }
                                }
                            }
                            
                            ctx.stroke();
                        });
                    }
                }
            }
            
            // Draw points
            ctx.fillStyle = '#e74c3c';
            data.points.forEach(point => {
                ctx.beginPath();
                ctx.arc(point.x, point.y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
        }
        
        // Polynomial regression using least squares
        function polynomialRegression(points, degree) {
            const n = points.length;
            if (n < degree + 1) return null;
            
            // Create matrices for least squares
            const X = [];
            const y = [];
            
            for (let i = 0; i < n; i++) {
                const row = [];
                for (let j = 0; j <= degree; j++) {
                    row.push(Math.pow(points[i].x, j));
                }
                X.push(row);
                y.push([points[i].y]);
            }
            
            // Solve using normal equations: (X^T * X) * coeffs = X^T * y
            const XT = transpose(X);
            const XTX = multiply(XT, X);
            const XTy = multiply(XT, y);
            
            const coeffs = solveLinearSystem(XTX, XTy);
            return coeffs ? coeffs.map(c => c[0]) : null;
        }
        
        // Evaluate polynomial at x
        function evaluatePolynomial(coefficients, x) {
            let result = 0;
            for (let i = 0; i < coefficients.length; i++) {
                result += coefficients[i] * Math.pow(x, i);
            }
            return result;
        }
        
        // Matrix operations
        function transpose(matrix) {
            return matrix[0].map((_, i) => matrix.map(row => row[i]));
        }
        
        function multiply(A, B) {
            const result = [];
            for (let i = 0; i < A.length; i++) {
                result[i] = [];
                for (let j = 0; j < B[0].length; j++) {
                    let sum = 0;
                    for (let k = 0; k < A[0].length; k++) {
                        sum += A[i][k] * B[k][j];
                    }
                    result[i][j] = sum;
                }
            }
            return result;
        }
        
        function solveLinearSystem(A, b) {
            const n = A.length;
            const augmented = A.map((row, i) => [...row, b[i][0]]);
            
            // Gaussian elimination with partial pivoting
            for (let i = 0; i < n; i++) {
                // Find pivot
                let maxRow = i;
                for (let k = i + 1; k < n; k++) {
                    if (Math.abs(augmented[k][i]) > Math.abs(augmented[maxRow][i])) {
                        maxRow = k;
                    }
                }
                
                // Swap rows
                [augmented[i], augmented[maxRow]] = [augmented[maxRow], augmented[i]];
                
                // Check for singular matrix
                if (Math.abs(augmented[i][i]) < 1e-10) continue;
                
                // Eliminate column
                for (let k = i + 1; k < n; k++) {
                    const factor = augmented[k][i] / augmented[i][i];
                    for (let j = i; j <= n; j++) {
                        augmented[k][j] -= factor * augmented[i][j];
                    }
                }
            }
            
            // Back substitution
            const x = new Array(n).fill(0);
            for (let i = n - 1; i >= 0; i--) {
                if (Math.abs(augmented[i][i]) < 1e-10) continue;
                x[i] = augmented[i][n];
                for (let j = i + 1; j < n; j++) {
                    x[i] -= augmented[i][j] * x[j];
                }
                x[i] /= augmented[i][i];
            }
            
            return x.map(val => [val]);
        }

        // Connect all plotted points with lines
        function connectPoints(canvasId) {
            const data = graphData[canvasId];
            if (!data) return;
            
            data.linesDrawn = true;
            redrawGraph(canvasId);
        }

        // Clear all points and lines
        function clearPoints(canvasId) {
            const data = graphData[canvasId];
            if (!data) return;
            
            data.points = [];
            data.linesDrawn = false;
            data.asymptotes = { vertical: [], horizontal: [] };
            data.asymptoteMode = null;
            redrawGraph(canvasId);
        }

        // Set asymptote drawing mode
        function setAsymptoteMode(canvasId, mode) {
            const data = graphData[canvasId];
            if (!data) return;
            
            // Toggle mode: if already in this mode, turn it off; otherwise set it
            if (data.asymptoteMode === mode) {
                data.asymptoteMode = null;
            } else {
                data.asymptoteMode = mode;
            }
            
            // Update button appearance
            const chartNum = canvasId.replace('chart', '');
            const buttons = document.querySelectorAll(`#${canvasId}`).item(0)?.parentElement?.parentElement?.querySelectorAll('.graph-btn.asymptote');
            if (buttons) {
                buttons.forEach(btn => {
                    btn.classList.remove('active');
                });
                if (data.asymptoteMode) {
                    const activeBtn = mode === 'vertical' ? buttons[0] : buttons[1];
                    if (activeBtn) activeBtn.classList.add('active');
                }
            }
        }

        // Initialize Question 6 with a pre-drawn graph
        function initQuestion6Graph() {
            const canvas = document.getElementById('chart6');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const marginLeft = 40;
            const marginRight = 20;
            const marginTop = 20;
            const marginBottom = 35;
            const plotWidth = width - marginLeft - marginRight;
            const plotHeight = height - marginTop - marginBottom;
            
            function drawGrid() {
                ctx.clearRect(0, 0, width, height);
                
                // Draw grid
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                
                for (let i = 0; i <= 32; i++) {
                    const x = marginLeft + (i * plotWidth) / 32;
                    ctx.beginPath();
                    ctx.moveTo(x, marginTop);
                    ctx.lineTo(x, marginTop + plotHeight);
                    ctx.stroke();
                }
                
                for (let i = 0; i <= 32; i++) {
                    const y = marginTop + (i * plotHeight) / 32;
                    ctx.beginPath();
                    ctx.moveTo(marginLeft, y);
                    ctx.lineTo(marginLeft + plotWidth, y);
                    ctx.stroke();
                }
                
                // Draw axes
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                
                const xAxisY = marginTop + plotHeight / 2;
                ctx.beginPath();
                ctx.moveTo(marginLeft, xAxisY);
                ctx.lineTo(marginLeft + plotWidth, xAxisY);
                ctx.stroke();
                
                const yAxisX = marginLeft + plotWidth / 2;
                ctx.beginPath();
                ctx.moveTo(yAxisX, marginTop);
                ctx.lineTo(yAxisX, marginTop + plotHeight);
                ctx.stroke();
                
                // Labels
                ctx.fillStyle = '#000';
                ctx.font = '16px Arial';
                ctx.fillText('x', width - 25, xAxisY - 10);
                ctx.fillText('y', yAxisX + 10, marginTop + 5);
                ctx.fillText('0', yAxisX + 5, xAxisY + 18);
                
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                
                for (let i = -16; i <= 16; i++) {
                    if (i !== 0 && i !== -1) {
                        const x = marginLeft + plotWidth / 2 + (i * plotWidth / 32);
                        ctx.fillText(i, x, xAxisY + 25);
                    }
                }
                
                ctx.textAlign = 'right';
                for (let i = -16; i <= 16; i++) {
                    if (i !== 0) {
                        const y = marginTop + plotHeight / 2 - (i * plotHeight / 32);
                        ctx.fillText(i, yAxisX - 8, y + 4);
                    }
                }
                
                ctx.textAlign = 'left';
            }
            
            // Draw a square root function: f(x) = 2√(x + 2) - 3
            function drawFunction() {
                ctx.strokeStyle = '#2563eb';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                let started = false;
                for (let screenX = marginLeft; screenX <= marginLeft + plotWidth; screenX += 1) {
                    // Convert screen coordinates to graph coordinates
                    const graphX = ((screenX - marginLeft) / plotWidth) * 32 - 16;
                    
                    // Calculate function value: f(x) = 2√(x + 2) - 3
                    if (graphX >= -2) {
                        const graphY = 2 * Math.sqrt(graphX + 2) - 3;
                        
                        // Convert back to screen coordinates
                        const screenY = marginTop + plotHeight / 2 - (graphY * plotHeight / 32);
                        
                        if (!started) {
                            ctx.moveTo(screenX, screenY);
                            started = true;
                        } else {
                            ctx.lineTo(screenX, screenY);
                        }
                    }
                }
                
                ctx.stroke();
            }
            
            drawGrid();
            drawFunction();
        }

        // Initialize Question 7 with a pre-drawn exponential graph
        function initQuestion7Graph() {
            const canvas = document.getElementById('chart7');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const marginLeft = 40;
            const marginRight = 20;
            const marginTop = 20;
            const marginBottom = 35;
            const plotWidth = width - marginLeft - marginRight;
            const plotHeight = height - marginTop - marginBottom;
            
            function drawGrid() {
                ctx.clearRect(0, 0, width, height);
                
                // Draw grid
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                
                for (let i = 0; i <= 32; i++) {
                    const x = marginLeft + (i * plotWidth) / 32;
                    ctx.beginPath();
                    ctx.moveTo(x, marginTop);
                    ctx.lineTo(x, marginTop + plotHeight);
                    ctx.stroke();
                }
                
                for (let i = 0; i <= 32; i++) {
                    const y = marginTop + (i * plotHeight) / 32;
                    ctx.beginPath();
                    ctx.moveTo(marginLeft, y);
                    ctx.lineTo(marginLeft + plotWidth, y);
                    ctx.stroke();
                }
                
                // Draw axes
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                
                const xAxisY = marginTop + plotHeight / 2;
                ctx.beginPath();
                ctx.moveTo(marginLeft, xAxisY);
                ctx.lineTo(marginLeft + plotWidth, xAxisY);
                ctx.stroke();
                
                const yAxisX = marginLeft + plotWidth / 2;
                ctx.beginPath();
                ctx.moveTo(yAxisX, marginTop);
                ctx.lineTo(yAxisX, marginTop + plotHeight);
                ctx.stroke();
                
                // Labels
                ctx.fillStyle = '#000';
                ctx.font = '16px Arial';
                ctx.fillText('x', width - 25, xAxisY - 10);
                ctx.fillText('y', yAxisX + 10, marginTop + 5);
                ctx.fillText('0', yAxisX + 5, xAxisY + 18);
                
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                
                for (let i = -16; i <= 16; i++) {
                    if (i !== 0 && i !== -1) {
                        const x = marginLeft + plotWidth / 2 + (i * plotWidth / 32);
                        ctx.fillText(i, x, xAxisY + 25);
                    }
                }
                
                ctx.textAlign = 'right';
                for (let i = -16; i <= 16; i++) {
                    if (i !== 0) {
                        const y = marginTop + plotHeight / 2 - (i * plotHeight / 32);
                        ctx.fillText(i, yAxisX - 8, y + 4);
                    }
                }
                
                ctx.textAlign = 'left';
            }
            
            // Draw an exponential function: f(x) = -2^x
            function drawFunction() {
                ctx.strokeStyle = '#2563eb';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                let started = false;
                for (let screenX = marginLeft; screenX <= marginLeft + plotWidth; screenX += 1) {
                    // Convert screen coordinates to graph coordinates
                    const graphX = ((screenX - marginLeft) / plotWidth) * 32 - 16;
                    
                    // Calculate function value: f(x) = -2^x
                    const graphY = -Math.pow(2, graphX);
                    
                    // Only draw if y is within reasonable bounds
                    if (graphY >= -16 && graphY <= 16) {
                        // Convert back to screen coordinates
                        const screenY = marginTop + plotHeight / 2 - (graphY * plotHeight / 32);
                        
                        if (!started) {
                            ctx.moveTo(screenX, screenY);
                            started = true;
                        } else {
                            ctx.lineTo(screenX, screenY);
                        }
                    }
                }
                
                ctx.stroke();
            }
            
            drawGrid();
            drawFunction();
        }

        // Initialize all graphs when page loads
        window.addEventListener('load', function() {
            initGraph('chart1');
            initGraph('chart2');
            initGraph('chart3');
            initGraph('chart4');
            initGraph('chart5');
            initQuestion6Graph();
            initQuestion7Graph();
        });

        function showNonlinearAnswerKey() {
            const answerKeyHTML = `
                <div class="answer-item"><strong>Q1 - Quadratic Function \(f(x) = -\frac{1}{2}(x - 3)^2 - 4\):</strong><br>
                b) Domain: All real numbers or \((-\infty, \infty)\)<br>
                c) Range: \(y \leq -4\) or \((-\infty, -4]\)<br>
                d) Vertex: \((3, -4)\)</div>
                
                <div class="answer-item"><strong>Q2 - Square Root Function \(f(x) = \sqrt{x + 3} - 2\):</strong><br>
                b) Domain: \(x \geq -3\) or \([-3, \infty)\)<br>
                c) Range: \(y \geq -2\) or \([-2, \infty)\)<br>
                d) Starting point: \((-3, -2)\)</div>
                
                <div class="answer-item"><strong>Q3 - Rational Function \(f(x) = \frac{4}{x} + 3\):</strong><br>
                Vertical asymptote: \(x = 0\), Horizontal asymptote: \(y = 3\)<br>
                c) Domain: All real numbers except \(x = 0\), or \((-\infty, 0) \cup (0, \infty)\)<br>
                d) Range: All real numbers except \(y = 3\), or \((-\infty, 3) \cup (3, \infty)\)</div>
                
                <div class="answer-item"><strong>Q4 - Cubic Function \(f(x) = (x - 1)^3 + 2\):</strong><br>
                b) Domain: All real numbers or \((-\infty, \infty)\)<br>
                c) Range: All real numbers or \((-\infty, \infty)\)<br>
                d) Inflection point: \((1, 2)\)</div>
                
                <div class="answer-item"><strong>Q5 - Rational Function \(f(x) = \frac{-6}{x - 3} + 1\):</strong><br>
                Vertical asymptote: \(x = 3\), Horizontal asymptote: \(y = 1\)<br>
                c) Domain: All real numbers except \(x = 3\), or \((-\infty, 3) \cup (3, \infty)\)<br>
                d) Range: All real numbers except \(y = 1\), or \((-\infty, 1) \cup (1, \infty)\)</div>
                
                <div class="answer-item"><strong>Q6 - Function Identification:</strong><br>
                a) Square root function<br>
                b) Domain: \(x \geq -2\) or \([-2, \infty)\)<br>
                c) Range: \(y \geq -3\) or \([-3, \infty)\)<br>
                d) Starting point: \((-2, -3)\). The function is \(f(x) = 2\sqrt{x + 2} - 3\)</div>
                
                <div class="answer-item"><strong>Q7 - Function Identification:</strong><br>
                a) Exponential function<br>
                b) Domain: All real numbers or \((-\infty, \infty)\)<br>
                c) Range: \(y < 0\) or \((-\infty, 0)\)<br>
                d) Horizontal asymptote: \(y = 0\), represents exponential growth (reflected over x-axis). The function is \(f(x) = -2^x\)</div>
            `;
            showAnswerKey(answerKeyHTML, function() {
                if (window.renderMathInElement) {
                    renderMathInElement(document.getElementById('answerKeyBody'), {
                        delimiters: [{left: '\\(', right: '\\)', display: false}, {left: '\\[', right: '\\]', display: true}]
                    });
                }
            });
        }

        function gradeNonlinearTest() {
            gradeTest({
                questions: [
                    [[['q1_vertex', '(3, -4)']], 'feedback1'],
                    [[['q2_start', '(-3, -2)']], 'feedback2'],
                    [[['q4_inflection', '(1, 2)']], 'feedback4'],
                    [[['q6_type', 'Square root function']], 'feedback6'],
                    [[['q7_type', 'Exponential function']], 'feedback7']
                ],
                standards: [
                    {id: '6.a', name: 'Quadratic functions'},
                    {id: '6.b', name: 'Square root functions'},
                    {id: '6.d', name: 'Cubic functions'},
                    {id: '6.e', name: 'Function identification'},
                    {id: '6.e', name: 'Function identification'}
                ],
                feedbacks: [
                    ['✓ Vertex (3, -4) — nailed it!', '✗ Read h, k from vertex form directly'],
                    ['✓ Starting point (-3, -2) — correct!', '✗ Set radicand to zero: x+3=0 → x=-3'],
                    ['✓ Inflection point (1, 2) — sharp!', '✗ Shift center: (x−1)³+2 gives (1, 2)'],
                    ['✓ Square root — nice eye!', '✗ Curve starts at a point, rises gradually'],
                    ['✓ Exponential — you got it!', '✗ Curve approaches asymptote, never touches it']
                ],
                storageKey: 'nonlinear_test'
            });
        }
    </script>

    <nav class="test-nav" role="navigation" aria-label="Page navigation" style="text-align:center; padding:20px 0; font-size:0.95em;">
        <a href="index.html" style="color:var(--accent-blue); font-weight:600; margin-right:16px;">← Dashboard</a>
        <a href="parent.html" style="color:var(--accent-navy); font-weight:600;">📊 Parent View</a>
    </nav></body>
</html>